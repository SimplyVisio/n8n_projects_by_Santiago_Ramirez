{
  "name": "obtener flow de WA",
  "nodes": [
    {
      "parameters": {
        "content": "## üì± Data Processor (WhatsApp Flows)\\n\\nThis workflow acts as the backend handler for WhatsApp Flows (Meta's interactive multi-step forms). It specializes in parsing structured JSON payloads sent from the WhatsApp client and synchronizing them into the CRM.\\n\\n### Key Features:\\n1. **Interactive Form Parsing**: Decodes the `response_json` from Meta's `nfm_reply` interactive message type, extracting detailed fields like customer name, company, urgency, and specific complaints.\\n2. **Context-Aware Upsert**: Uses a sophisticated If/Else logic to determine whether to create a new record in the `reportes_quejas` table or update an existing one, maintaining a single point of truth for each customer issue.\\n3. **Advanced Normalization**: Includes a dedicated JavaScript block for phone number normalization (Mexican +52 format) to ensure consistent lookups across the database.\\n4. **Supabase Integration**: Direct integration with Supabase for real-time CRM updates, enabling immediate follow-up by human agents.\\n5. **Metadata Mapping**: Captures qualitative data like the lead's \"emocion_cliente\" (customer emotion) which is later used to prioritize high-urgency/high-priority tickets.",
        "height": 450,
        "width": 320,
        "color": 1
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        200,
        -100
      ],
      "typeVersion": 1,
      "id": "doc-wa-flows-processor",
      "name": "Architecture Documentation"
    },
    {
      "parameters": {
        "jsCode": "// Obtener el JSON desde el nodo Webhook\nlet responseJsonString = $('Webhook flows').first().json.body.entry[0].changes[0].value.messages[0].interactive.nfm_reply.response_json;\n\n// Parsear el JSON string a objeto\nlet parsedData = {};\n\ntry {\n    parsedData = JSON.parse(responseJsonString);\n} catch (error) {\n    // Si hay error al parsear, retornar campos vac√≠os\n    parsedData = {\n        cliente_nombre: '',\n        empresa: '',\n        servicio_afectado: '',\n        tipo_queja: '',\n        nivel_urgencia: '',\n        resumen_detallado: '',\n        emocion_cliente: '',\n        flow_token: ''\n    };\n}\n\n// Retornar cada campo como una propiedad individual\nreturn [{\n    json: {\n        ...$input.first().json,  // Mantiene todos los datos originales del nodo anterior\n        cliente_nombre: parsedData.cliente_nombre || '',\n        empresa: parsedData.empresa || '',\n        servicio_afectado: parsedData.servicio_afectado || '',\n        tipo_queja: parsedData.tipo_queja || '',\n        nivel_urgencia: parsedData.nivel_urgencia || '',\n        resumen_detallado: parsedData.resumen_detallado || '',\n        emocion_cliente: parsedData.emocion_cliente || '',\n        flow_token: parsedData.flow_token || '',\n        response_json_parsed: parsedData  // Tambi√©n incluye el objeto completo por si acaso\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1232,
        -144
      ],
      "id": "948bb4d0-3b08-4fc1-8c1e-6e81e1c96aab",
      "name": "convertir datos de json flow WA",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Funci√≥n para normalizar n√∫meros de tel√©fono mexicanos en n8n\n// Usar en un nodo \"Code\" o \"Function\"\nfunction normalizePhone(phoneNumber) {\n    // Si el n√∫mero es null, undefined o vac√≠o, retornarlo tal como est√°\n    if (!phoneNumber || phoneNumber === '') {\n        return phoneNumber;\n    }\n    \n    // Convertir a string y limpiar: quitar espacios, guiones, par√©ntesis, etc.\n    let cleanPhone = phoneNumber.toString().replace(/[^0-9+]/g, '');\n    \n    // Casos para n√∫meros mexicanos (+52)\n    \n    // Patr√≥n: +521XXXXXXXXXX -> +52XXXXXXXXXX (remover el 1 despu√©s de +52)\n    if (/^\\+521[0-9]{10}$/.test(cleanPhone)) {\n        return '+52' + cleanPhone.substring(4);\n    }\n    \n    // Patr√≥n: 521XXXXXXXXXX -> +52XXXXXXXXXX (sin +, con 1)\n    if (/^521[0-9]{10}$/.test(cleanPhone)) {\n        return '+52' + cleanPhone.substring(3);\n    }\n    \n    // Patr√≥n: +52XXXXXXXXXX -> ya est√° correcto\n    if (/^\\+52[0-9]{10}$/.test(cleanPhone)) {\n        return cleanPhone;\n    }\n    \n    // Patr√≥n: 52XXXXXXXXXX -> +52XXXXXXXXXX (agregar +)\n    if (/^52[0-9]{10}$/.test(cleanPhone)) {\n        return '+' + cleanPhone;\n    }\n    \n    // Patr√≥n: 1XXXXXXXXXX (11 d√≠gitos empezando con 1) -> +52XXXXXXXXXX\n    if (/^1[0-9]{10}$/.test(cleanPhone)) {\n        return '+52' + cleanPhone.substring(1);\n    }\n    \n    // Patr√≥n: XXXXXXXXXX (10 d√≠gitos) -> +52XXXXXXXXXX (asumir M√©xico)\n    if (/^[0-9]{10}$/.test(cleanPhone)) {\n        return '+52' + cleanPhone;\n    }\n    \n    // Si no coincide con ning√∫n patr√≥n conocido, retornar original\n    return phoneNumber;\n}\n\n// C√≥digo adaptado para tu estructura espec√≠fica\nconst phoneFromWebhook = $input.first().json.body.entry[0].changes[0].value.messages[0].from; \nconst normalizedPhone = normalizePhone(phoneFromWebhook);\n\nreturn [{\n    json: {\n        ...$input.first().json,  // Mantiene todos los datos originales del webhook\n        phone_number_normalized: normalizedPhone,\n        was_normalized: phoneFromWebhook !== normalizedPhone,\n        original_phone_number: phoneFromWebhook\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        -144
      ],
      "id": "b22ab445-16c6-490d-9b03-e32efdf8a6a3",
      "name": "normalizar_telefono"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "1ad4a7da-1bd2-4120-b9d8-f2d1cf4ca1e8",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        560,
        -144
      ],
      "id": "1ab86888-01d1-4126-a1d2-d3d0bc98e855",
      "name": "Webhook flows",
      "webhookId": "1ad4a7da-1bd2-4120-b9d8-f2d1cf4ca1e8"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "leads_formularios_optimizada",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "telefono",
              "condition": "eq",
              "keyValue": "={{ $('normalizar_telefono').item.json.phone_number_normalized }}"
            },
            {
              "keyName": "nombre_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('Webhook flows').first().json.body.entry[0].changes[0].value.messages[0].interactive.nfm_reply.response_json.cliente_nombre.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1456,
        -144
      ],
      "id": "7c877a42-db5e-4fe6-902b-ad57ab0e0225",
      "name": "extraer client_id",
      "credentials": {
        "supabaseApi": {
          "id": "your_supabase_credential_id",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "535394e1-4244-40d2-93d2-7b19d8359b7a",
              "leftValue": "={{ $json.body.entry[0].changes[0].value.messages[0].type }}",
              "rightValue": "interactive",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        784,
        -144
      ],
      "id": "02e43db6-6b84-4cb2-876d-0d39eaf74cf6",
      "name": "Filter"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "reportes_quejas",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "client_id",
              "condition": "eq",
              "keyValue": "={{ $('extraer client_id').item.json.client_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1680,
        -144
      ],
      "id": "0db60cb5-a1ab-4afb-bbc0-8b66be9a88bc",
      "name": "extraer queja si ya existe una",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "your_supabase_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d9bfa15f-ef61-451d-8be4-7a55366ac09a",
              "leftValue": "={{ $('extraer queja si ya existe una').item.json.client_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1904,
        -144
      ],
      "id": "0d2bdad4-806f-4d11-abd8-76ebb9fc56ef",
      "name": "If"
    },
    {
      "parameters": {
        "tableId": "reportes_quejas",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "fecha",
              "fieldValue": "={{ new Date().toLocaleString() }}"
            },
            {
              "fieldId": "cliente_nombre",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.cliente_nombre }}"
            },
            {
              "fieldId": "tipo_queja",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.tipo_queja }}"
            },
            {
              "fieldId": "nivel_urgencia",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.nivel_urgencia }}"
            },
            {
              "fieldId": "servicio_afectado",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.servicio_afectado }}"
            },
            {
              "fieldId": "detalles",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.resumen_detallado }}"
            },
            {
              "fieldId": "emocion_cliente",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.emocion_cliente }}"
            },
            {
              "fieldId": "estado",
              "fieldValue": "abierta"
            },
            {
              "fieldId": "formulario_enviado",
              "fieldValue": "enviado"
            },
            {
              "fieldId": "telefono",
              "fieldValue": "={{ $('normalizar_telefono').item.json.phone_number_normalized }}"
            },
            {
              "fieldId": "client_id",
              "fieldValue": "={{ $('extraer client_id').item.json.client_id }}"
            },
            {
              "fieldId": "empresa",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.empresa }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2128,
        -48
      ],
      "id": "6f47eb09-a93e-4dc0-9cfb-12fa83f9e98b",
      "name": "crear queja",
      "credentials": {
        "supabaseApi": {
          "id": "your_supabase_credential_id",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "reportes_quejas",
        "filters": {
          "conditions": [
            {
              "keyName": "telefono",
              "condition": "eq",
              "keyValue": "={{ $('normalizar_telefono').item.json.phone_number_normalized }}"
            },
            {
              "keyName": "client_id",
              "condition": "eq",
              "keyValue": "={{ $('extraer client_id').item.json.client_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "fecha",
              "fieldValue": "={{ new Date().toLocaleString() }}"
            },
            {
              "fieldId": "cliente_nombre",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.cliente_nombre }}"
            },
            {
              "fieldId": "tipo_queja",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.tipo_queja }}"
            },
            {
              "fieldId": "nivel_urgencia",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.nivel_urgencia }}"
            },
            {
              "fieldId": "servicio_afectado",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.servicio_afectado }}"
            },
            {
              "fieldId": "detalles",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.resumen_detallado }}"
            },
            {
              "fieldId": "emocion_cliente",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.emocion_cliente }}"
            },
            {
              "fieldId": "estado",
              "fieldValue": "abierta"
            },
            {
              "fieldId": "formulario_enviado",
              "fieldValue": "enviado"
            },
            {
              "fieldId": "telefono",
              "fieldValue": "={{ $('normalizar_telefono').item.json.phone_number_normalized }}"
            },
            {
              "fieldId": "empresa",
              "fieldValue": "={{ $('convertir datos de json flow WA').item.json.empresa }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2128,
        -240
      ],
      "id": "f8b368e3-dec8-425d-903e-fdb1fc99a733",
      "name": "actualizar queja",
      "credentials": {
        "supabaseApi": {
          "id": "your_supabase_credential_id",
          "name": "Supabase account"
        }
      }
    }
  ],
  "pinData": {
    "Webhook flows": [
      {
        "json": {
          "headers": {
            "host": "your_n8n_domain.com",
            "user-agent": "facebookexternalua",
            "content-length": "1095",
            "accept": "*/*",
            "accept-encoding": "deflate, gzip",
            "content-type": "application/json",
            "x-forwarded-for": "your_ip_address",
            "x-forwarded-host": "your_n8n_domain.com",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "737fb838982b",
            "x-hub-signature": "sha1=your_signature",
            "x-hub-signature-256": "sha256=your_signature",
            "x-real-ip": "your_ip_address"
          },
          "params": {},
          "query": {},
          "body": {
            "object": "whatsapp_business_account",
            "entry": [
              {
                "id": "your_external_id",
                "changes": [
                  {
                    "value": {
                      "messaging_product": "whatsapp",
                      "metadata": {
                        "display_phone_number": "your_phone_number",
                        "phone_number_id": "710637588808362"
                      },
                      "contacts": [
                        {
                          "profile": {
                            "name": "your_brand"
                          },
                          "wa_id": "your_phone_number"
                        }
                      ],
                      "messages": [
                        {
                          "context": {
                            "from": "your_phone_number",
                            "id": "your_whatsapp_message_id"
                          },
                          "from": "your_phone_number",
                          "id": "your_whatsapp_message_id",
                          "timestamp": "1763581431",
                          "type": "interactive",
                          "interactive": {
                            "type": "nfm_reply",
                            "nfm_reply": {
                              "response_json": "{\"cliente_nombre\":\"your_full_name your_surname your_surname \",\"empresa\":\"your_company \",\"servicio_afectado\":\"marketing_digital\",\"tipo_queja\":\"resultados_no_esperados\",\"nivel_urgencia\":\"media\",\"resumen_detallado\":\"No estoy obteniendo suficientes leads y es el primer d\\u00eda de la campa\\u00f1a de meta\",\"emocion_cliente\":\"decepcionado\",\"flow_token\":\"unused\"}",
                              "body": "Sent",
                              "name": "flow"
                            }
                          }
                        }
                      ]
                    },
                    "field": "messages"
                  }
                ]
              }
            ]
          },
          "webhookUrl": "https://your_n8n_domain_service/webhook/1ad4a7da-1bd2-4120-b9d8-f2d1cf4ca1e8",
          "executionMode": "production"
        }
      }
    ]
  },
  "connections": {
    "normalizar_telefono": {
      "main": [
        [
          {
            "node": "convertir datos de json flow WA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "convertir datos de json flow WA": {
      "main": [
        [
          {
            "node": "extraer client_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook flows": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extraer client_id": {
      "main": [
        [
          {
            "node": "extraer queja si ya existe una",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "normalizar_telefono",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extraer queja si ya existe una": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "actualizar queja",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "crear queja",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Mexico_City",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "bf77c0bb-9808-461c-9b17-3905ea509704",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "your_instance_id"
  },
  "id": "your_credential_id",
  "tags": []
}