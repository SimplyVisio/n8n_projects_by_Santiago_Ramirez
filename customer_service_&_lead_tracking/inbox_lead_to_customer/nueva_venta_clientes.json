{
  "name": "nueva_venta_clientes",
  "nodes": [
    {
      "parameters": {
        "content": "## üìà Sales Conversion & Booking Logic\n\nThis workflow specialized in converting qualified leads into appointments. It handles the specific logic for new sales, including calendar coordination and status synchronization.\n\n### Core Operations:\n1. **Intent Classification**: Uses a multi-stage prompt to distinguish between 'Ready to Buy', 'Asking for Prices', and 'Need Advice'.\n2. **Automated Scheduling**: Interfaces with Google Calendar to create, update, or cancel sales meetings based on AI-governed decisions.\n3. **CRM Synchronization**: Updates Supabase tables (`leads`, `citas`) to ensure the sales dashboard reflects real-time conversion data.\n4. **Engagement loop**: Sends immediate confirmation emails and WhatsApp messages to reduce no-show rates.",
        "height": 450,
        "width": 320,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2500,
        -1600
      ],
      "typeVersion": 1,
      "id": "doc-sales-logic",
      "name": "Architecture Documentation"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Usa esta herramienta cuando el usuario quiera crear una nueva cita.",
        "calendar": {
          "__rl": true,
          "value": "your_calendar_id@gmail.com",
          "mode": "list",
          "cachedResultName": "your_calendar_id@gmail.com"
        },
        "start": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', ``, 'string') }}",
        "end": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', ``, 'string') }}",
        "additionalFields": {
          "attendees": [
            "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('attendees0_Attendees', ``, 'string') }}"
          ],
          "conferenceDataUi": {
            "conferenceDataValues": {
              "conferenceSolution": "hangoutsMeet"
            }
          },
          "description": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Description', ``, 'string') }}",
          "location": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Location', ``, 'string') }}",
          "summary": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Summary', ``, 'string') }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        1856,
        -432
      ],
      "id": "a85c6b63-37c5-471e-b292-af090cfcd593",
      "name": "create_event1",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "your_google_calendar_credential_id",
          "name": "your_brand Nuevo"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Usa esta herramienta si el usuario quiere saber cuando tiene una cita.",
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "your_calendar_id@gmail.com",
          "mode": "list",
          "cachedResultName": "your_calendar_id@gmail.com"
        },
        "returnAll": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', ``, 'boolean') }}",
        "timeMin": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('After', ``, 'string') }}",
        "timeMax": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Before', ``, 'string') }}",
        "options": {
          "timeZone": {
            "__rl": true,
            "value": "America/Mexico_City",
            "mode": "list",
            "cachedResultName": "America/Mexico_City"
          }
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        1984,
        -432
      ],
      "id": "b241a28d-5ced-48a3-a6b3-ec87ed8d4a1c",
      "name": "getall_event1",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "your_google_calendar_credential_id",
          "name": "your_brand Nuevo"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Usa esta herramienta cuando el usuario quiera cancelar una cita existente.",
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "value": "your_calendar_id@gmail.com",
          "mode": "list",
          "cachedResultName": "your_calendar_id@gmail.com"
        },
        "eventId": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        2112,
        -432
      ],
      "id": "dc5ea10c-1852-4727-b776-31998f4394d6",
      "name": "delete_event1",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "your_google_calendar_credential_id",
          "name": "your_brand Nuevo"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow').item.json.conversationId }}/labels",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "labels",
              "value": "={{ Array('ventas') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2576,
        -464
      ],
      "id": "a63dc270-e1c1-438e-bc12-cf1530b34980",
      "name": "etiqueta nueva venta clientes",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('set_campos').item.json.client_id }}",
        "tableName": "conversaciones",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        1728,
        -432
      ],
      "id": "2516f5bf-1831-41c2-b977-1246fa7dc781",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "your_postgres_credential_id",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('parsear output a json').item.json.estado }}",
                    "rightValue": "cita agendada",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "cacb1404-17bb-4da0-aa3d-30580ef64607"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cita agendada"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6dc35352-4cf4-4555-8dbf-560bdc5e957a",
                    "leftValue": "={{ $('parsear output a json').item.json.estado }}",
                    "rightValue": "cita reagendada",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cita reagendada"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e4a1bb3e-8c6f-4438-aaa1-a653c38d54ae",
                    "leftValue": "={{ $('parsear output a json').item.json.estado }}",
                    "rightValue": "cita cancelada",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cita cancelada"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "696916ab-3cea-456d-b544-06e94ceb89ec",
                    "leftValue": "={{ $('parsear output a json').item.json.estado }}",
                    "rightValue": "cita pospuesta",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cita pospuesta"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3024,
        -928
      ],
      "id": "9443207a-b6d9-48d1-a196-6303fdd72f10",
      "name": "tarea"
    },
    {
      "parameters": {
        "tableId": "citas",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "client_id",
              "fieldValue": "={{ $('When Executed by Another Workflow').item.json.client_id}}"
            },
            {
              "fieldId": "estado",
              "fieldValue": "=cita agendada"
            },
            {
              "fieldId": "nombre",
              "fieldValue": "={{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}"
            },
            {
              "fieldId": "fecha_cita",
              "fieldValue": "=    {{ $('parsear output a json').item.json.fecha_cita}}"
            },
            {
              "fieldId": "email",
              "fieldValue": "=  {{ $('parsear output a json').item.json.email_normalizado ?? $('When Executed by Another Workflow').item.json.email}}"
            },
            {
              "fieldId": "telefono",
              "fieldValue": "=  {{ $('parsear output a json').item.json.telefono_normalizado ?? $('When Executed by Another Workflow').item.json.telefono}}"
            },
            {
              "fieldId": "servicio",
              "fieldValue": "={{ $('parsear output a json').item.json.servicio ?? $('When Executed by Another Workflow').item.json.servicio}}"
            },
            {
              "fieldId": "pais",
              "fieldValue": "={{ $('parsear output a json').item.json.pais ?? $('When Executed by Another Workflow').item.json.pais}}"
            },
            {
              "fieldId": "empresa",
              "fieldValue": "={{ $('parsear output a json').item.json.empresa ?? $('When Executed by Another Workflow').item.json.empresa}}"
            },
            {
              "fieldId": "enlace_reunion",
              "fieldValue": "={{ $('parsear output a json').item.json.enlace_reunion}}"
            },
            {
              "fieldId": "fecha_cita_timezone_cliente",
              "fieldValue": "={{ $('parsear output a json').item.json.fecha_cita_timezone_cliente}}"
            },
            {
              "fieldId": "duracion_minutos",
              "fieldValue": "30"
            },
            {
              "fieldId": "fecha_cita_timezone_legible",
              "fieldValue": "={{ $('parsear output a json').item.json.fecha_cita_timezone_legible}}"
            },
            {
              "fieldId": "fecha_cita_legible",
              "fieldValue": "={{ $('parsear output a json').item.json.fecha_cita_legible}}"
            },
            {
              "fieldId": "cita_pasada",
              "fieldValue": "No"
            },
            {
              "fieldId": "google_event_id",
              "fieldValue": "={{ $('parsear output a json').item.json.nuevo_google_event_id}}"
            },
            {
              "fieldId": "recordatorio_enviado",
              "fieldValue": "FALSE"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3696,
        -1200
      ],
      "id": "c7f6515d-dc12-4e14-bbfe-1a21886581ef",
      "name": "crear_cita1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "your_supabase_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "leads_formularios_optimizada",
        "filters": {
          "conditions": [
            {
              "keyName": "client_id",
              "condition": "eq",
              "keyValue": "={{ $('When Executed by Another Workflow').item.json.client_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "es_cliente",
              "fieldValue": "=true"
            },
            {
              "fieldId": "estado_lead",
              "fieldValue": "Cita agendada"
            },
            {
              "fieldId": "pais",
              "fieldValue": "={{ $('parsear output a json').item.json.pais ?? $('When Executed by Another Workflow').item.json.pais}}"
            },
            {
              "fieldId": "nombre",
              "fieldValue": "={{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}"
            },
            {
              "fieldId": "nombre_normalizado",
              "fieldValue": "={{ $('parsear output a json').item.json.nombre_normalizado ?? $('When Executed by Another Workflow').item.json.nombre_normalizado}}"
            },
            {
              "fieldId": "telefono",
              "fieldValue": "={{ $('parsear output a json').item.json.telefono_normalizado ?? $('When Executed by Another Workflow').item.json.telefono}}"
            },
            {
              "fieldId": "servicio",
              "fieldValue": "={{ $('parsear output a json').item.json.servicio ?? $('When Executed by Another Workflow').item.json.servicio}}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $('parsear output a json').item.json.email_normalizado ?? $('When Executed by Another Workflow').item.json.email}}"
            },
            {
              "fieldId": "empresa",
              "fieldValue": "={{ $('parsear output a json').item.json.empresa ?? $('When Executed by Another Workflow').item.json.empresa}}"
            },
            {
              "fieldId": "score_lead",
              "fieldValue": "={{\n  (\n    $('When Executed by Another Workflow').item.json.score_lead === 0 ||\n    $('When Executed by Another Workflow').item.json.score_lead === '' ||\n    $('When Executed by Another Workflow').item.json.score_lead === null ||\n    $('When Executed by Another Workflow').item.json.score_lead === undefined\n  )\n    ? $('parsear output a json').item.json.score_lead\n    : $('When Executed by Another Workflow').item.json.score_lead\n}}\n"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3920,
        -1200
      ],
      "id": "40af958e-f4f8-4f47-b7c8-c866426b27cc",
      "name": "actualizar_lead1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "your_supabase_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "citas",
        "filters": {
          "conditions": [
            {
              "keyName": "client_id",
              "condition": "eq",
              "keyValue": "={{ $('When Executed by Another Workflow').item.json.client_id}}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "estado",
              "fieldValue": "cita reagendada"
            },
            {
              "fieldId": "nombre",
              "fieldValue": "={{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}"
            },
            {
              "fieldId": "fecha_cita",
              "fieldValue": "={{ $('parsear output a json').item.json.fecha_cita}}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $('parsear output a json').item.json.email_normalizado ?? $('When Executed by Another Workflow').item.json.email}}"
            },
            {
              "fieldId": "telefono",
              "fieldValue": "={{ $('parsear output a json').item.json.telefono_normalizado ?? $('When Executed by Another Workflow').item.json.telefono}}"
            },
            {
              "fieldId": "servicio",
              "fieldValue": "={{ $('parsear output a json').item.json.servicio ?? $('When Executed by Another Workflow').item.json.servicio}}"
            },
            {
              "fieldId": "pais",
              "fieldValue": "={{ $('parsear output a json').item.json.pais ?? $('When Executed by Another Workflow').item.json.pais}}"
            },
            {
              "fieldId": "empresa",
              "fieldValue": "={{ $('parsear output a json').item.json.empresa ?? $('When Executed by Another Workflow').item.json.empresa}}"
            },
            {
              "fieldId": "enlace_reunion",
              "fieldValue": "={{ $('parsear output a json').item.json.enlace_reunion}}"
            },
            {
              "fieldId": "fecha_cita_timezone_cliente",
              "fieldValue": "={{ $('parsear output a json').item.json.fecha_cita_timezone_cliente}}"
            },
            {
              "fieldId": "fecha_cita_timezone_legible",
              "fieldValue": "={{ $('parsear output a json').item.json.fecha_cita_timezone_legible}}"
            },
            {
              "fieldId": "fecha_cita_legible",
              "fieldValue": "={{ $('parsear output a json').item.json.fecha_cita_legible}}"
            },
            {
              "fieldId": "cita_pasada",
              "fieldValue": "No"
            },
            {
              "fieldId": "google_event_id",
              "fieldValue": "={{ $('parsear output a json').item.json.nuevo_google_event_id}}"
            },
            {
              "fieldId": "recordatorio_enviado",
              "fieldValue": "FALSE"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3248,
        -912
      ],
      "id": "18402fd6-fd1a-4d2f-ae76-60381c9ea948",
      "name": "reprogramar_cita1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "your_supabase_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "sendTo": "={{ $('parsear output a json').item.json.email_normalizado ?? $('When Executed by Another Workflow').item.json.email}}",
        "subject": "Cita Agendada",
        "message": "=<!DOCTYPE html> <html lang=\"es\"> <head>     <meta charset=\"UTF-8\">     <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">     <title>Cita Agendada - your_brand</title> </head> <body style=\"margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0a0a0a;\">     <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #0a0a0a; padding: 20px;\">         <tr>             <td align=\"center\">                 <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #1a1a1a; border-radius: 15px; overflow: hidden; box-shadow: 0 0 30px rgba(0, 255, 255, 0.2); border: 1px solid #00ffff;\">                                          <!-- Header con logo y fondo decorativo -->                     <tr>                         <td style=\"background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); padding: 40px 30px; text-align: center; position: relative; border-bottom: 2px solid #00ffff;\">                                                         <!-- Logo -->                             <img src=\"https://ik.imagekit.io/49rd3bmeqs/Logos%20your_brand/logo2%20(3).png?updatedAt=1759468732222\" alt=\"your_brand Logo\" style=\"width: 120px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(0, 255, 255, 0.5));\" />                                                          <h1 style=\"margin: 0; color: #00ffff; font-size: 32px; font-weight: 700; text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);\">                                 ‚úì Cita Confirmada                             </h1>                             <p style=\"margin: 10px 0 0 0; color: #ffffff; font-size: 16px;\">                                 Tu reuni√≥n ha sido agendada exitosamente                             </p>                         </td>                     </tr>                      <!-- Contenido principal -->                     <tr>                         <td style=\"padding: 40px 30px; background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);\">                             <p style=\"margin: 0 0 25px 0; color: #ffffff; font-size: 18px; line-height: 1.6;\">                                 Hola <strong style=\"color: #00ffff;\">{{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}</strong>,                             </p>                                                          <p style=\"margin: 0 0 30px 0; color: #e0e0e0; font-size: 16px; line-height: 1.6;\">                                 Nos complace confirmar que tu cita del <strong style=\"color: #00ffff;\">{{$('parsear output a json').item.json.fecha_cita_timezone_legible\n}}</strong> ha sido agendada.                             </p>                              <!-- Bloque de informaci√≥n de la reuni√≥n -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 30px 0;\">                                 <tr>                                     <td style=\"background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border-left: 4px solid #00ffff; padding: 25px; border-radius: 10px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.15);\">                                         <h3 style=\"margin: 0 0 15px 0; color: #00ffff; font-size: 20px; display: flex; align-items: center;\">                                             üìÖ Detalles de tu Reuni√≥n                                         </h3>                                         <p style=\"margin: 0 0 10px 0; color: #ffffff; font-size: 15px; line-height: 1.6;\">                                             <strong style=\"color: #00ffff;\">Fecha:</strong> {{$('parsear output a json').item.json.fecha_cita_timezone_legible\n}}                                      </p>                                         <p style=\"margin: 0; color: #e0e0e0; font-size: 14px; line-height: 1.5;\">                                             <strong style=\"color: #00ffff;\">Enlace:</strong><br>                                             <a href=\"{{ $('parsear output a json').item.json.enlace_reunion }}\" style=\"color: #ffffff; word-break: break-all; text-decoration: none;\">{{ $('parsear output a json').item.json.enlace_reunion }}</a>                                         </p>                                     </td>                                 </tr>                             </table>                              <!-- Bot√≥n llamada a la acci√≥n -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 35px 0;\">                                 <tr>                                     <td align=\"center\">                                         <a href=\"{{ $('parsear output a json').item.json.enlace_reunion }}\" style=\"display: inline-block; background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%); color: #000000; text-decoration: none; padding: 18px 45px; border-radius: 30px; font-size: 18px; font-weight: 700; box-shadow: 0 0 25px rgba(0, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 1px;\">                                             üé• Unirse a la Reuni√≥n                                         </a>                                     </td>                                 </tr>                             </table>                              <!-- Secci√≥n de servicios -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 40px 0 30px 0;\">                                 <tr>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">ü§ñ</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Inteligencia Artificial</h4>                                         </div>                                     </td>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">üìä</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Marketing Digital</h4>                                         </div>                                     </td>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">üì±</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Redes Sociales</h4>                                         </div>                                     </td>                                 </tr>                             </table>                              <!-- Link al sitio web -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 30px 0;\">                                 <tr>                                     <td align=\"center\" style=\"background-color: #0a0a0a; padding: 20px; border-radius: 10px; border: 1px solid #333333;\">                                         <p style=\"margin: 0 0 10px 0; color: #ffffff; font-size: 15px;\">                                             üåê Conoce m√°s sobre nuestros servicios                                         </p>                                         <a href=\"https://www.your_brand.com.mx\" style=\"color: #00ffff; text-decoration: none; font-weight: 600; font-size: 16px; text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);\">                                             Vis√≠tanos aqu√≠ ‚Üí                                         </a>                                     </td>                                 </tr>                             </table>                          </td>                     </tr>                      <!-- Footer -->                     <tr>                         <td style=\"background-color: #000000; padding: 35px 30px; text-align: center; border-top: 2px solid #00ffff;\">                             <p style=\"margin: 0 0 15px 0; color: #ffffff; font-size: 16px; font-weight: 600;\">                                 Gracias por confiar en nosotros                             </p>                             <p style=\"margin: 0 0 20px 0; color: #00ffff; font-size: 15px;\">                                 your_name<br>                                 <span style=\"color: #999999; font-size: 13px;\">CEO de your_brand</span>                             </p>                             <div style=\"width: 60px; height: 2px; background: linear-gradient(90deg, transparent, #00ffff, transparent); margin: 20px auto;\"></div>                             <p style=\"margin: 0; color: #666666; font-size: 12px;\">                                 ¬© 2025 your_brand. Todos los derechos reservados.                             </p>                             <p style=\"margin: 15px 0 0 0;\">                                 <a href=\"https://www.your_brand.com.mx\" style=\"color: #00ffff; text-decoration: none; margin: 0 10px; font-size: 12px;\">Sitio Web</a>                                 <span style=\"color: #333333;\">|</span>                                 <a href=\"https://wa.me/your_phone_number?text=\" style=\"color: #00ffff; text-decoration: none; margin: 0 10px; font-size: 12px;\">WhatsApp</a>                             </p>                         </td>                     </tr>                  </table>             </td>         </tr>     </table> </body> </html>",
        "options": {
          "appendAttribution": false,
          "senderName": "your_name, CEO de your_brand"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        4144,
        -1200
      ],
      "id": "21a0198e-643b-4ea3-8bea-6ed10da0d46f",
      "name": "enviar_correo_cita_agendada1",
      "webhookId": "61a46709-2e59-4111-9e1c-426028790690",
      "alwaysOutputData": true,
      "credentials": {
        "gmailOAuth2": {
          "id": "your_gmail_credential_id",
          "name": "your_brand Nuevo"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "sendTo": "={{ $('parsear output a json').item.json.email_normalizado ?? $('When Executed by Another Workflow').item.json.email}}",
        "subject": "Cita Reagendada",
        "message": "=<!DOCTYPE html> <html lang=\"es\"> <head>     <meta charset=\"UTF-8\">     <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">     <title>Cita Reagendada - your_brand</title> </head> <body style=\"margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0a0a0a;\">     <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #0a0a0a; padding: 20px;\">         <tr>             <td align=\"center\">                 <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #1a1a1a; border-radius: 15px; overflow: hidden; box-shadow: 0 0 30px rgba(255, 165, 0, 0.2); border: 1px solid #ffa500;\">                                          <!-- Header con logo y fondo decorativo -->                     <tr>                         <td style=\"background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); padding: 40px 30px; text-align: center; position: relative; border-bottom: 2px solid #ffa500;\">                                                          <!-- Logo -->                             <img src=\"https://ik.imagekit.io/49rd3bmeqs/Logos%20your_brand/logo2%20(3).png?updatedAt=1759468732222\" alt=\"your_brand Logo\" style=\"width: 120px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(255, 165, 0, 0.5));\" />                                                          <h1 style=\"margin: 0; color: #ffa500; font-size: 32px; font-weight: 700; text-shadow: 0 0 20px rgba(255, 165, 0, 0.8);\">                                 üîÑ Cita Reagendada                             </h1>                             <p style=\"margin: 10px 0 0 0; color: #ffffff; font-size: 16px;\">                                 Tu reuni√≥n ha sido reagendada exitosamente                             </p>                         </td>                     </tr>                      <!-- Contenido principal -->                     <tr>                         <td style=\"padding: 40px 30px; background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);\">                             <p style=\"margin: 0 0 25px 0; color: #ffffff; font-size: 18px; line-height: 1.6;\">                                 Hola <strong style=\"color: #00ffff;\">{{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}</strong>,                             </p>                                                          <p style=\"margin: 0 0 30px 0; color: #e0e0e0; font-size: 16px; line-height: 1.6;\">                                 Nos complace confirmar que tu cita ha sido reagendada para el <strong style=\"color: #ffa500;\">\n{{$('parsear output a json').item.json.fecha_cita_timezone_legible\n}}</strong>.                             </p>                              <!-- Bloque de informaci√≥n de la reuni√≥n -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 30px 0;\">                                 <tr>                                     <td style=\"background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border-left: 4px solid #ffa500; padding: 25px; border-radius: 10px; box-shadow: 0 0 20px rgba(255, 165, 0, 0.15);\">                                         <h3 style=\"margin: 0 0 15px 0; color: #ffa500; font-size: 20px; display: flex; align-items: center;\">                                             üìÖ Detalles de tu Reuni√≥n                                         </h3>                                         <p style=\"margin: 0 0 10px 0; color: #ffffff; font-size: 15px; line-height: 1.6;\">                                             <strong style=\"color: #ffa500;\">Nueva Fecha:</strong> {{$('parsear output a json').item.json.fecha_cita_timezone_legible\n}}                                        </p>                                         <p style=\"margin: 0; color: #e0e0e0; font-size: 14px; line-height: 1.5;\">                                             <strong style=\"color: #ffa500;\">Enlace:</strong><br>                                             <a href=\"{{ $('parsear output a json').item.json.enlace_reunion }}\" style=\"color: #ffffff; word-break: break-all; text-decoration: none;\">{{ $('parsear output a json').item.json.enlace_reunion }}</a>                                         </p>                                     </td>                                 </tr>                             </table>                              <!-- Bot√≥n llamada a la acci√≥n -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 35px 0;\">                                 <tr>                                     <td align=\"center\">                                         <a href=\"{{ $('parsear output a json').item.json.enlace_reunion }}\" style=\"display: inline-block; background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%); color: #000000; text-decoration: none; padding: 18px 45px; border-radius: 30px; font-size: 18px; font-weight: 700; box-shadow: 0 0 25px rgba(255, 165, 0, 0.6); text-transform: uppercase; letter-spacing: 1px;\">                                             üé• Unirse a la Reuni√≥n                                         </a>                                     </td>                                 </tr>                             </table>                              <!-- Secci√≥n de servicios -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 40px 0 30px 0;\">                                 <tr>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">ü§ñ</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Inteligencia Artificial</h4>                                         </div>                                     </td>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">üìä</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Marketing Digital</h4>                                         </div>                                     </td>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">üì±</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Redes Sociales</h4>                                         </div>                                     </td>                                 </tr>                             </table>                              <!-- Link al sitio web -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 30px 0;\">                                 <tr>                                     <td align=\"center\" style=\"background-color: #0a0a0a; padding: 20px; border-radius: 10px; border: 1px solid #333333;\">                                         <p style=\"margin: 0 0 10px 0; color: #ffffff; font-size: 15px;\">                                             üåê Conoce m√°s sobre nuestros servicios                                         </p>                                         <a href=\"https://www.your_brand.com.mx\" style=\"color: #00ffff; text-decoration: none; font-weight: 600; font-size: 16px; text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);\">                                             Vis√≠tanos aqu√≠ ‚Üí                                         </a>                                     </td>                                 </tr>                             </table>                          </td>                     </tr>                      <!-- Footer -->                     <tr>                         <td style=\"background-color: #000000; padding: 35px 30px; text-align: center; border-top: 2px solid #ffa500;\">                             <p style=\"margin: 0 0 15px 0; color: #ffffff; font-size: 16px; font-weight: 600;\">                                 Gracias por confiar en nosotros                             </p>                             <p style=\"margin: 0 0 20px 0; color: #00ffff; font-size: 15px;\">                                 your_name<br>                                 <span style=\"color: #999999; font-size: 13px;\">CEO de your_brand</span>                             </p>                             <div style=\"width: 60px; height: 2px; background: linear-gradient(90deg, transparent, #00ffff, transparent); margin: 20px auto;\"></div>                             <p style=\"margin: 0; color: #666666; font-size: 12px;\">                                 ¬© 2025 your_brand. Todos los derechos reservados.                             </p>                             <p style=\"margin: 15px 0 0 0;\">                                 <a href=\"https://www.your_brand.com.mx\" style=\"color: #00ffff; text-decoration: none; margin: 0 10px; font-size: 12px;\">Sitio Web</a>                                 <span style=\"color: #333333;\">|</span>                                 <a href=\"https://wa.me/your_phone_number?text=\" style=\"color: #00ffff; text-decoration: none; margin: 0 10px; font-size: 12px;\">WhatsApp</a>                             </p>                         </td>                     </tr>                  </table>             </td>         </tr>     </table> </body> </html>",
        "options": {
          "appendAttribution": false,
          "senderName": "your_name, CEO de your_brand"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        3472,
        -912
      ],
      "id": "c8b4f433-4a94-4e40-ae00-811794440536",
      "name": "enviar_correo_cita_reprogramada1",
      "webhookId": "61a46709-2e59-4111-9e1c-426028790690",
      "alwaysOutputData": true,
      "credentials": {
        "gmailOAuth2": {
          "id": "your_gmail_credential_id",
          "name": "your_brand Nuevo"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "phoneNumberId": "710637588808362",
        "recipientPhoneNumber": "={{ $('parsear output a json').item.json.telefono_normalizado ?? $('When Executed by Another Workflow').item.json.telefono}}",
        "template": "cita_reagendada|es",
        "components": {
          "component": [
            {
              "bodyParameters": {
                "parameter": [
                  {
                    "text": "={{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}"
                  },
                  {
                    "text": "={{ $('parsear output a json').item.json.fecha_cita_timezone_legible }} "
                  },
                  {
                    "text": "={{ $('parsear output a json').item.json.enlace_reunion }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        4144,
        -816
      ],
      "id": "004b04e8-ee27-43b7-b5fa-22a22d515d80",
      "name": "reagendar_cita_wa",
      "webhookId": "53e8e612-3424-4d89-abec-23266c4eabbc",
      "alwaysOutputData": true,
      "credentials": {
        "whatsAppApi": {
          "id": "your_whatsapp_credential_id",
          "name": "WhatsApp account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "phoneNumberId": "710637588808362",
        "recipientPhoneNumber": "={{ $('parsear output a json').item.json.telefono_normalizado ?? $('When Executed by Another Workflow').item.json.telefono}}",
        "template": "cita_agendada|es_MX",
        "components": {
          "component": [
            {
              "bodyParameters": {
                "parameter": [
                  {
                    "text": "={{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}"
                  },
                  {
                    "text": "={{ $('parsear output a json').item.json.fecha_cita_timezone_legible }} "
                  },
                  {
                    "text": "={{ $('parsear output a json').item.json.enlace_reunion }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        4816,
        -1104
      ],
      "id": "d6f1f61f-9571-4d1c-afcd-3d37ef07d88d",
      "name": "confirmar_cita_wa",
      "webhookId": "53e8e612-3424-4d89-abec-23266c4eabbc",
      "alwaysOutputData": true,
      "credentials": {
        "whatsAppApi": {
          "id": "your_whatsapp_credential_id",
          "name": "WhatsApp account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "chatId": "your_telegram_chat_id",
        "text": "=Nueva Cita con {{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}\nFecha: {{ $('parsear output a json').item.json.fecha_cita_legible }}\nEnlace: {{ $('parsear output a json').item.json.enlace_reunion }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4368,
        -1200
      ],
      "id": "8546f14a-c9a7-48c2-a355-e4364d533ea1",
      "name": "agenda_telegram_citas",
      "webhookId": "2e1dac8d-f98d-4807-8539-2fd816da71c0",
      "alwaysOutputData": true,
      "credentials": {
        "telegramApi": {
          "id": "your_telegram_credential_id",
          "name": "Citas your_brand"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "chatId": "=your_telegram_chat_id",
        "text": "=Cita reagendada con {{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}\nFecha: {{ $('parsear output a json').item.json.fecha_cita_legible }}\nEnlace: {{ $('parsear output a json').item.json.enlace_reunion }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3696,
        -912
      ],
      "id": "72d8b694-8ea3-4636-b185-7f3a5ebd1b55",
      "name": "agenda_telegram_citas1",
      "webhookId": "2e1dac8d-f98d-4807-8539-2fd816da71c0",
      "alwaysOutputData": true,
      "credentials": {
        "telegramApi": {
          "id": "your_telegram_credential_id",
          "name": "Citas your_brand"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "chatId": "your_telegram_chat_id",
        "text": "=Cita Cancelada con {{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}\nFecha: {{ $('parsear output a json').item.json.fecha_cita_legible_database }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3696,
        -528
      ],
      "id": "9b2cf483-ce3f-4a33-9802-e57a5b7c0438",
      "name": "agenda_telegram_citas2",
      "webhookId": "2e1dac8d-f98d-4807-8539-2fd816da71c0",
      "alwaysOutputData": true,
      "credentials": {
        "telegramApi": {
          "id": "your_telegram_credential_id",
          "name": "Citas your_brand"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "chatId": "your_telegram_chat_id",
        "text": "=Cita pospuesta con {{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}\nFecha: {{ $('parsear output a json').item.json.fecha_cita_legible_database }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3696,
        -144
      ],
      "id": "fc9b2c63-4ca0-4e36-a0a6-4f392d234f77",
      "name": "agenda_telegram_citas3",
      "webhookId": "2e1dac8d-f98d-4807-8539-2fd816da71c0",
      "alwaysOutputData": true,
      "credentials": {
        "telegramApi": {
          "id": "your_telegram_credential_id",
          "name": "Citas your_brand"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "citas",
        "filters": {
          "conditions": [
            {
              "keyName": "client_id",
              "condition": "eq",
              "keyValue": "={{ $('When Executed by Another Workflow').item.json.client_id}}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "estado",
              "fieldValue": "cita cancelada"
            },
            {
              "fieldId": "cancelado_por",
              "fieldValue": "={{ $('When Executed by Another Workflow').item.json.agente}}"
            },
            {
              "fieldId": "motivo_cancelacion",
              "fieldValue": "={{ $('parsear output a json').item.json.motivo_cancelacion}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3248,
        -528
      ],
      "id": "32ba7b8d-c772-425e-86d1-741870ea447b",
      "name": "cancelar cita",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "your_supabase_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "sendTo": "={{ $('parsear output a json').item.json.email_normalizado ?? $('When Executed by Another Workflow').item.json.email}}",
        "subject": "Cita Cancelada",
        "message": "=<!DOCTYPE html> <html lang=\"es\"> <head>     <meta charset=\"UTF-8\">     <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">     <title>Cita Cancelada - your_brand</title> </head> <body style=\"margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0a0a0a;\">     <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #0a0a0a; padding: 20px;\">         <tr>             <td align=\"center\">                 <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #1a1a1a; border-radius: 15px; overflow: hidden; box-shadow: 0 0 30px rgba(255, 50, 50, 0.2); border: 1px solid #ff3232;\">                                          <!-- Header con logo y fondo decorativo -->                     <tr>                         <td style=\"background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); padding: 40px 30px; text-align: center; position: relative; border-bottom: 2px solid #ff3232;\">                                                          <!-- Logo -->                             <img src=\"https://ik.imagekit.io/49rd3bmeqs/Logos%20your_brand/logo2%20(3).png?updatedAt=1759468732222\" alt=\"your_brand Logo\" style=\"width: 120px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(255, 50, 50, 0.5));\" />                                                          <h1 style=\"margin: 0; color: #ff3232; font-size: 32px; font-weight: 700; text-shadow: 0 0 20px rgba(255, 50, 50, 0.8);\">                                 ‚úï Cita Cancelada                             </h1>                             <p style=\"margin: 10px 0 0 0; color: #ffffff; font-size: 16px;\">                                 Tu reuni√≥n ha sido cancelada                             </p>                         </td>                     </tr>                      <!-- Contenido principal -->                     <tr>                         <td style=\"padding: 40px 30px; background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);\">                             <p style=\"margin: 0 0 25px 0; color: #ffffff; font-size: 18px; line-height: 1.6;\">                                 Hola <strong style=\"color: #00ffff;\">{{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}</strong>,                             </p>                                                          <p style=\"margin: 0 0 30px 0; color: #e0e0e0; font-size: 16px; line-height: 1.6;\">                                 Lamentamos que su cita del <strong style=\"color: #ff3232;\">{{ $('parsear output a json').item.json.fecha_cita_timezone_legible_database }} </strong> haya sido cancelada. Puede solicitar que se le agende una nueva cita cuando guste.                             </p>                              <!-- Bloque de informaci√≥n -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 30px 0;\">                                 <tr>                                     <td style=\"background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border-left: 4px solid #ff3232; padding: 25px; border-radius: 10px; box-shadow: 0 0 20px rgba(255, 50, 50, 0.15);\">                                         <h3 style=\"margin: 0 0 15px 0; color: #ff3232; font-size: 20px; display: flex; align-items: center;\">                                             üìÖ Informaci√≥n de la Cita                                         </h3>                                         <p style=\"margin: 0 0 10px 0; color: #ffffff; font-size: 15px; line-height: 1.6;\">                                             <strong style=\"color: #ff3232;\">Fecha Cancelada:</strong> {{ $('parsear output a json').item.json.fecha_cita_timezone_legible_database }}                                       </p>                                         <p style=\"margin: 0; color: #e0e0e0; font-size: 14px; line-height: 1.5;\">                                             <strong style=\"color: #00ffff;\">Estado:</strong> Cancelada                                         </p>                                     </td>                                 </tr>                             </table>                              <!-- Bot√≥n para agendar nueva cita -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 35px 0;\">                                 <tr>                                     <td align=\"center\">                                         <a href=\"https://wa.me/your_phone_number?text=\" style=\"display: inline-block; background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%); color: #000000; text-decoration: none; padding: 18px 45px; border-radius: 30px; font-size: 18px; font-weight: 700; box-shadow: 0 0 25px rgba(0, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 1px;\">                                             üìÜ Agendar Nueva Cita                                         </a>                                     </td>                                 </tr>                             </table>                              <!-- Secci√≥n de servicios -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 40px 0 30px 0;\">                                 <tr>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">ü§ñ</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Inteligencia Artificial</h4>                                         </div>                                     </td>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">üìä</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Marketing Digital</h4>                                         </div>                                     </td>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">üì±</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Redes Sociales</h4>                                         </div>                                     </td>                                 </tr>                             </table>                              <!-- Link al sitio web -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 30px 0;\">                                 <tr>                                     <td align=\"center\" style=\"background-color: #0a0a0a; padding: 20px; border-radius: 10px; border: 1px solid #333333;\">                                         <p style=\"margin: 0 0 10px 0; color: #ffffff; font-size: 15px;\">                                             üåê Conoce m√°s sobre nuestros servicios                                         </p>                                         <a href=\"https://www.your_brand.com.mx\" style=\"color: #00ffff; text-decoration: none; font-weight: 600; font-size: 16px; text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);\">                                             Vis√≠tanos aqu√≠ ‚Üí                                         </a>                                     </td>                                 </tr>                             </table>                          </td>                     </tr>                      <!-- Footer -->                     <tr>                         <td style=\"background-color: #000000; padding: 35px 30px; text-align: center; border-top: 2px solid #ff3232;\">                             <p style=\"margin: 0 0 15px 0; color: #ffffff; font-size: 16px; font-weight: 600;\">                                 Gracias por confiar en nosotros                             </p>                             <p style=\"margin: 0 0 20px 0; color: #00ffff; font-size: 15px;\">                                 your_name<br>                                 <span style=\"color: #999999; font-size: 13px;\">CEO de your_brand</span>                             </p>                             <div style=\"width: 60px; height: 2px; background: linear-gradient(90deg, transparent, #00ffff, transparent); margin: 20px auto;\"></div>                             <p style=\"margin: 0; color: #666666; font-size: 12px;\">                                 ¬© 2025 your_brand. Todos los derechos reservados.                             </p>                             <p style=\"margin: 15px 0 0 0;\">                                 <a href=\"https://www.your_brand.com.mx\" style=\"color: #00ffff; text-decoration: none; margin: 0 10px; font-size: 12px;\">Sitio Web</a>                                 <span style=\"color: #333333;\">|</span>                                 <a href=\"https://wa.me/your_phone_number?text=\" style=\"color: #00ffff; text-decoration: none; margin: 0 10px; font-size: 12px;\">WhatsApp</a>                             </p>                         </td>                     </tr>                  </table>             </td>         </tr>     </table> </body> </html>",
        "options": {
          "appendAttribution": false,
          "senderName": "your_name, CEO de your_brand"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        3472,
        -528
      ],
      "id": "98ce35bc-58c2-4228-a15d-390253e362e2",
      "name": "enviar_correo_cita_cancelada",
      "webhookId": "61a46709-2e59-4111-9e1c-426028790690",
      "alwaysOutputData": true,
      "credentials": {
        "gmailOAuth2": {
          "id": "your_gmail_credential_id",
          "name": "your_brand Nuevo"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "phoneNumberId": "710637588808362",
        "recipientPhoneNumber": "={{ $('parsear output a json').item.json.telefono_normalizado ?? $('When Executed by Another Workflow').item.json.telefono}}",
        "template": "cita_cancelada|es",
        "components": {
          "component": [
            {
              "bodyParameters": {
                "parameter": [
                  {
                    "text": "={{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}"
                  },
                  {
                    "text": "={{ $('parsear output a json').item.json.fecha_cita_timezone_legible_database }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        4144,
        -432
      ],
      "id": "2cf84bf4-a9dc-49d0-90a7-f628625473cc",
      "name": "cancelar_cita_wa",
      "webhookId": "53e8e612-3424-4d89-abec-23266c4eabbc",
      "alwaysOutputData": true,
      "credentials": {
        "whatsAppApi": {
          "id": "your_whatsapp_credential_id",
          "name": "WhatsApp account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "citas",
        "filters": {
          "conditions": [
            {
              "keyName": "client_id",
              "condition": "eq",
              "keyValue": "={{ $('When Executed by Another Workflow').item.json.client_id}}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "estado",
              "fieldValue": "cita pospuesta"
            },
            {
              "fieldId": "cancelado_por",
              "fieldValue": "={{ $('When Executed by Another Workflow').item.json.agente}}"
            },
            {
              "fieldId": "motivo_cancelacion",
              "fieldValue": "={{ $('parsear output a json').item.json.motivo_cancelacion}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3248,
        -144
      ],
      "id": "05e06668-60af-4aca-aec6-fd930c9d8db4",
      "name": "posponer cita",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "your_supabase_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "sendTo": "={{ $('parsear output a json').item.json.email_normalizado ?? $('When Executed by Another Workflow').item.json.email}}",
        "subject": "Cita Cancelada",
        "message": "=<!DOCTYPE html> <html lang=\"es\"> <head>     <meta charset=\"UTF-8\">     <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">     <title>Cita Pospuesta - your_brand</title> </head> <body style=\"margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0a0a0a;\">     <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #0a0a0a; padding: 20px;\">         <tr>             <td align=\"center\">                 <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #1a1a1a; border-radius: 15px; overflow: hidden; box-shadow: 0 0 30px rgba(255, 50, 50, 0.2); border: 1px solid #ff3232;\">                                          <!-- Header con logo y fondo decorativo -->                     <tr>                         <td style=\"background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); padding: 40px 30px; text-align: center; position: relative; border-bottom: 2px solid #ff3232;\">                                                          <!-- Logo -->                             <img src=\"https://ik.imagekit.io/49rd3bmeqs/Logos%20your_brand/logo2%20(3).png?updatedAt=1759468732222\" alt=\"your_brand Logo\" style=\"width: 120px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(255, 50, 50, 0.5));\" />                                                          <h1 style=\"margin: 0; color: #ff3232; font-size: 32px; font-weight: 700; text-shadow: 0 0 20px rgba(255, 50, 50, 0.8);\">                                 ‚úï Cita Cancelada                             </h1>                             <p style=\"margin: 10px 0 0 0; color: #ffffff; font-size: 16px;\">                                 Tu reuni√≥n ha sido cancelada                             </p>                         </td>                     </tr>                      <!-- Contenido principal -->                     <tr>                         <td style=\"padding: 40px 30px; background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);\">                             <p style=\"margin: 0 0 25px 0; color: #ffffff; font-size: 18px; line-height: 1.6;\">                                 Hola <strong style=\"color: #00ffff;\">{{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}</strong>,                             </p>                                                          <p style=\"margin: 0 0 30px 0; color: #e0e0e0; font-size: 16px; line-height: 1.6;\">                                 Lamentamos que su cita del <strong style=\"color: #ff3232;\">{{ $('parsear output a json').item.json.fecha_cita_timezone_legible_database }} </strong> haya sido pospuesta. Puede solicitar que se le agende una nueva cita cuando guste.                             </p>                              <!-- Bloque de informaci√≥n -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 30px 0;\">                                 <tr>                                     <td style=\"background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border-left: 4px solid #ff3232; padding: 25px; border-radius: 10px; box-shadow: 0 0 20px rgba(255, 50, 50, 0.15);\">                                         <h3 style=\"margin: 0 0 15px 0; color: #ff3232; font-size: 20px; display: flex; align-items: center;\">                                             üìÖ Informaci√≥n de la Cita                                         </h3>                                         <p style=\"margin: 0 0 10px 0; color: #ffffff; font-size: 15px; line-height: 1.6;\">                                             <strong style=\"color: #ff3232;\">Fecha Cancelada:</strong> {{ $('parsear output a json').item.json.fecha_cita_timezone_legible_database }}                                       </p>                                         <p style=\"margin: 0; color: #e0e0e0; font-size: 14px; line-height: 1.5;\">                                             <strong style=\"color: #00ffff;\">Estado:</strong> Cancelada                                         </p>                                     </td>                                 </tr>                             </table>                              <!-- Bot√≥n para agendar nueva cita -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 35px 0;\">                                 <tr>                                     <td align=\"center\">                                         <a href=\"https://wa.me/your_phone_number?text=\" style=\"display: inline-block; background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%); color: #000000; text-decoration: none; padding: 18px 45px; border-radius: 30px; font-size: 18px; font-weight: 700; box-shadow: 0 0 25px rgba(0, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 1px;\">                                             üìÜ Agendar Nueva Cita                                         </a>                                     </td>                                 </tr>                             </table>                              <!-- Secci√≥n de servicios -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 40px 0 30px 0;\">                                 <tr>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">ü§ñ</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Inteligencia Artificial</h4>                                         </div>                                     </td>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">üìä</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Marketing Digital</h4>                                         </div>                                     </td>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">üì±</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Redes Sociales</h4>                                         </div>                                     </td>                                 </tr>                             </table>                              <!-- Link al sitio web -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 30px 0;\">                                 <tr>                                     <td align=\"center\" style=\"background-color: #0a0a0a; padding: 20px; border-radius: 10px; border: 1px solid #333333;\">                                         <p style=\"margin: 0 0 10px 0; color: #ffffff; font-size: 15px;\">                                             üåê Conoce m√°s sobre nuestros servicios                                         </p>                                         <a href=\"https://www.your_brand.com.mx\" style=\"color: #00ffff; text-decoration: none; font-weight: 600; font-size: 16px; text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);\">                                             Vis√≠tanos aqu√≠ ‚Üí                                         </a>                                     </td>                                 </tr>                             </table>                          </td>                     </tr>                      <!-- Footer -->                     <tr>                         <td style=\"background-color: #000000; padding: 35px 30px; text-align: center; border-top: 2px solid #ff3232;\">                             <p style=\"margin: 0 0 15px 0; color: #ffffff; font-size: 16px; font-weight: 600;\">                                 Gracias por confiar en nosotros                             </p>                             <p style=\"margin: 0 0 20px 0; color: #00ffff; font-size: 15px;\">                                 your_name<br>                                 <span style=\"color: #999999; font-size: 13px;\">CEO de your_brand</span>                             </p>                             <div style=\"width: 60px; height: 2px; background: linear-gradient(90deg, transparent, #00ffff, transparent); margin: 20px auto;\"></div>                             <p style=\"margin: 0; color: #666666; font-size: 12px;\">                                 ¬© 2025 your_brand. Todos los derechos reservados.                             </p>                             <p style=\"margin: 15px 0 0 0;\">                                 <a href=\"https://www.your_brand.com.mx\" style=\"color: #00ffff; text-decoration: none; margin: 0 10px; font-size: 12px;\">Sitio Web</a>                                 <span style=\"color: #333333;\">|</span>                                 <a href=\"https://wa.me/your_phone_number?text=\" style=\"color: #00ffff; text-decoration: none; margin: 0 10px; font-size: 12px;\">WhatsApp</a>                             </p>                         </td>                     </tr>                  </table>             </td>         </tr>     </table> </body> </html>",
        "options": {
          "appendAttribution": false,
          "senderName": "your_name, CEO de your_brand"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        3472,
        -144
      ],
      "id": "062ebb19-d477-44df-9561-29d1b223a25c",
      "name": "enviar_correo_cita_pospuesta",
      "webhookId": "61a46709-2e59-4111-9e1c-426028790690",
      "alwaysOutputData": true,
      "credentials": {
        "gmailOAuth2": {
          "id": "your_gmail_credential_id",
          "name": "your_brand Nuevo"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "phoneNumberId": "710637588808362",
        "recipientPhoneNumber": "={{ $('parsear output a json').item.json.telefono_normalizado ?? $('When Executed by Another Workflow').item.json.telefono}}",
        "template": "cita_cancelada|es",
        "components": {
          "component": [
            {
              "bodyParameters": {
                "parameter": [
                  {
                    "text": "={{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}"
                  },
                  {
                    "text": "={{ $('parsear output a json').item.json.fecha_cita_timezone_legible_database }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        4144,
        -48
      ],
      "id": "b8f4b740-d576-4dce-a2bf-930ef850e5e5",
      "name": "posponer_cita_wa",
      "webhookId": "53e8e612-3424-4d89-abec-23266c4eabbc",
      "alwaysOutputData": true,
      "credentials": {
        "whatsAppApi": {
          "id": "your_whatsapp_credential_id",
          "name": "WhatsApp account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -496,
        272
      ],
      "id": "56093013-644f-41a4-827a-b67e2097828d",
      "name": "OpenAI Chat Model4",
      "credentials": {
        "openAiApi": {
          "id": "your_openai_credential_id",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('When Executed by Another Workflow').item.json.mensaje }}",
        "options": {
          "systemMessage": "=# CLASIFICADOR DE INTENCIONES - your_brand v2.1 (CORREGIDO)\n\n## IDENTIDAD Y OBJETIVO\nEres un **clasificador inteligente de intenciones comerciales** para **your_brand**, una agencia de marketing digital e inteligencia artificial.\n\nTu **√∫nica tarea** es clasificar el mensaje del cliente en **una sola categor√≠a** seg√∫n su intenci√≥n comercial espec√≠fica.\n\n---\n\n## ‚öôÔ∏è DATOS DE CONTEXTO\n\n**Historial completo de conversaciones previas (√∫ltimos 10 registros):**\n{{ $('extraer_clasificacion_anterior').item.json.resultado.historial_conversaciones || 'Sin historial previo' }}\n\n**Mensaje actual del cliente:**\n{{ $('When Executed by Another Workflow').item.json.mensaje }}\n\n**Fecha y hora actual del sistema:**\n{{ $now }}\n\n---\n\n## üö® DETECCI√ìN PRIORITARIA - ORDEN DE VALIDACI√ìN\n\n**ANTES DE CUALQUIER CLASIFICACI√ìN**, ejecuta estas validaciones en ORDEN ESTRICTO:\n\n### ‚ö° PRIORIDAD 1: CONTEXTO DE AGENDAMIENTO EN CONVERSACI√ìN ESTABLECIDA\n\n**VALIDAR PRIMERO (antes de evaluar nuevo lead):**\n\n```\nSI (historial tiene 3 o m√°s mensajes)\n  Y (√∫ltimos 3 mensajes del historial contienen: \"agendar\", \"cita\", \"reuni√≥n\", \"videollamada\", \"disponibilidad\", \"horario\", \"cu√°ndo pueden\", \"te gustar√≠a agendar\")\n  Y (mensaje_actual es respuesta afirmativa: \"s√≠\", \"claro\", \"perfecto\", \"me parece bien\", \"acepto\", \"dale\", \"ok\")\nENTONCES\n  return \"agendar_cita\"  ‚Üê SALIR INMEDIATAMENTE\nFIN SI\n```\n\n**‚ö†Ô∏è CR√çTICO:** Si el historial muestra que el AI pregunt√≥ sobre agendar y el cliente responde afirmativamente, es `agendar_cita` **SIEMPRE**, sin importar que sea una respuesta corta afirmativa.\n\n---\n\n### üÜï PRIORIDAD 2: DETECCI√ìN DE NUEVO LEAD\n\n**Solo despu√©s de validar que NO es contexto de agendamiento**, verifica si es nuevo lead:\n\n#### Condiciones para clasificar como `asesoria_de_ventas` (nuevo lead):\n\n**CASO 1: Respuesta afirmativa a plantilla de bienvenida SIN historial**\n- **Historial:** Vac√≠o, \"Sin historial previo\", o menos de 3 mensajes\n- **Mensaje actual contiene:**\n  - Exactamente: \"S√≠, estoy dispuesto!\" (mensaje del bot√≥n autom√°tico)\n  - Variaciones afirmativas: \"S√≠\", \"Si\", \"Claro\", \"Por supuesto\", \"Adelante\", \"Acepto\", \"Estoy interesado\", \"Me interesa\", \"Quiero\", \"Dale\", \"Ok\", \"Okay\", \"Definitivamente\", \"Seguro\"\n- **Y NO hay contexto de agendamiento** en el historial\n\n**CASO 2: Primera interacci√≥n detectada en historial corto**\n- **Historial:** Contiene SOLO la plantilla de bienvenida de your_brand (mensaje que menciona \"¬°Bienvenido a your_brand!\", \"¬øEstas dispuesto a CRECER tu negocio?\", \"AUTOMATIZAR con IA\")\n- **Mensaje actual:** Cualquier respuesta afirmativa del cliente\n- **Y NO hay menciones de \"agendar\", \"cita\", \"reuni√≥n\"** en la plantilla\n\n**Plantilla de bienvenida (para referencia):**\n```\n¬°Bienvenido a your_brand! Tu agencia de Marketing e IA\n¬°Gracias por tu inter√©s [nombre]!, hemos recibido tu informaci√≥n con √©xito y queremos platicar mas a fondo sobre tu empresa.\n¬°Estas a un paso del futuro!...ü¶ø\n¬øEstas dispuesto a CRECER tu negocio y AUTOMATIZAR con IA lo que todo mundo tarda horas en hacer?ü¶æ\n```\n\n### Proceso de validaci√≥n para nuevos leads:\n\n1. **Verifica que NO hay contexto de agendamiento previo:**\n   - Busca en √∫ltimos 3 mensajes: ¬øhay palabras \"agendar\", \"cita\", \"reuni√≥n\"?\n   - Si S√ç ‚Üí NO es nuevo lead, continuar an√°lisis\n\n2. **Verifica longitud del historial:**\n   - ¬øHay menos de 3 mensajes totales? ‚Üí Considerar nuevo lead\n   - ¬øSin historial previo? ‚Üí Definitivamente nuevo lead\n\n3. **Busca la plantilla de bienvenida en el historial:**\n   - ¬øAparece texto con \"Bienvenido a your_brand\"?\n   - ¬øMenciona \"CRECER tu negocio\" o \"AUTOMATIZAR con IA\"?\n   - ¬øEs el primer o √∫nico mensaje del sistema?\n\n4. **Analiza el mensaje actual:**\n   - ¬øEs \"S√≠, estoy dispuesto!\" exactamente? ‚Üí **asesoria_de_ventas**\n   - ¬øContiene respuesta afirmativa corta? ‚Üí **asesoria_de_ventas**\n   - ¬øEs m√°s elaborado pero afirmativo? ‚Üí Evaluar contexto\n\n---\n\n## üß© CATEGOR√çAS POSIBLES\n\nResponde **solo con una palabra** de las siguientes (en min√∫sculas, sin puntos ni explicaciones):\n\n- **agendar_cita** ‚Üê PRIORIDAD en conversaciones con contexto de agendamiento\n- **asesoria_de_ventas** ‚Üê PRIORIDAD para nuevos leads sin contexto de agendamiento\n- **cancelar_cita**\n- **posponer_cita**\n- **reagendar_cita**\n- **conocer_servicios**\n- **comprar**\n\n---\n\n## üß† DEFINICIONES DETALLADAS\n\n### üìÖ AGENDAR_CITA (PRIORIDAD M√ÅXIMA EN CONVERSACIONES ESTABLECIDAS)\n\nCliente desea **programar una nueva reuni√≥n/cita** con el equipo comercial de your_brand.\n\n**‚ö†Ô∏è IMPORTANTE:** Clasifica como `agendar_cita` si:\n- **Hay conversaci√≥n establecida** (3+ mensajes en historial)\n- **El historial menciona agendamiento** en los √∫ltimos 2-3 mensajes\n- Cliente responde afirmativamente a pregunta sobre agendar\n- Cliente solicita expl√≠citamente agendar/programar reuni√≥n\n\n**Incluye:**\n- Respuestas afirmativas a preguntas como \"¬øTe gustar√≠a agendar una cita?\"\n- \"S√≠, me parece perfecto\" (cuando el contexto previo es sobre agendar)\n- \"Claro, agendemos\" / \"Acepto la reuni√≥n\"\n- Solicitudes directas: \"Quiero agendar\", \"¬øCu√°ndo tienen disponibilidad?\"\n- \"¬øPodemos hablar por videollamada?\"\n- \"Me gustar√≠a una reuni√≥n para conocer sus servicios\"\n- Propone d√≠a y hora espec√≠fica para reunirse\n\n**Palabras clave:** agendar, programar, cita, reuni√≥n, videollamada, disponibilidad, apartar, cu√°ndo pueden, horario, junta\n\n**Diferencia cr√≠tica con nuevo lead:**\n- **Agendar:** Conversaci√≥n establecida + contexto de agendamiento + respuesta afirmativa\n- **Nuevo lead:** Sin historial o solo plantilla + respuesta afirmativa + SIN contexto de agendamiento\n\n---\n\n### ü§ù ASESORIA_DE_VENTAS\n\nCliente necesita **orientaci√≥n personalizada** para elegir qu√© servicio contratar, resolver dudas comerciales espec√≠ficas, **O ES UN NUEVO LEAD** respondiendo a la plantilla de bienvenida **sin contexto de agendamiento previo**.\n\n**Incluye (casos tradicionales):**\n- \"No s√© cu√°l servicio me conviene\"\n- \"¬øQu√© me recomiendan para mi negocio?\"\n- \"Necesito ayuda para elegir\"\n- \"¬øCu√°l es la diferencia entre X y Y?\"\n- \"¬øUstedes me pueden asesorar?\"\n- Dudas sobre comparaci√≥n de servicios\n- Solicita que un asesor lo contacte\n\n**Incluye (NUEVOS CASOS - solo si NO hay contexto de agendamiento):**\n- ‚úÖ Cliente responde \"S√≠, estoy dispuesto!\" sin historial previo\n- ‚úÖ Cliente responde afirmativamente a plantilla de bienvenida\n- ‚úÖ Primer contacto despu√©s de rellenar formulario META/Landing\n- ‚úÖ Respuestas cortas afirmativas en primeros 1-2 mensajes\n- ‚úÖ Cualquier mensaje positivo cuando SOLO hay plantilla de bienvenida en historial\n\n**NO incluye (diferencia clave):**\n- ‚ùå Respuesta afirmativa cuando el AI pregunt√≥ sobre agendar ‚Üí eso es `agendar_cita`\n- ‚ùå \"S√≠, perfecto\" despu√©s de \"¬øquieres agendar?\" ‚Üí eso es `agendar_cita`\n\n**Palabras clave nuevos leads:** S√≠ estoy dispuesto, s√≠, claro, por supuesto, adelante, acepto, me interesa, quiero, dale, ok, definitivamente (cuando NO hay historial o solo est√° la plantilla Y no hay contexto de agendamiento)\n\n---\n\n### ‚ùå CANCELAR_CITA\nCliente desea **eliminar/cancelar** una cita/reuni√≥n que ya ten√≠a agendada.\n\n**Incluye:**\n- \"Quiero cancelar mi cita\"\n- \"Ya no puedo asistir a la reuni√≥n\"\n- \"Necesito cancelar\"\n- \"No voy a poder ir\"\n- Solicita eliminar una cita existente sin intenci√≥n inmediata de reagendar\n\n**Palabras clave:** cancelar, eliminar cita, ya no puedo, no voy a poder, borrar cita, dar de baja reuni√≥n\n\n---\n\n### ‚è∏Ô∏è POSPONER_CITA\nCliente desea **dejar la cita para despu√©s** sin una fecha espec√≠fica nueva en ese momento.\n\n**Incluye:**\n- \"¬øPodemos dejar la cita para despu√©s?\"\n- \"Quiero posponer mi reuni√≥n\"\n- \"Mejor en otro momento\"\n- \"Voy a reagendar pero a√∫n no s√© cu√°ndo\"\n- \"Surgi√≥ algo, lo dejamos pendiente\"\n\n**Palabras clave:** posponer, dejar para despu√©s, pendiente, m√°s adelante, otro momento, no ahora\n\n---\n\n### üîÑ REAGENDAR_CITA\nCliente desea **cambiar la fecha/hora** de una cita existente por una nueva fecha espec√≠fica.\n\n**Incluye:**\n- \"Quiero cambiar mi cita del viernes al lunes\"\n- \"¬øPuedo mover mi reuni√≥n?\"\n- \"Mejor el martes en lugar del jueves\"\n- \"Cambiar hora de 3 PM a 5 PM\"\n- \"Reprogramar para otra fecha\"\n\n**Palabras clave:** cambiar, mover, reprogramar, reagendar, modificar fecha, cambiar hora, en lugar de\n\n---\n\n### üìö CONOCER_SERVICIOS\nCliente busca **informaci√≥n general** sobre los servicios de your_brand sin intenci√≥n inmediata de compra o agenda.\n\n**‚ö†Ô∏è IMPORTANTE:** Solo clasifica como `conocer_servicios` si:\n- **NO es un nuevo lead** respondiendo a plantilla de bienvenida\n- Hay historial de conversaci√≥n establecido\n- Pregunta es exploratoria sin compromiso\n- **NO hay contexto de agendamiento** en mensajes previos\n\n**Incluye:**\n- \"¬øQu√© servicios ofrecen?\"\n- \"¬øEn qu√© nos pueden ayudar?\"\n- \"Cu√©ntame sobre sus soluciones\"\n- Preguntas sobre Marketing Digital, IA, Desarrollo Web, Consultor√≠a, Capacitaci√≥n\n- \"¬øC√≥mo funciona su servicio de chatbots?\"\n- \"¬øQu√© incluye el paquete de SEO?\"\n- Preguntas exploratorias sin compromiso\n\n**Palabras clave:** qu√© ofrecen, cu√°les servicios, en qu√© ayudan, qu√© hacen, informaci√≥n sobre, cu√©ntame de, c√≥mo funciona, qu√© incluye\n\n---\n\n### üí∞ COMPRAR\nCliente tiene **intenci√≥n clara de contratar/comprar** un servicio espec√≠fico de your_brand.\n\n**Incluye:**\n- \"Quiero contratar el servicio de SEO\"\n- \"¬øCu√°nto cuesta el desarrollo de una app?\"\n- \"Me interesa comprar el paquete de marketing\"\n- \"¬øCu√°l es el precio?\"\n- \"¬øTienen planes/paquetes?\"\n- \"Quiero el servicio de chatbot\"\n- Solicitudes de cotizaci√≥n, presupuesto, precios\n\n**Palabras clave:** comprar, contratar, precio, costo, cotizaci√≥n, presupuesto, paquete, plan, cu√°nto cuesta, adquirir, me interesa [servicio espec√≠fico]\n\n---\n\n## üîÑ AN√ÅLISIS CON MEMORIA CONVERSACIONAL\n\n### PASO 0: DETECCI√ìN PRIORITARIA (EJECUTAR PRIMERO)\n\n```javascript\n// VALIDACI√ìN 1: ¬øHay contexto de agendamiento en conversaci√≥n establecida?\nSI (longitud_historial >= 3)\n  Y (ultimos_3_mensajes contienen [\"agendar\", \"cita\", \"reuni√≥n\", \"videollamada\", \"disponibilidad\", \"te gustar√≠a agendar\"])\n  Y (mensaje_actual es_respuesta_afirmativa)\nENTONCES\n  return \"agendar_cita\"  ‚Üê SALIR INMEDIATAMENTE\nFIN SI\n\n// VALIDACI√ìN 2: ¬øEs nuevo lead SIN contexto de agendamiento?\nSI (historial == \"Sin historial previo\" O longitud_historial <= 2)\n  Y (mensaje_actual es_respuesta_afirmativa_simple)\n  Y (historial NO contiene [\"agendar\", \"cita\", \"reuni√≥n\"])\nENTONCES\n  return \"asesoria_de_ventas\"  ‚Üê SALIR INMEDIATAMENTE\nFIN SI\n\n// VALIDACI√ìN 3: ¬øSolo hay plantilla de bienvenida?\nSI (historial contiene SOLO plantilla_bienvenida_your_brand)\n  Y (mensaje_actual es_respuesta_afirmativa)\n  Y (plantilla NO menciona \"agendar\" ni \"cita\")\nENTONCES\n  return \"asesoria_de_ventas\"  ‚Üê SALIR INMEDIATAMENTE\nFIN SI\n\n// Si no cumple ninguna condici√≥n prioritaria, continuar con an√°lisis tradicional\nCONTINUAR_ANALISIS_TRADICIONAL()\n```\n\n---\n\n## üîç AN√ÅLISIS DE HISTORIAL (si no se activ√≥ detecci√≥n prioritaria)\n\n**CR√çTICO:** El historial muestra el flujo real de la conversaci√≥n con formato:\n```\n#ID [tipo] mensaje | Clasificaci√≥n: clasificacion_anterior\n```\n\n### C√≥mo interpretar el historial:\n\n**Estructura:**\n- `#ID` = N√∫mero de registro (mayor = m√°s reciente)\n- `[ai]` = Respuesta del sistema/clasificaci√≥n anterior\n- `[human]` = Mensaje del cliente\n- `| Clasificaci√≥n:` = Clasificaci√≥n que se le dio a ese mensaje\n\n### Proceso de an√°lisis (6 pasos):\n\n1. **PRIMERO:** Detecta contexto de agendamiento en √∫ltimos 3 mensajes\n2. **SEGUNDO:** Detecta si es nuevo lead sin contexto de agendamiento\n3. **Lee el historial COMPLETO** desde el mensaje m√°s antiguo (#ID menor) al m√°s reciente (#ID mayor)\n4. **Identifica el tema central** y la evoluci√≥n de la intenci√≥n del cliente\n5. **Detecta si hay citas mencionadas** en mensajes previos\n6. **Analiza el mensaje actual** considerando todo el contexto previo\n\n---\n\n## üìã EJEMPLOS CR√çTICOS CON FORMATO REAL\n\n### ‚úÖ EJEMPLO 1: AGENDAR_CITA (TU CASO - AHORA CORREGIDO)\n\n**Historial:**\n```\n#2638 [ai] ¬øTe gustar√≠a agendar una cita para discutirlo m√°s a fondo? Las videollamadas son de lunes a viernes, de 9am a 5pm. | Clasificaci√≥n: conocer_servicios\n\n#2639 [human] Si me parece perfecto gracias | Clasificaci√≥n: asesoria_de_ventas\n\n#2640 [ai] ¬°Excelente decisi√≥n! üéâ Te voy a pasar con nuestro Agente de Agendamiento de your_brand... | Clasificaci√≥n: asesoria_de_ventas\n```\n\n**Mensaje actual:**\n```\nSi me parece perfecto gracias\n```\n\n**An√°lisis CORREGIDO:**\n1. ‚úÖ Longitud historial = 4 mensajes (>= 3)\n2. ‚úÖ Mensaje #2638 contiene \"¬øTe gustar√≠a **agendar una cita**?\"\n3. ‚úÖ Mensaje actual es afirmativo: \"Si me parece perfecto\"\n4. üö® **DETECCI√ìN PRIORITARIA activada**\n5. Cliente est√° aceptando agendar la cita mencionada en #2638\n\n**Output:** `agendar_cita` ‚úÖ\n\n**Raz√≥n:** Aunque es respuesta afirmativa corta, el CONTEXTO del historial muestra que el AI pregunt√≥ sobre agendar, por lo tanto es `agendar_cita`, NO `asesoria_de_ventas`.\n\n---\n\n### ‚úÖ EJEMPLO 2: NUEVO LEAD sin contexto de agendamiento\n\n**Historial:**\n```\nSin historial previo\n```\n\n**Mensaje actual:**\n```\nS√≠, estoy dispuesto!\n```\n\n**An√°lisis:**\n1. ‚úÖ Sin historial previo\n2. ‚úÖ Mensaje exacto del bot√≥n autom√°tico\n3. ‚ùå NO hay contexto de agendamiento\n4. üö® Es nuevo lead\n\n**Output:** `asesoria_de_ventas` ‚úÖ\n\n---\n\n### ‚úÖ EJEMPLO 3: NUEVO LEAD con plantilla simple\n\n**Historial:**\n```\n#1 [ai] ¬°Bienvenido a your_brand! Tu agencia de Marketing e IA. ¬øEst√°s dispuesto a CRECER tu negocio y AUTOMATIZAR con IA?\n```\n\n**Mensaje actual:**\n```\nClaro que s√≠\n```\n\n**An√°lisis:**\n1. ‚úÖ Historial contiene SOLO plantilla de bienvenida\n2. ‚úÖ Respuesta afirmativa corta (\"Claro que s√≠\")\n3. ‚ùå Plantilla NO menciona \"agendar\" ni \"cita\"\n4. üö® Es primer contacto activo del cliente\n\n**Output:** `asesoria_de_ventas` ‚úÖ\n\n---\n\n### ‚úÖ EJEMPLO 4: CONVERSACI√ìN establecida - respuesta \"S√≠\" a pregunta de agendar\n\n**Historial:**\n```\n#100 [human] ¬øQu√© servicios ofrecen?\n#101 [ai] Ofrecemos Marketing Digital, IA... | Clasificaci√≥n: conocer_servicios\n#102 [human] Me interesa el SEO\n#103 [ai] El SEO incluye... | Clasificaci√≥n: conocer_servicios\n#104 [ai] ¬øTe gustar√≠a agendar una reuni√≥n para discutir tu proyecto?\n```\n\n**Mensaje actual:**\n```\nS√≠\n```\n\n**An√°lisis:**\n1. ‚úÖ Historial largo (5 mensajes)\n2. ‚úÖ Mensaje #104 pregunta \"¬øTe gustar√≠a **agendar una reuni√≥n**?\"\n3. ‚úÖ \"S√≠\" es respuesta afirmativa\n4. üö® **DETECCI√ìN PRIORITARIA: contexto de agendamiento**\n\n**Output:** `agendar_cita` ‚úÖ\n\n**NO es `asesoria_de_ventas`** porque hay conversaci√≥n establecida y contexto de agendamiento.\n\n---\n\n### ‚úÖ EJEMPLO 5: NUEVO LEAD intentando agendar directamente\n\n**Historial:**\n```\nSin historial previo\n```\n\n**Mensaje actual:**\n```\nS√≠, quiero agendar una cita\n```\n\n**An√°lisis:**\n1. ‚úÖ Sin historial = nuevo lead\n2. ‚ö†Ô∏è Mensaje contiene \"agendar\" PERO es primer mensaje\n3. ‚ùå NO hay conversaci√≥n previa sobre agendamiento\n4. üö® Cliente est√° empezando contacto, necesita asesor√≠a inicial\n\n**Output:** `asesoria_de_ventas` ‚úÖ\n\n**Raz√≥n:** Aunque menciona \"agendar\", es un nuevo lead sin contexto. Primero necesita pasar por asesor√≠a inicial antes de agendar formalmente.\n\n---\n\n### ‚úÖ EJEMPLO 6: CANCELAR_CITA (con contexto de cita existente)\n\n**Historial:**\n```\n#200 [human] Quiero agendar para el viernes\n#201 [ai] Perfecto, cita agendada viernes 3PM | Clasificaci√≥n: agendar_cita\n#202 [human] Gracias\n#203 [ai] De nada, te esperamos el viernes\n```\n\n**Mensaje actual:**\n```\nNecesito cancelar\n```\n\n**An√°lisis:**\n1. ‚ùå NO es nuevo lead (4 mensajes)\n2. ‚ùå NO hay contexto de agendamiento en √∫ltimos mensajes\n3. ‚úÖ Historial muestra: \"cita agendada viernes 3PM\" (#201)\n4. ‚úÖ Cliente YA TIENE cita confirmada\n5. ‚úÖ \"Necesito cancelar\" sin mencionar reagendar\n\n**Output:** `cancelar_cita` ‚úÖ\n\n---\n\n### ‚úÖ EJEMPLO 7: COMPRAR (evoluci√≥n natural)\n\n**Historial:**\n```\n#500 [human] ¬øOfrecen chatbots?\n#501 [ai] S√≠, chatbots con IA | Clasificaci√≥n: conocer_servicios\n#502 [human] ¬øC√≥mo funcionan?\n#503 [ai] Explicaci√≥n t√©cnica | Clasificaci√≥n: conocer_servicios\n```\n\n**Mensaje actual:**\n```\n¬øCu√°nto cuesta?\n```\n\n**An√°lisis:**\n1. ‚ùå NO es nuevo lead (4 mensajes)\n2. ‚ùå NO hay contexto de agendamiento\n3. ‚úÖ Evoluci√≥n: pregunta general ‚Üí detalles ‚Üí PRECIO\n4. ‚úÖ \"¬øCu√°nto cuesta?\" = intenci√≥n de compra\n\n**Output:** `comprar` ‚úÖ\n\n---\n\n## üß≠ CRITERIOS DE DECISI√ìN (ORDEN DE PRIORIDAD CORREGIDO)\n\n### PRIORIDAD 1: CONTEXTO DE AGENDAMIENTO EN CONVERSACI√ìN ESTABLECIDA\n- ¬øHistorial >= 3 mensajes?\n- ¬ø√öltimos 2-3 mensajes mencionan \"agendar\", \"cita\", \"reuni√≥n\"?\n- ¬øMensaje actual es afirmativo?\n- ‚Üí `agendar_cita`\n\n### PRIORIDAD 2: DETECCI√ìN DE NUEVO LEAD\n- ¬øHistorial vac√≠o o <= 2 mensajes?\n- ¬øMensaje es respuesta afirmativa?\n- ¬øNO hay contexto de agendamiento en historial?\n- ‚Üí `asesoria_de_ventas`\n\n### PRIORIDAD 3: ESTADO DE CITAS\n- ¬øSe mencion√≥ alguna cita agendada en el historial?\n- ‚Üí puede ser cancelar/posponer/reagendar\n\n### PRIORIDAD 4: INTENCI√ìN COMERCIAL CLARA\n- \"¬øCu√°nto cuesta?\" ‚Üí `comprar`\n- \"¬øQu√© me conviene?\" ‚Üí `asesoria_de_ventas`\n- \"¬øQu√© ofrecen?\" ‚Üí `conocer_servicios`\n\n---\n\n## ‚úÖ REGLAS DE RESPUESTA\n\n- Responde **√∫nicamente con una de estas palabras:**\n```\n  agendar_cita         ‚Üê PRIORIDAD 1 si hay contexto de agendamiento\n  asesoria_de_ventas   ‚Üê PRIORIDAD 2 para nuevos leads sin contexto agendamiento\n  cancelar_cita\n  posponer_cita\n  reagendar_cita\n  conocer_servicios\n  comprar\n```\n- **No agregues puntos, explicaciones, comillas ni emojis**\n- Usa **solo min√∫sculas**\n- **PRIMERO verifica contexto de agendamiento en conversaciones establecidas**\n- **SEGUNDO verifica si es nuevo lead sin contexto de agendamiento**\n- **Lee TODO el historial** antes de clasificar\n- Si hay duda entre categor√≠as, elige la **m√°s espec√≠fica seg√∫n el contexto**\n\n---\n\n## üî¨ FLUJO DE DECISI√ìN SIMPLIFICADO\n\n```\nINICIO\n‚îÇ\n‚îú‚îÄ‚Üí PASO 1: ¬øHistorial >= 3 mensajes Y √∫ltimos mensajes mencionan \"agendar/cita/reuni√≥n\"?\n‚îÇ   ‚îî‚îÄ‚Üí S√ç ‚Üí ¬øMensaje actual es afirmativo?\n‚îÇ          ‚îî‚îÄ‚Üí S√ç ‚Üí OUTPUT: agendar_cita ‚úì (SALIR)\n‚îÇ          ‚îî‚îÄ‚Üí NO ‚Üí Continuar\n‚îÇ   ‚îî‚îÄ‚Üí NO ‚Üí Continuar\n‚îÇ\n‚îú‚îÄ‚Üí PASO 2: ¬øHistorial vac√≠o/<= 2 mensajes Y mensaje afirmativo Y NO hay contexto agendamiento?\n‚îÇ   ‚îî‚îÄ‚Üí S√ç ‚Üí OUTPUT: asesoria_de_ventas ‚úì (SALIR)\n‚îÇ   ‚îî‚îÄ‚Üí NO ‚Üí Continuar\n‚îÇ\n‚îú‚îÄ‚Üí PASO 3: ¬øSolo plantilla bienvenida Y mensaje afirmativo Y plantilla NO menciona agendar?\n‚îÇ   ‚îî‚îÄ‚Üí S√ç ‚Üí OUTPUT: asesoria_de_ventas ‚úì (SALIR)\n‚îÇ   ‚îî‚îÄ‚Üí NO ‚Üí Continuar\n‚îÇ\n‚îú‚îÄ‚Üí PASO 4: ¬øHay cita confirmada en historial?\n‚îÇ   ‚îî‚îÄ‚Üí S√ç ‚Üí ¬øQuiere cancelar/cambiar/posponer?\n‚îÇ          ‚îî‚îÄ‚Üí Cancelar ‚Üí OUTPUT: cancelar_cita ‚úì\n‚îÇ          ‚îî‚îÄ‚Üí Posponer ‚Üí OUTPUT: posponer_cita ‚úì\n‚îÇ          ‚îî‚îÄ‚Üí Cambiar fecha ‚Üí OUTPUT: reagendar_cita ‚úì\n‚îÇ   ‚îî‚îÄ‚Üí NO ‚Üí Continuar\n‚îÇ\n‚îú‚îÄ‚Üí PASO 5: ¬øSolicita nueva cita/reuni√≥n sin tener contexto previo?\n‚îÇ   ‚îî‚îÄ‚Üí S√ç ‚Üí OUTPUT: agendar_cita ‚úì\n‚îÇ   ‚îî‚îÄ‚Üí NO ‚Üí Continuar\n‚îÇ\n‚îú‚îÄ‚Üí PASO 6: ¬øPide precios o dice \"quiero contratar\"?\n‚îÇ   ‚îî‚îÄ‚Üí S√ç ‚Üí OUTPUT: comprar ‚úì\n‚îÇ   ‚îî‚îÄ‚Üí NO ‚Üí Continuar\n‚îÇ\n‚îú‚îÄ‚Üí PASO 7: ¬øPide ayuda para decidir qu√© contratar?\n‚îÇ   ‚îî‚îÄ‚Üí S√ç ‚Üí OUTPUT: asesoria_de_ventas ‚úì\n‚îÇ   ‚îî‚îÄ‚Üí NO ‚Üí Continuar\n‚îÇ\n‚îî‚îÄ‚Üí PASO 8: ¬øPregunta exploratoria general?\n    ‚îî‚îÄ‚Üí S√ç ‚Üí OUTPUT: conocer_servicios ‚úì\n    ‚îî‚îÄ‚Üí NO ‚Üí OUTPUT: asesoria_de_ventas (predeterminado) ‚úì\n```\n\n---\n\n## üîç VALIDACI√ìN FINAL\n\nAntes de responder, confirma:\n\n- ‚úÖ **PASO 1**: ¬øVerificaste si hay contexto de agendamiento en los √∫ltimos 3 mensajes?\n- ‚úÖ **PASO 2**: Si hay contexto de agendamiento + respuesta afirmativa, ¬øclasificaste como `agendar_cita`?\n- ‚úÖ **PASO 3**: ¬øVerificaste si es un NUEVO LEAD sin contexto de agendamiento?\n- ‚úÖ Si es nuevo lead sin contexto de agendamiento, ¬øclasificaste como `asesoria_de_ventas`?\n- ‚úÖ Le√≠ste **TODO el historial** desde el mensaje m√°s antiguo al m√°s reciente\n- ‚úÖ Identificaste si hay **menciones de citas agendadas** en el historial\n- ‚úÖ Entendiste la **evoluci√≥n natural** de la conversaci√≥n\n- ‚úÖ El mensaje actual tiene **coherencia** con el flujo conversacional\n- ‚úÖ Elegiste la categor√≠a **m√°s espec√≠fica** seg√∫n el contexto completo\n- ‚úÖ Tu respuesta es **solo una palabra**\n- ‚úÖ Est√° **en min√∫sculas**\n- ‚úÖ **No contiene puntuaci√≥n, espacios extras ni emojis**\n- ‚úÖ Es una de las **7 categor√≠as v√°lidas**\n\n---\n\n## üìä TABLA DE DECISI√ìN R√ÅPIDA\n\n| Contexto | Historial | Mensaje | Clasificaci√≥n |\n|----------|-----------|---------|---------------|\n| Conversaci√≥n + \"¬øquieres agendar?\" | 3+ mensajes con \"agendar/cita\" | \"S√≠\" / \"Perfecto\" | ‚úÖ **agendar_cita** |\n| Sin historial | Vac√≠o o <= 2 mensajes | \"S√≠, estoy dispuesto!\" | ‚úÖ **asesoria_de_ventas** |\n| Solo plantilla bienvenida | 1 mensaje (plantilla) | \"Claro\" / \"S√≠\" | ‚úÖ **asesoria_de_ventas** |\n| Nuevo lead | Sin historial | \"Quiero agendar\" | ‚úÖ **asesoria_de_ventas** |\n| Conversaci√≥n sin agendar | 5+ mensajes | \"¬øCu√°ndo pueden?\" | ‚úÖ **agendar_cita** |\n| Cita confirmada | Historial con cita | \"Cancelar\" | ‚úÖ **cancelar_cita** |\n| Exploraci√≥n | 3+ mensajes | \"¬øCu√°nto cuesta?\" | ‚úÖ **comprar** |\n\n---\n\n## ‚ö†Ô∏è CASOS CR√çTICOS DE ERROR COM√öN\n\n### ‚ùå ERROR: Clasificar como `asesoria_de_ventas` cuando deber√≠a ser `agendar_cita`\n\n**Escenario problem√°tico:**\n```\nHistorial: [AI pregunta \"¬øTe gustar√≠a agendar?\"]\nMensaje: \"S√≠, me parece perfecto\"\nClasificaci√≥n incorrecta: asesoria_de_ventas ‚ùå\n```\n\n**Clasificaci√≥n correcta:** `agendar_cita` ‚úÖ\n\n**Raz√≥n del error:** \n- El clasificador detecta \"respuesta afirmativa corta\"\n- Activa regla de \"nuevo lead\"\n- Ignora el contexto de agendamiento\n\n**C√≥mo evitarlo:**\n- SIEMPRE verificar PRIMERO si hay contexto de agendamiento\n- La detecci√≥n de nuevo lead es SECUNDARIA\n\n---\n\n## üéì RESUMEN EJECUTIVO PARA EL CLASIFICADOR\n\n**ORDEN DE PRIORIDAD DE VALIDACI√ìN:**\n\n**PRIORIDAD 1: CONTEXTO DE AGENDAMIENTO EN CONVERSACI√ìN ESTABLECIDA**\n- Historial >= 3 mensajes + √∫ltimos mensajes mencionan \"agendar/cita/reuni√≥n\" + respuesta afirmativa = `agendar_cita`\n- **Esto tiene prioridad sobre TODO**, incluso sobre respuestas afirmativas cortas\n\n**PRIORIDAD 2: NUEVO LEAD SIN CONTEXTO DE AGENDAMIENTO**\n- Historial vac√≠o/corto (<3 mensajes) + respuesta afirmativa + NO hay contexto agendamiento = `asesoria_de_ventas`\n- Solo plantilla de bienvenida + respuesta afirmativa + plantilla NO menciona agendar = `asesoria_de_ventas`\n- \"S√≠, estoy dispuesto!\" en primeros mensajes = `asesoria_de_ventas`\n\n**PRIORIDAD 3: GESTI√ìN DE CITAS EXISTENTES**\n- Cita confirmada en historial + \"cancelar\" = `cancelar_cita`\n- Cita confirmada + \"posponer/despu√©s\" = `posponer_cita`\n- Cita confirmada + fecha nueva = `reagendar_cita`\n\n**PRIORIDAD 4: SOLICITUD DE CITA NUEVA (sin contexto previo)**\n- Sin cita previa + \"agendar/reuni√≥n\" directa = `agendar_cita`\n- (Excepto si es nuevo lead sin historial ‚Üí `asesoria_de_ventas`)\n\n**PRIORIDAD 5: INTENCI√ìN COMERCIAL CLARA**\n- \"¬øCu√°nto cuesta?\" / \"quiero contratar\" = `comprar`\n- \"¬øQu√© me conviene?\" / \"ay√∫denme a elegir\" = `asesoria_de_ventas`\n- \"¬øQu√© ofrecen?\" = `conocer_servicios`\n\n---\n\n## üö® REGLA DE ORO ACTUALIZADA\n\n```\nSI existe_contexto_agendamiento_en_historial:\n    clasificar seg√∫n ese contexto (probablemente agendar_cita)\nSI NO:\n    SI es_nuevo_lead:\n        clasificar como asesoria_de_ventas\n    SI NO:\n        analizar intenci√≥n espec√≠fica del mensaje\n```\n\n**El contexto de agendamiento siempre gana sobre la detecci√≥n de nuevo lead.**\n\n---\n\n## üìå RECORDATORIOS FINALES\n\n1. **Lee los √∫ltimos 3 mensajes del historial PRIMERO** buscando palabras: \"agendar\", \"cita\", \"reuni√≥n\", \"videollamada\", \"disponibilidad\", \"te gustar√≠a agendar\"\n\n2. **Si encuentras esas palabras Y el mensaje actual es afirmativo** ‚Üí `agendar_cita` inmediatamente\n\n3. **Solo si NO hay contexto de agendamiento**, entonces eval√∫a si es nuevo lead\n\n4. **Nuevo lead CON palabra \"agendar\"** en su primer mensaje ‚Üí sigue siendo `asesoria_de_ventas` (necesita asesor√≠a inicial)\n\n5. **Conversaci√≥n establecida CON contexto de agendamiento** + respuesta afirmativa ‚Üí `agendar_cita` siempre\n\n---\n\n**Ahora clasifica el mensaje actual considerando TODO el contexto del historial y PRIORIZANDO el contexto de agendamiento sobre la detecci√≥n de nuevo lead.**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -560,
        48
      ],
      "id": "03df8bb6-92a9-4d9b-9903-8cbebf16a17c",
      "name": "clasifcador",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// VALIDADOR DE CATEGOR√çAS - your_brand\n// Asegura que el agente clasificador devuelva solo una categor√≠a v√°lida\n// ========================================\n\n// Obtener la respuesta del agente clasificador\nconst respuestaAgente = $input.first().json.output || \n                        $input.first().json.response || \n                        $input.first().json.text || \n                        $input.first().json.clasificacion ||\n                        '';\n\n// Categor√≠as v√°lidas permitidas (exactamente como las definiste)\nconst categoriasValidas = [\n  'agendar_cita',\n  'cancelar_cita',\n  'posponer_cita',\n  'reagendar_cita',\n  'conocer_servicios',\n  'comprar',\n  'asesoria_de_ventas'\n];\n\n// Limpiar y normalizar la respuesta del agente\n// Convierte a min√∫sculas y elimina espacios, puntos, comillas, etc.\nlet respuestaLimpia = respuestaAgente\n  .toLowerCase()\n  .trim()\n  .replace(/[^a-z√°√©√≠√≥√∫√±_]/g, ''); // Mantiene letras y gui√≥n bajo\n\n// Buscar si alguna categor√≠a v√°lida est√° en la respuesta\nlet categoriaFinal = null;\n\nfor (const categoria of categoriasValidas) {\n  // Eliminar guiones bajos para comparaci√≥n flexible\n  const categoriaLimpia = categoria.replace(/_/g, '');\n  const respuestaSinGuiones = respuestaLimpia.replace(/_/g, '');\n  \n  // Verificar coincidencia exacta primero\n  if (respuestaLimpia === categoria) {\n    categoriaFinal = categoria;\n    break;\n  }\n  \n  // Verificar coincidencia sin guiones\n  if (respuestaSinGuiones === categoriaLimpia) {\n    categoriaFinal = categoria;\n    break;\n  }\n  \n  // Verificar si la categor√≠a est√° contenida en la respuesta\n  if (respuestaLimpia.includes(categoria)) {\n    categoriaFinal = categoria;\n    break;\n  }\n}\n\n// Si no se encontr√≥ ninguna categor√≠a v√°lida, usar valor por defecto\nif (!categoriaFinal) {\n  // Intenta detectar palabras clave para asignar categor√≠a m√°s probable\n  const palabrasClave = {\n    'agendar_cita': ['agendar', 'cita', 'reunion', 'programar', 'apartar'],\n    'cancelar_cita': ['cancelar', 'eliminar', 'borrar'],\n    'posponer_cita': ['posponer', 'despues', 'pendiente'],\n    'reagendar_cita': ['reagendar', 'cambiar', 'mover', 'reprogramar'],\n    'conocer_servicios': ['conocer', 'servicios', 'informacion', 'que'],\n    'comprar': ['comprar', 'precio', 'costo', 'contratar', 'cotizacion'],\n    'asesoria_de_ventas': ['asesoria', 'ayuda', 'recomienda', 'conviene']\n  };\n  \n  for (const [categoria, palabras] of Object.entries(palabrasClave)) {\n    if (palabras.some(palabra => respuestaLimpia.includes(palabra))) {\n      categoriaFinal = categoria;\n      break;\n    }\n  }\n  \n  // Si a√∫n no hay categor√≠a, usar fallback\n  if (!categoriaFinal) {\n    categoriaFinal = 'conocer_servicios'; // Fallback m√°s gen√©rico\n  }\n}\n\n// Registro para debugging (opcional, comentar en producci√≥n)\nconsole.log('Respuesta original:', respuestaAgente);\nconsole.log('Respuesta limpia:', respuestaLimpia);\nconsole.log('Categor√≠a final:', categoriaFinal);\n\n// Retornar solo la categor√≠a v√°lida\nreturn {\n  json: {\n    categoria: categoriaFinal,\n    respuesta_original: respuestaAgente,\n    es_valida: categoriasValidas.includes(categoriaFinal),\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        48
      ],
      "id": "a13ebe6a-2474-44cd-9c9b-b955b5a5980c",
      "name": "parsear respuesta agente"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $('parsear output a json').item.json.respuesta }}"
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('When Executed by Another Workflow').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3024,
        -1296
      ],
      "id": "7c8d6a94-2fef-417b-88f5-72556d8e5c68",
      "name": "contestar agendamiento",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow').item.json.conversationId }}/labels",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "labels",
              "value": "={{ Array('ventas') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        928,
        432
      ],
      "id": "c3086efc-34bd-49fd-a6e8-e9b8cb676b77",
      "name": "etiqueta nueva venta clientes1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('When Executed by Another Workflow').item.json.client_id }}",
        "tableName": "conversaciones",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        592,
        848
      ],
      "id": "4f937799-0d4c-43dd-83c0-c3209ffc657d",
      "name": "Postgres Chat Memory2",
      "credentials": {
        "postgres": {
          "id": "your_postgres_credential_id",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3914de67-5743-4f05-b235-2b571a569e40",
              "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
              "rightValue": "=reagendar_cita",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "305c1ffb-7bd8-4f9a-adc0-ce1352284db8",
              "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
              "rightValue": "agendar_cita",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "1cc87bbd-1a85-4c41-bf0e-2bee51bbe6c2",
              "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
              "rightValue": "cancelar_cita",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "3c47894d-8e53-4585-9127-7d778021b03e",
              "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
              "rightValue": "posponer_cita",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "021903e6-552f-4bb6-99bb-b34b7b4e150e",
              "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
              "rightValue": "comprar",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        16,
        48
      ],
      "id": "29be7abd-efac-4601-8b5c-34534262a800",
      "name": "If1"
    },
    {
      "parameters": {
        "jsCode": "// ====================================\n// NORMALIZADOR N8N v2.0.3 - TIMEZONE CORREGIDO\n// ====================================\n\nconst agentOutput = $input.first().json.output;\n\n// ====================================\n// OBTENER FECHAS DE BASE DE DATOS - DESDE MERGE\n// ====================================\nlet fechaCitaDatabase = \"\";\nlet fechaCitaTimezoneDatabase = \"\";\n\ntry {\n  const inputData = $input.first().json;\n  // Las fechas vienen directamente del merge (no del output del agente)\n  // Estas son las fechas ORIGINALES de la base de datos\n  fechaCitaDatabase = inputData.fecha_cita || \"\";\n  fechaCitaTimezoneDatabase = inputData.fecha_cita_timezone_cliente || \"\";\n} catch (e) {\n  // Continuar sin fechas de DB\n}\n\n// ====================================\n// FUNCIONES DE NORMALIZACI√ìN\n// ====================================\n\nfunction formatearFechaLegible(fechaISO, timeZone = 'America/Mexico_City') {\n  // Retorno inmediato para valores inv√°lidos\n  if (!fechaISO || fechaISO === \"null\" || fechaISO === \"undefined\" || fechaISO === \"\") {\n    return \"\";\n  }\n  \n  try {\n    // Si la fecha NO tiene timezone (ej: \"2025-12-30T10:00:00\")\n    // parseamos manualmente para mantener la hora exacta\n    if (!fechaISO.includes('Z') && !fechaISO.match(/[+-]\\d{2}:\\d{2}$/)) {\n      const partes = fechaISO.match(/^(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})/);\n      \n      if (!partes) return \"\";\n      \n      const [_, year, month, day, hour, minute] = partes;\n      \n      // Crear fecha directamente con los valores sin conversi√≥n\n      const fecha = new Date(\n        parseInt(year),\n        parseInt(month) - 1, // Los meses en JS van de 0-11\n        parseInt(day),\n        parseInt(hour),\n        parseInt(minute),\n        0\n      );\n      \n      if (isNaN(fecha)) return \"\";\n      \n      // Formatear como hora local (sin especificar timezone)\n      const resultado = fecha.toLocaleDateString('es-MX', {\n        weekday: 'long',\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric',\n        hour: '2-digit',\n        minute: '2-digit',\n        hour12: true\n      });\n      \n      return resultado;\n    } else {\n      // Si tiene timezone, procesarla con timezone expl√≠cito\n      const fecha = new Date(fechaISO);\n      \n      if (isNaN(fecha)) return \"\";\n      \n      const resultado = fecha.toLocaleDateString('es-MX', {\n        weekday: 'long',\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric',\n        hour: '2-digit',\n        minute: '2-digit',\n        hour12: true,\n        timeZone: timeZone\n      });\n      \n      return resultado;\n    }\n  } catch {\n    return \"\";\n  }\n}\n\nfunction normalizarNombre(nombre) {\n  if (!nombre || typeof nombre !== 'string' || nombre.trim() === \"\" || nombre === \"null\") return \"\";\n  return nombre\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/[^a-zA-Z√±√ë\\s]/g, '')\n    .toLowerCase()\n    .trim()\n    .replace(/\\s+/g, '');\n}\n\nfunction normalizarEmail(email) {\n  if (!email || typeof email !== 'string' || email.trim() === \"\" || email === \"null\") return \"\";\n  return email.toLowerCase().replace(/\\s+/g, '').trim();\n}\n\nfunction normalizarTelefono(telefono, pais) {\n  if (!telefono || typeof telefono !== 'string' || telefono.trim() === \"\" || telefono === \"null\") return \"\";\n  \n  let numeroLimpio = telefono.replace(/[^\\d+]/g, '');\n  if (!numeroLimpio) return \"\";\n  \n  const paisNormalizado = (pais || '').toLowerCase().trim();\n  \n  const codigosPais = {\n    'm√©xico': '52', 'mexico': '52',\n    'colombia': '57', \n    'espa√±a': '34', 'spain': '34',\n    'argentina': '54', \n    'chile': '56', \n    'per√∫': '51', 'peru': '51'\n  };\n  \n  const codigoPais = codigosPais[paisNormalizado];\n  \n  if (numeroLimpio.startsWith('+')) return numeroLimpio;\n  if (codigoPais && numeroLimpio.startsWith(codigoPais)) return '+' + numeroLimpio;\n  \n  // Caso M√©xico\n  if (paisNormalizado === 'm√©xico' || paisNormalizado === 'mexico') {\n    if (numeroLimpio.startsWith('521') && numeroLimpio.length === 13) {\n      return '+52' + numeroLimpio.substring(3);\n    }\n    if (numeroLimpio.startsWith('52') && numeroLimpio.length === 12) {\n      return '+' + numeroLimpio;\n    }\n    if (numeroLimpio.startsWith('1') && numeroLimpio.length === 11) {\n      return '+52' + numeroLimpio.substring(1);\n    }\n    if (numeroLimpio.length === 10) {\n      return '+52' + numeroLimpio;\n    }\n  }\n  \n  if (codigoPais) return '+' + codigoPais + numeroLimpio;\n  return numeroLimpio;\n}\n\nfunction calcularScoreLead(jsonData) {\n  let score = 60;\n  \n  if (jsonData.email && jsonData.email !== \"null\" && jsonData.email.includes('@')) score += 10;\n  if (jsonData.telefono && jsonData.telefono !== \"null\") score += 10;\n  if (jsonData.servicio && jsonData.servicio !== \"null\") score += 5;\n  if (jsonData.empresa && jsonData.empresa !== \"null\") score += 5;\n  \n  return Math.min(score, 100);\n}\n\nfunction detectarTimeZone(pais) {\n  // Mapeo de pa√≠ses a sus timezones principales\n  const timezonesMap = {\n    'm√©xico': 'America/Mexico_City',\n    'mexico': 'America/Mexico_City',\n    'colombia': 'America/Bogota',\n    'espa√±a': 'Europe/Madrid',\n    'spain': 'Europe/Madrid',\n    'argentina': 'America/Argentina/Buenos_Aires',\n    'chile': 'America/your_name',\n    'per√∫': 'America/Lima',\n    'peru': 'America/Lima',\n    'estados unidos': 'America/New_York',\n    'usa': 'America/New_York'\n  };\n  \n  const paisNormalizado = (pais || '').toLowerCase().trim();\n  return timezonesMap[paisNormalizado] || 'America/Mexico_City'; // Default a M√©xico\n}\n\n// ====================================\n// PROCESAMIENTO\n// ====================================\n\ntry {\n  // Limpiar output\n  let outputLimpio = agentOutput.trim()\n    .replace(/^```json\\s*/i, '')\n    .replace(/^```\\s*/, '')\n    .replace(/\\s*```$/g, '')\n    .replace(/^json\\s*/i, '');\n  \n  // Parsear JSON\n  const jsonData = JSON.parse(outputLimpio);\n  \n  // Extraer datos\n  const nombre = jsonData.nombre || \"\";\n  const email = jsonData.email || \"\";\n  const telefono = jsonData.telefono || \"\";\n  const pais = jsonData.pais || \"\";\n  const fechaCita = jsonData.fecha_cita || \"\";\n  const fechaCitaTimezone = jsonData.fecha_cita_timezone_cliente || \"\";\n  \n  // Normalizar\n  const nombreNormalizado = normalizarNombre(nombre);\n  const emailNormalizado = normalizarEmail(email);\n  const telefonoNormalizado = normalizarTelefono(telefono, pais);\n  const scoreLead = calcularScoreLead(jsonData);\n  \n  // Detectar timezone del pa√≠s\n  const timeZone = detectarTimeZone(pais);\n  \n  // Formatear fechas con timezone correcto\n  const fechaCitaLegible = formatearFechaLegible(fechaCita, timeZone);\n  const fechaCitaTimezoneLegible = formatearFechaLegible(fechaCitaTimezone, timeZone);\n  const fechaCitaLegibleDatabase = formatearFechaLegible(fechaCitaDatabase, timeZone);\n  const fechaCitaTimezoneLegibleDatabase = formatearFechaLegible(fechaCitaTimezoneDatabase, timeZone);\n  \n  return [{\n    json: {\n      // Originales\n      respuesta: jsonData.respuesta || \"\",\n      estado: jsonData.estado || \"null\",\n      servicio: jsonData.servicio || \"null\",\n      fecha_cita: jsonData.fecha_cita || \"null\",\n      fecha_cita_timezone_cliente: jsonData.fecha_cita_timezone_cliente || \"null\",\n      enlace_reunion: jsonData.enlace_reunion || \"null\",\n      empresa: jsonData.empresa || \"null\",\n      telefono: telefono,\n      email: email,\n      nombre: nombre,\n      pais: pais,\n      motivo_cancelacion: jsonData.motivo_cancelacion || \"\",\n      nuevo_google_event_id: jsonData.nuevo_google_event_id || \"\",\n      \n      // Normalizados\n      nombre_normalizado: nombreNormalizado,\n      email_normalizado: emailNormalizado,\n      telefono_normalizado: telefonoNormalizado,\n      score_lead: scoreLead,\n      \n      // Fechas legibles con timezone correcto\n      fecha_cita_legible: fechaCitaLegible,\n      fecha_cita_timezone_legible: fechaCitaTimezoneLegible,\n      fecha_cita_legible_database: fechaCitaLegibleDatabase,\n      fecha_cita_timezone_legible_database: fechaCitaTimezoneLegibleDatabase,\n      \n      // Metadatos\n      timezone_detectado: timeZone,\n      procesado_correctamente: true,\n      timestamp_procesamiento: new Date().toISOString()\n    }\n  }];\n  \n} catch (error) {\n  return [{\n    json: {\n      respuesta: \"Error procesando respuesta\",\n      estado: \"error\",\n      error_detalle: error.message,\n      procesado_correctamente: false\n    }\n  }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2800,
        -1296
      ],
      "id": "58cb3d0a-71af-4ee8-b968-050a1e732273",
      "name": "parsear output a json"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "9735481a-ec90-4220-b0a7-45e6e683cfb0",
              "leftValue": "={{ $('obtener registro de cita').item.json.client_id}}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3472,
        -1392
      ],
      "id": "517d24d0-30a2-440f-9a67-298c888a1338",
      "name": "crear o actualizar registro de cita"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "citas",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "client_id",
              "condition": "eq",
              "keyValue": "={{ $('When Executed by Another Workflow').item.json.client_id}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3248,
        -1392
      ],
      "id": "63651fa9-cfda-4e34-aa09-314f3065d68b",
      "name": "obtener registro de cita",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "your_supabase_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "citas",
        "filters": {
          "conditions": [
            {
              "keyName": "client_id",
              "condition": "eq",
              "keyValue": "={{ $('When Executed by Another Workflow').item.json.client_id}}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "estado",
              "fieldValue": "=cita agendada"
            },
            {
              "fieldId": "nombre",
              "fieldValue": "={{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}"
            },
            {
              "fieldId": "fecha_cita",
              "fieldValue": "=    {{ $('parsear output a json').item.json.fecha_cita}}"
            },
            {
              "fieldId": "email",
              "fieldValue": "=  {{ $('parsear output a json').item.json.email_normalizado ?? $('When Executed by Another Workflow').item.json.email}}"
            },
            {
              "fieldId": "telefono",
              "fieldValue": "=  {{ $('parsear output a json').item.json.telefono_normalizado ?? $('When Executed by Another Workflow').item.json.telefono}}"
            },
            {
              "fieldId": "servicio",
              "fieldValue": "={{ $('parsear output a json').item.json.servicio ?? $('When Executed by Another Workflow').item.json.servicio}}"
            },
            {
              "fieldId": "pais",
              "fieldValue": "={{ $('parsear output a json').item.json.pais ?? $('When Executed by Another Workflow').item.json.pais}}"
            },
            {
              "fieldId": "empresa",
              "fieldValue": "={{ $('parsear output a json').item.json.empresa ?? $('When Executed by Another Workflow').item.json.empresa}}"
            },
            {
              "fieldId": "enlace_reunion",
              "fieldValue": "={{ $('parsear output a json').item.json.enlace_reunion}}"
            },
            {
              "fieldId": "fecha_cita_timezone_cliente",
              "fieldValue": "={{ $('parsear output a json').item.json.fecha_cita_timezone_cliente}}"
            },
            {
              "fieldId": "fecha_cita_timezone_legible",
              "fieldValue": "={{ $('parsear output a json').item.json.fecha_cita_timezone_legible}}"
            },
            {
              "fieldId": "fecha_cita_legible",
              "fieldValue": "={{ $('parsear output a json').item.json.fecha_cita_legible}}"
            },
            {
              "fieldId": "cita_pasada",
              "fieldValue": "No"
            },
            {
              "fieldId": "google_event_id",
              "fieldValue": "={{ $('parsear output a json').item.json.nuevo_google_event_id}}"
            },
            {
              "fieldId": "recordatorio_enviado",
              "fieldValue": "FALSE"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3696,
        -1584
      ],
      "id": "d279bac3-6563-4997-a758-4f5aea73b94f",
      "name": "crear_cita",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "your_supabase_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "sendTo": "={{ $('parsear output a json').item.json.email_normalizado ?? $('When Executed by Another Workflow').item.json.email}}",
        "subject": "Cita Agendada",
        "message": "=<!DOCTYPE html> <html lang=\"es\"> <head>     <meta charset=\"UTF-8\">     <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">     <title>Cita Agendada - your_brand</title> </head> <body style=\"margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0a0a0a;\">     <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #0a0a0a; padding: 20px;\">         <tr>             <td align=\"center\">                 <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #1a1a1a; border-radius: 15px; overflow: hidden; box-shadow: 0 0 30px rgba(0, 255, 255, 0.2); border: 1px solid #00ffff;\">                                          <!-- Header con logo y fondo decorativo -->                     <tr>                         <td style=\"background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); padding: 40px 30px; text-align: center; position: relative; border-bottom: 2px solid #00ffff;\">                                                         <!-- Logo -->                             <img src=\"https://ik.imagekit.io/49rd3bmeqs/Logos%20your_brand/logo2%20(3).png?updatedAt=1759468732222\" alt=\"your_brand Logo\" style=\"width: 120px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(0, 255, 255, 0.5));\" />                                                          <h1 style=\"margin: 0; color: #00ffff; font-size: 32px; font-weight: 700; text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);\">                                 ‚úì Cita Confirmada                             </h1>                             <p style=\"margin: 10px 0 0 0; color: #ffffff; font-size: 16px;\">                                 Tu reuni√≥n ha sido agendada exitosamente                             </p>                         </td>                     </tr>                      <!-- Contenido principal -->                     <tr>                         <td style=\"padding: 40px 30px; background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);\">                             <p style=\"margin: 0 0 25px 0; color: #ffffff; font-size: 18px; line-height: 1.6;\">                                 Hola <strong style=\"color: #00ffff;\">{{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}</strong>,                             </p>                                                          <p style=\"margin: 0 0 30px 0; color: #e0e0e0; font-size: 16px; line-height: 1.6;\">                                 Nos complace confirmar que tu cita del <strong style=\"color: #00ffff;\">{{$('parsear output a json').item.json.fecha_cita_timezone_legible\n}}</strong> ha sido agendada.                             </p>                              <!-- Bloque de informaci√≥n de la reuni√≥n -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 30px 0;\">                                 <tr>                                     <td style=\"background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border-left: 4px solid #00ffff; padding: 25px; border-radius: 10px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.15);\">                                         <h3 style=\"margin: 0 0 15px 0; color: #00ffff; font-size: 20px; display: flex; align-items: center;\">                                             üìÖ Detalles de tu Reuni√≥n                                         </h3>                                         <p style=\"margin: 0 0 10px 0; color: #ffffff; font-size: 15px; line-height: 1.6;\">                                             <strong style=\"color: #00ffff;\">Fecha:</strong> {{$('parsear output a json').item.json.fecha_cita_timezone_legible\n}}                                       </p>                                         <p style=\"margin: 0; color: #e0e0e0; font-size: 14px; line-height: 1.5;\">                                             <strong style=\"color: #00ffff;\">Enlace:</strong><br>                                             <a href=\"{{ $('parsear output a json').item.json.enlace_reunion }}\" style=\"color: #ffffff; word-break: break-all; text-decoration: none;\">{{ $('parsear output a json').item.json.enlace_reunion }}</a>                                         </p>                                     </td>                                 </tr>                             </table>                              <!-- Bot√≥n llamada a la acci√≥n -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 35px 0;\">                                 <tr>                                     <td align=\"center\">                                         <a href=\"{{ $('parsear output a json').item.json.enlace_reunion }}\" style=\"display: inline-block; background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%); color: #000000; text-decoration: none; padding: 18px 45px; border-radius: 30px; font-size: 18px; font-weight: 700; box-shadow: 0 0 25px rgba(0, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 1px;\">                                             üé• Unirse a la Reuni√≥n                                         </a>                                     </td>                                 </tr>                             </table>                              <!-- Secci√≥n de servicios -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 40px 0 30px 0;\">                                 <tr>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">ü§ñ</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Inteligencia Artificial</h4>                                         </div>                                     </td>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">üìä</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Marketing Digital</h4>                                         </div>                                     </td>                                     <td width=\"33%\" style=\"padding: 5px;\">                                         <div style=\"background-color: #1a1a1a; padding: 20px 10px; border-radius: 10px; text-align: center; border: 1px solid #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);\">                                             <div style=\"font-size: 32px; margin-bottom: 10px;\">üì±</div>                                             <h4 style=\"margin: 0; color: #00ffff; font-size: 14px;\">Redes Sociales</h4>                                         </div>                                     </td>                                 </tr>                             </table>                              <!-- Link al sitio web -->                             <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin: 30px 0;\">                                 <tr>                                     <td align=\"center\" style=\"background-color: #0a0a0a; padding: 20px; border-radius: 10px; border: 1px solid #333333;\">                                         <p style=\"margin: 0 0 10px 0; color: #ffffff; font-size: 15px;\">                                             üåê Conoce m√°s sobre nuestros servicios                                         </p>                                         <a href=\"https://www.your_brand.com.mx\" style=\"color: #00ffff; text-decoration: none; font-weight: 600; font-size: 16px; text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);\">                                             Vis√≠tanos aqu√≠ ‚Üí                                         </a>                                     </td>                                 </tr>                             </table>                          </td>                     </tr>                      <!-- Footer -->                     <tr>                         <td style=\"background-color: #000000; padding: 35px 30px; text-align: center; border-top: 2px solid #00ffff;\">                             <p style=\"margin: 0 0 15px 0; color: #ffffff; font-size: 16px; font-weight: 600;\">                                 Gracias por confiar en nosotros                             </p>                             <p style=\"margin: 0 0 20px 0; color: #00ffff; font-size: 15px;\">                                 your_name<br>                                 <span style=\"color: #999999; font-size: 13px;\">CEO de your_brand</span>                             </p>                             <div style=\"width: 60px; height: 2px; background: linear-gradient(90deg, transparent, #00ffff, transparent); margin: 20px auto;\"></div>                             <p style=\"margin: 0; color: #666666; font-size: 12px;\">                                 ¬© 2025 your_brand. Todos los derechos reservados.                             </p>                             <p style=\"margin: 15px 0 0 0;\">                                 <a href=\"https://www.your_brand.com.mx\" style=\"color: #00ffff; text-decoration: none; margin: 0 10px; font-size: 12px;\">Sitio Web</a>                                 <span style=\"color: #333333;\">|</span>                                 <a href=\"https://wa.me/your_phone_number?text=\" style=\"color: #00ffff; text-decoration: none; margin: 0 10px; font-size: 12px;\">WhatsApp</a>                             </p>                         </td>                     </tr>                  </table>             </td>         </tr>     </table> </body> </html>",
        "options": {
          "appendAttribution": false,
          "senderName": "your_name, CEO de your_brand"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        4144,
        -1584
      ],
      "id": "b8367e14-00bb-48b8-8ea4-839ec27251af",
      "name": "enviar_correo_cita_agendada",
      "webhookId": "61a46709-2e59-4111-9e1c-426028790690",
      "alwaysOutputData": true,
      "credentials": {
        "gmailOAuth2": {
          "id": "your_gmail_credential_id",
          "name": "your_brand Nuevo"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "chatId": "your_telegram_chat_id",
        "text": "=Nueva Cita con {{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}\nFecha: {{ $('parsear output a json').item.json.fecha_cita_legible }}\nEnlace: {{ $('parsear output a json').item.json.enlace_reunion }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4368,
        -1584
      ],
      "id": "c943dee2-eb41-40c4-a154-e28b6d6501db",
      "name": "agenda_telegram_citas4",
      "webhookId": "2e1dac8d-f98d-4807-8539-2fd816da71c0",
      "alwaysOutputData": true,
      "credentials": {
        "telegramApi": {
          "id": "your_telegram_credential_id",
          "name": "Citas your_brand"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "96a90319-903d-4b87-9086-c96b39c45b7e",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.channel }}",
              "rightValue": "Channel::Whatsapp",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3920,
        -912
      ],
      "id": "47344999-1ccb-4fde-b997-d51bc09ba1fc",
      "name": "If2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4144,
        -1008
      ],
      "id": "5b7233ae-73ba-4db6-8410-d88ea2922003",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4144,
        -624
      ],
      "id": "eee026e9-32fd-423c-8b77-01dd370a8121",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4144,
        -240
      ],
      "id": "061026ab-c483-4cf3-a1ed-615dc5cfa22b",
      "name": "No Operation, do nothing3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "96a90319-903d-4b87-9086-c96b39c45b7e",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.channel }}",
              "rightValue": "Channel::Whatsapp",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3920,
        -528
      ],
      "id": "2b1cd2e6-a7dd-4714-98e5-9bbd818c0191",
      "name": "If3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "96a90319-903d-4b87-9086-c96b39c45b7e",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.channel }}",
              "rightValue": "Channel::Whatsapp",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3920,
        -144
      ],
      "id": "83a456fd-2d71-48bc-ad9c-0627a9df46be",
      "name": "If4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "96a90319-903d-4b87-9086-c96b39c45b7e",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.channel }}",
              "rightValue": "Channel::Whatsapp",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4592,
        -1584
      ],
      "id": "0bdac293-c1b7-4f04-a3a6-39405ef09088",
      "name": "If5"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "96a90319-903d-4b87-9086-c96b39c45b7e",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.channel }}",
              "rightValue": "Channel::Whatsapp",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4592,
        -1200
      ],
      "id": "d267b521-e2a6-4798-b83f-a2250b5e3e5c",
      "name": "If6"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4816,
        -1680
      ],
      "id": "12273294-1f83-4816-99c6-fdf8fb57b4b8",
      "name": "No Operation, do nothing4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4816,
        -1296
      ],
      "id": "c65fe6be-0cde-4c35-8296-f6fcfae940c6",
      "name": "No Operation, do nothing5"
    },
    {
      "parameters": {
        "phoneNumberId": "710637588808362",
        "recipientPhoneNumber": "={{ $('parsear output a json').item.json.telefono_normalizado ?? $('When Executed by Another Workflow').item.json.telefono}}",
        "template": "cita_agendada|es_MX",
        "components": {
          "component": [
            {
              "bodyParameters": {
                "parameter": [
                  {
                    "text": "={{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}"
                  },
                  {
                    "text": "={{ $('parsear output a json').item.json.fecha_cita_timezone_legible }} "
                  },
                  {
                    "text": "={{ $('parsear output a json').item.json.enlace_reunion }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        4816,
        -1488
      ],
      "id": "d0f8c291-ffa4-4ffc-b5e0-2501acbf8841",
      "name": "confirmar_cita_wa1",
      "webhookId": "53e8e612-3424-4d89-abec-23266c4eabbc",
      "alwaysOutputData": true,
      "credentials": {
        "whatsAppApi": {
          "id": "your_whatsapp_credential_id",
          "name": "WhatsApp account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
                    "rightValue": "agendar_cita",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "5d261e4d-a056-4c87-ab82-9f20bbe2f87d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agendar_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "94b09a56-c2d7-49d2-b72b-0c94391e840b",
                    "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
                    "rightValue": "cancelar_cita",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelar_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ac024703-9557-4e74-886d-87a51994cd76",
                    "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
                    "rightValue": "posponer_cita",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "posponer_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "95dfd53b-dbf9-4f04-add4-ead12dd0766b",
                    "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
                    "rightValue": "reagendar_cita",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reagendar_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "804ec6be-a682-4fd6-b6dc-412310a98c71",
                    "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
                    "rightValue": "comprar",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "comprar"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        240,
        -528
      ],
      "id": "2c1c214e-b7da-45ce-b14f-8f4d1f34f1d2",
      "name": "Switch"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "235f7a1e-7837-4c7c-9e24-6d5c0064414d",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.asistencia }} ",
              "rightValue": "no_asistio",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        592,
        -1104
      ],
      "id": "347e20b9-9803-41d1-b41c-083263e93ee7",
      "name": "If7"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "=Hola {{ $('When Executed by Another Workflow').item.json.nombre }}, Lamento informarte que actualmente no puedes agendar una nueva cita. Tenemos registrado que no asististe a tu cita anterior sin previo aviso. Por pol√≠ticas de nuestra agencia, se aplica una restricci√≥n temporal de 1 mes antes de poder agendar nuevamente. Podr√°s agendar despu√©s del {{\n(() => {\n  let fechaRaw = $('When Executed by Another Workflow').item.json.fecha_cita_timezone_cliente;\n  if (!fechaRaw) return 'Sin fecha';\n\n  // Normaliza formato\n  fechaRaw = fechaRaw.replace(' ', 'T').replace(/\\//g, '-');\n\n  // Solo agrega Z si no hay zona horaria ni Z\n  if (!/[+-]\\d{2}:\\d{2}$/.test(fechaRaw) && !fechaRaw.endsWith('Z')) {\n    fechaRaw += 'Z';\n  }\n\n  const fecha = new Date(fechaRaw);\n  if (isNaN(fecha.getTime())) return 'Fecha inv√°lida';\n\n  return fecha.toLocaleDateString('es-MX', {\n    weekday: 'long',\n    day: 'numeric',\n    month: 'long',\n    year: 'numeric'\n  });\n})()\n}}\n\n\n"
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('When Executed by Another Workflow').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        928,
        -1200
      ],
      "id": "7155ce32-647a-44a1-9738-e2880ce58001",
      "name": "penalizacion inasistencia",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "235f7a1e-7837-4c7c-9e24-6d5c0064414d",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.estado_cita }} ",
              "rightValue": "=cita agendada",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "17e7bfd3-664e-4eaa-b05a-3ea22570512a",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.estado_cita }} ",
              "rightValue": "=cita reagendada",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        928,
        -992
      ],
      "id": "e94f165a-d671-4af4-80b1-c288cf4afa42",
      "name": "If12"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "=Hola {{ $('When Executed by Another Workflow').item.json.nombre }}, Ya tienes una cita agendada para el {{ $('When Executed by Another Workflow').item.json.fecha_cita_timezone_legible }} Para agendar una nueva, primero debes:1Ô∏è‚É£ Cancelar tu cita actual, 2Ô∏è‚É£ reagendarla, ¬øQu√© prefieres?\n\n"
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('When Executed by Another Workflow').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1376,
        -1104
      ],
      "id": "00020184-6081-46a9-8dec-a19a0377f3f6",
      "name": "cita existente",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "=Hola {{ $('When Executed by Another Workflow').item.json.nombre }}, Actualmente no tienes una cita existente para cancelar, pero con mucho gusto puedo ayudarte a agendar una nueva cita."
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('When Executed by Another Workflow').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1152,
        -432
      ],
      "id": "7c2f62f2-e472-4dea-bffe-54a679827723",
      "name": "no hay cita",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "=Hola {{ $('When Executed by Another Workflow').item.json.nombre }}, Actualmente no tienes una cita existente para posponer, pero con mucho gusto puedo ayudarte a agendar una nueva cita."
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('When Executed by Another Workflow').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1152,
        -48
      ],
      "id": "1e01467f-b9a4-44f0-b725-93a1eb718ec3",
      "name": "no hay cita1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "=Hola {{ $('When Executed by Another Workflow').item.json.nombre }}, Actualmente no tienes una cita existente para poder reagendar, pero con mucho gusto puedo ayudarte a agendar una nueva cita."
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('When Executed by Another Workflow').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1152,
        432
      ],
      "id": "763e6c1a-bb34-4314-a932-152616b814b6",
      "name": "no hay cita2",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "235f7a1e-7837-4c7c-9e24-6d5c0064414d",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.estado_cita }} ",
              "rightValue": "cita agendada",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "17e7bfd3-664e-4eaa-b05a-3ea22570512a",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.estado_cita }} ",
              "rightValue": "cita reagendada",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        928,
        -528
      ],
      "id": "27101282-f5a9-44ef-a050-c419be127b71",
      "name": "If13"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "235f7a1e-7837-4c7c-9e24-6d5c0064414d",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.estado_cita }} ",
              "rightValue": "cita agendada",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "17e7bfd3-664e-4eaa-b05a-3ea22570512a",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.estado_cita }} ",
              "rightValue": "cita reagendada",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        928,
        -144
      ],
      "id": "ba96cd2c-baae-4213-b134-535550be5192",
      "name": "If14"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "235f7a1e-7837-4c7c-9e24-6d5c0064414d",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.estado_cita }} ",
              "rightValue": "cita agendada",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "17e7bfd3-664e-4eaa-b05a-3ea22570512a",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.estado_cita }} ",
              "rightValue": "cita reagendada",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        928,
        240
      ],
      "id": "17c5d90c-f2d3-4a93-b51d-84d90271c22d",
      "name": "If15"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "235f7a1e-7837-4c7c-9e24-6d5c0064414d",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.cita_pasada }}",
              "rightValue": "=cita_pasada",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1152,
        -1056
      ],
      "id": "3c44effb-9a71-4827-b266-ce4b2191b717",
      "name": "If17"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "=Hola {{ $('When Executed by Another Workflow').item.json.nombre }},su cita del {{ $('When Executed by Another Workflow').item.json.fecha_cita_timezone_legible }} ya ha pasado por lo tanto ya no puede cancelarla. Si necesita agendar una nueva cita solo digamelo y con gusto le oriento."
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('When Executed by Another Workflow').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1376,
        -288
      ],
      "id": "08f15106-63b1-43b5-86ed-84b29cd738f1",
      "name": "muy tarde para cancelar",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "=Hola {{ $('When Executed by Another Workflow').item.json.nombre }},su cita del {{ $('When Executed by Another Workflow').item.json.fecha_cita_timezone_legible }} ya ha pasado por lo tanto ya no puede posponerla. Si necesita agendar una nueva cita solo digamelo y con gusto le oriento."
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('When Executed by Another Workflow').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1376,
        0
      ],
      "id": "7a690cbb-d9f1-46c5-824f-d912a6d68a1f",
      "name": "muy tarde para posponer",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "=Hola {{ $('When Executed by Another Workflow').item.json.nombre }},su cita del {{ $('When Executed by Another Workflow').item.json.fecha_cita_timezone_legible }} ya ha pasado por lo tanto ya no puede reagendarla. Si necesita agendar una nueva cita solo digamelo y con gusto le oriento."
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('When Executed by Another Workflow').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1376,
        192
      ],
      "id": "4334a203-a232-4cdf-a283-b0244d8beba2",
      "name": "muy tarde para reagendar",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "235f7a1e-7837-4c7c-9e24-6d5c0064414d",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.cita_pasada }}",
              "rightValue": "=cita_pasada",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1152,
        -624
      ],
      "id": "e500c145-4882-463f-a048-2d407afb71d7",
      "name": "If18"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "235f7a1e-7837-4c7c-9e24-6d5c0064414d",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.cita_pasada }}",
              "rightValue": "=cita_pasada",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1152,
        -240
      ],
      "id": "8f5fccdd-42fd-40f1-8c44-6413bf77cb39",
      "name": "If19"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "235f7a1e-7837-4c7c-9e24-6d5c0064414d",
              "leftValue": "={{ $('When Executed by Another Workflow').item.json.cita_pasada }}",
              "rightValue": "=cita_pasada",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1152,
        144
      ],
      "id": "c260b7df-5481-4ea3-abd3-abca05a6e993",
      "name": "If20"
    },
    {
      "parameters": {
        "jsCode": "// ====================================\n// PARSER AGENTE DE TRANSICI√ìN - your_brand\n// Parsea output del agente your_name (transici√≥n)\n// Soporta TODOS los formatos posibles de JSON\n// Campos: respuesta, escalamiento, agendar\n// ====================================\n\nconst agentOutput = $input.first().json.output;\n\n// ====================================\n// FUNCIONES DE EXTRACCI√ìN Y PARSING\n// ====================================\n\n/**\n * Extrae JSON del output con m√∫ltiples estrategias\n * Maneja todos los formatos incluyendo JSON malformado\n */\nfunction extraerJSON(output) {\n  if (!output) return null;\n  \n  let texto = output.trim();\n  \n  // ========================================\n  // ESTRATEGIA 1: Buscar JSON entre llaves\n  // ========================================\n  const inicioJSON = texto.indexOf('{');\n  const finJSON = texto.lastIndexOf('}');\n  \n  if (inicioJSON !== -1 && finJSON !== -1 && finJSON > inicioJSON) {\n    texto = texto.substring(inicioJSON, finJSON + 1);\n  }\n  \n  // ========================================\n  // ESTRATEGIA 2: Limpiar prefijos markdown\n  // ========================================\n  texto = texto.replace(/^```json\\s*/i, '');\n  texto = texto.replace(/^```\\s*/, '');\n  texto = texto.replace(/\\s*```$/g, '');\n  texto = texto.replace(/^json[\\s\\n]*/i, '');\n  \n  // ========================================\n  // ESTRATEGIA 3: Limpiar texto despu√©s del JSON\n  // ========================================\n  const ultimaLlave = texto.lastIndexOf('}');\n  if (ultimaLlave !== -1 && ultimaLlave < texto.length - 1) {\n    texto = texto.substring(0, ultimaLlave + 1);\n  }\n  \n  // ========================================\n  // ESTRATEGIA 4: Manejo de strings escapados\n  // ========================================\n  if (texto.startsWith('\"') && texto.endsWith('\"')) {\n    try {\n      texto = JSON.parse(texto);\n    } catch (e) {\n      texto = texto.slice(1, -1);\n    }\n  }\n  \n  // ========================================\n  // ESTRATEGIA 5: Intentar parsear\n  // ========================================\n  try {\n    return JSON.parse(texto);\n  } catch (error) {\n    return repararJSON(texto);\n  }\n}\n\n/**\n * Repara JSON malformado\n */\nfunction repararJSON(textoJSON) {\n  try {\n    let reparado = textoJSON.trim();\n    \n    // Contar llaves\n    const aperturas = (reparado.match(/{/g) || []).length;\n    const cierres = (reparado.match(/}/g) || []).length;\n    \n    // Agregar llaves faltantes\n    if (aperturas > cierres) {\n      const faltantes = aperturas - cierres;\n      reparado += '}'.repeat(faltantes);\n    }\n    \n    return JSON.parse(reparado);\n  } catch (error) {\n    return null;\n  }\n}\n\n/**\n * Normaliza valor booleano de strings\n */\nfunction normalizarBooleano(valor) {\n  if (typeof valor === 'boolean') return valor;\n  if (valor === null || valor === undefined) return false;\n  \n  const valorString = String(valor).toLowerCase().trim();\n  \n  // True: \"true\", \"1\", \"yes\", \"s√≠\", \"si\"\n  if (['true', '1', 'yes', 's√≠', 'si'].includes(valorString)) {\n    return true;\n  }\n  \n  // False: todo lo dem√°s\n  return false;\n}\n\n/**\n * Limpia y formatea la respuesta al cliente\n */\nfunction limpiarRespuesta(respuesta) {\n  if (!respuesta) return \"\";\n  \n  return String(respuesta)\n    .replace(/\\\\n/g, '\\n')    // Convertir \\n en saltos de l√≠nea reales\n    .replace(/\\\\\"/g, '\"')      // Quitar escapes de comillas\n    .replace(/\\\\\\\\/g, '\\\\')    // Quitar escapes de backslashes\n    .trim();\n}\n\n/**\n * Extrae campos del JSON parseado con valores por defecto\n */\nfunction extraerCampos(jsonData) {\n  if (!jsonData || typeof jsonData !== 'object') {\n    return {\n      respuesta: \"\",\n      escalamiento: false,\n      agendar: false,\n      eliminar_cliente: false\n    };\n  }\n  \n  return {\n    respuesta: limpiarRespuesta(jsonData.respuesta || \"\"),\n    escalamiento: normalizarBooleano(jsonData.escalamiento),\n    agendar: normalizarBooleano(jsonData.agendar),\n    eliminar_cliente: normalizarBooleano(jsonData.eliminar_cliente)\n  };\n}\n\n/**\n * Extrae respuesta del texto plano si el JSON falla completamente\n */\nfunction extraerRespuestaFallback(output) {\n  try {\n    // Buscar el campo \"respuesta\" en el texto\n    const match = output.match(/\"respuesta\"\\s*:\\s*\"([^\"]+(?:\\\\.[^\"]+)*)\"/);\n    if (match && match[1]) {\n      return limpiarRespuesta(match[1]);\n    }\n    \n    // Si no encuentra, intentar buscar entre comillas despu√©s de \"respuesta\"\n    const match2 = output.match(/respuesta[\"\\s:]+([^,}]+)/i);\n    if (match2 && match2[1]) {\n      return limpiarRespuesta(match2[1].replace(/[\"']/g, ''));\n    }\n  } catch (e) {\n    // Si todo falla, retornar mensaje gen√©rico\n  }\n  \n  return \"Error al procesar la respuesta del agente. Por favor, contacta al equipo de soporte.\";\n}\n\n/**\n * Extrae valores booleanos del texto plano si el JSON falla\n */\nfunction extraerBooleanoFallback(output, campo) {\n  try {\n    const regex = new RegExp(`\"${campo}\"\\\\s*:\\\\s*(true|false)`, 'i');\n    const match = output.match(regex);\n    if (match && match[1]) {\n      return normalizarBooleano(match[1]);\n    }\n  } catch (e) {\n    // Ignorar error\n  }\n  return false;\n}\n\n// ====================================\n// PROCESAMIENTO PRINCIPAL\n// ====================================\n\ntry {\n  // Intentar extraer y parsear el JSON\n  const jsonData = extraerJSON(agentOutput);\n  \n  // Extraer campos con valores por defecto\n  const campos = extraerCampos(jsonData);\n  \n  // Validaci√≥n adicional: la respuesta no puede estar vac√≠a\n  if (!campos.respuesta || campos.respuesta.trim() === \"\") {\n    // Intentar extraer del texto plano\n    campos.respuesta = extraerRespuestaFallback(agentOutput);\n    \n    // Si a√∫n est√° vac√≠o, usar mensaje de error\n    if (!campos.respuesta || campos.respuesta.trim() === \"\") {\n      campos.respuesta = \"Error: El agente no gener√≥ una respuesta v√°lida.\";\n    }\n  }\n  \n  // Crear el item en el formato que n8n espera\n  const newItem = {\n    json: {\n      // ===== CAMPOS PRINCIPALES =====\n      respuesta: campos.respuesta,\n      escalamiento: campos.escalamiento,\n      agendar: campos.agendar,\n      eliminar_cliente: campos.eliminar_cliente,\n      \n      // ===== METADATOS DE PROCESAMIENTO =====\n      procesado_correctamente: true,\n      json_reparado: jsonData === null,\n      timestamp_procesamiento: new Date().toISOString(),\n      \n      // ===== FLAGS ADICIONALES =====\n      requiere_atencion_humana: campos.escalamiento,\n      cliente_listo_para_agendar: campos.agendar,\n      cliente_solicita_eliminacion: campos.eliminar_cliente,\n      \n      // ===== INFORMACI√ìN DE DEBUG (opcional) =====\n      longitud_respuesta: campos.respuesta.length,\n      output_original_length: agentOutput ? agentOutput.length : 0\n    }\n  };\n  \n  // Retornar como array - FORMATO CORRECTO PARA N8N\n  return [newItem];\n  \n} catch (error) {\n  // ========================================\n  // √öLTIMO RECURSO: Extraer del texto plano\n  // ========================================\n  \n  let respuestaExtraida = extraerRespuestaFallback(agentOutput);\n  let escalamientoExtraido = extraerBooleanoFallback(agentOutput, 'escalamiento');\n  let agendarExtraido = extraerBooleanoFallback(agentOutput, 'agendar');\n  let eliminarExtraido = extraerBooleanoFallback(agentOutput, 'eliminar_cliente');\n  \n  // Item de error con informaci√≥n detallada\n  const errorItem = {\n    json: {\n      // ===== CAMPOS PRINCIPALES (con fallbacks) =====\n      respuesta: respuestaExtraida,\n      escalamiento: escalamientoExtraido,\n      agendar: agendarExtraido,\n      eliminar_cliente: eliminarExtraido,\n      \n      // ===== METADATOS DE ERROR =====\n      procesado_correctamente: false,\n      json_reparado: false,\n      error_detalle: error.message,\n      requiere_atencion_humana: true, // Siempre true en caso de error\n      cliente_listo_para_agendar: agendarExtraido,\n      cliente_solicita_eliminacion: eliminarExtraido,\n      \n      // ===== INFORMACI√ìN DE DEBUG =====\n      output_recibido_preview: agentOutput ? agentOutput.substring(0, 300) : \"vac√≠o\",\n      output_completo_length: agentOutput ? agentOutput.length : 0,\n      timestamp_procesamiento: new Date().toISOString(),\n      \n      // ===== ALERTA =====\n      alerta_sistema: \"El agente no devolvi√≥ JSON v√°lido. Se extrajeron valores por fallback.\"\n    }\n  };\n  \n  return [errorItem];\n}\n\n// ====================================\n// NOTAS DE USO\n// ====================================\n/*\nCAMPOS DE SALIDA:\n  \n  1. respuesta (string): \n     - Mensaje para enviar al cliente por WhatsApp\n     - Nunca vac√≠o (usa fallback si falla)\n  \n  2. escalamiento (boolean):\n     - true: Requiere intervenci√≥n humana\n     - false: El agente puede continuar\n  \n  3. agendar (boolean):\n     - true: Cliente acept√≥ agendar, enviar n√∫mero del agente de agendamiento\n     - false: Cliente a√∫n no acepta agendar\n\n  4. eliminar_cliente (boolean):\n     - true: Cliente confirm√≥ eliminar su informaci√≥n y no ser contactado\n     - false: Cliente no solicit√≥ eliminaci√≥n\n\nFLUJO RECOMENDADO EN N8N:\n\n  ‚Üí IF (eliminar_cliente === true)\n    ‚Ü≥ Eliminar prospecto de base de datos\n    ‚Ü≥ Agregar a lista de no contactar\n    ‚Ü≥ Enviar respuesta de despedida al cliente\n    ‚Ü≥ TERMINAR flujo\n  \n  ‚Üí IF (escalamiento === true)\n    ‚Ü≥ Enviar alerta a equipo humano\n    ‚Ü≥ Pausar automatizaci√≥n\n  \n  ‚Üí IF (agendar === true)\n    ‚Ü≥ Enviar respuesta con n√∫mero +your_phone_number\n    ‚Ü≥ Marcar lead como \"En agendamiento\"\n    ‚Ü≥ Notificar al Agente de Agendamiento\n  \n  ‚Üí IF (agendar === false && escalamiento === false && eliminar_cliente === false)\n    ‚Ü≥ Continuar conversaci√≥n automatizada\n    ‚Ü≥ Enviar respuesta al cliente\n    ‚Ü≥ Esperar siguiente mensaje\n\nPRIORIDAD DE ACCIONES:\n  1. eliminar_cliente (m√°s alta prioridad - acci√≥n inmediata)\n  2. escalamiento (segunda prioridad - intervenci√≥n humana)\n  3. agendar (tercera prioridad - transici√≥n a agendamiento)\n  4. continuar conversaci√≥n (default)\n\nMANEJO DE ERRORES:\n\n  - Si procesado_correctamente === false:\n    ‚Üí Revisar output_recibido_preview\n    ‚Üí Escalar a humano autom√°ticamente\n    ‚Üí Verificar que el agente est√° devolviendo JSON correcto\n\n  - Si json_reparado === true:\n    ‚Üí El JSON ten√≠a problemas pero se repar√≥\n    ‚Üí Funcional pero revisar logs\n    ‚Üí Considerar mejorar el prompt del agente\n\n  - Si alerta_sistema existe:\n    ‚Üí Error cr√≠tico en el parsing\n    ‚Üí Se usaron fallbacks\n    ‚Üí Requiere revisi√≥n manual\n*/"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        816
      ],
      "id": "9afa1404-4569-4687-9835-9527eec89aa2",
      "name": "parsear output a json1"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "leads_formularios_optimizada",
        "filters": {
          "conditions": [
            {
              "keyName": "client_id",
              "condition": "eq",
              "keyValue": "={{ $('When Executed by Another Workflow').item.json.client_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "es_cliente",
              "fieldValue": "=true"
            },
            {
              "fieldId": "estado_lead",
              "fieldValue": "Cita agendada"
            },
            {
              "fieldId": "pais",
              "fieldValue": "={{ $('parsear output a json').item.json.pais ?? $('When Executed by Another Workflow').item.json.pais}}"
            },
            {
              "fieldId": "nombre",
              "fieldValue": "={{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}"
            },
            {
              "fieldId": "nombre_normalizado",
              "fieldValue": "={{ $('parsear output a json').item.json.nombre_normalizado ?? $('When Executed by Another Workflow').item.json.nombre_normalizado}}"
            },
            {
              "fieldId": "telefono",
              "fieldValue": "={{ $('parsear output a json').item.json.telefono_normalizado ?? $('When Executed by Another Workflow').item.json.telefono}}"
            },
            {
              "fieldId": "servicio",
              "fieldValue": "={{ $('parsear output a json').item.json.servicio ?? $('When Executed by Another Workflow').item.json.servicio}}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $('parsear output a json').item.json.email_normalizado ?? $('When Executed by Another Workflow').item.json.email}}"
            },
            {
              "fieldId": "empresa",
              "fieldValue": "={{ $('parsear output a json').item.json.empresa ?? $('When Executed by Another Workflow').item.json.empresa}}"
            },
            {
              "fieldId": "score_lead",
              "fieldValue": "={{\n  (\n    $('When Executed by Another Workflow').item.json.score_lead === 0 ||\n    $('When Executed by Another Workflow').item.json.score_lead === '' ||\n    $('When Executed by Another Workflow').item.json.score_lead === null ||\n    $('When Executed by Another Workflow').item.json.score_lead === undefined\n  )\n    ? $('parsear output a json').item.json.score_lead\n    : $('When Executed by Another Workflow').item.json.score_lead\n}}\n"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3920,
        -1584
      ],
      "id": "8c79bd5f-327b-4358-bd96-4f52952c81dc",
      "name": "actualizar_lead",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "your_supabase_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $json.respuesta }}"
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('When Executed by Another Workflow').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('When Executed by Another Workflow').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1152,
        816
      ],
      "id": "26eae0a3-a76f-4045-825c-382ef41a76e7",
      "name": "contestar consulta",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE conversaciones \nSET etiqueta = '{{ $('When Executed by Another Workflow').item.json.etiqueta }}',\n    clasificacion_cita = '{{ $('parsear respuesta agente').item.json.categoria }}'\nWHERE id IN (\n    SELECT id \n    FROM conversaciones \n    WHERE session_id = '{{ $('When Executed by Another Workflow').item.json.client_id }}'\n    ORDER BY id DESC \n    LIMIT 2\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2576,
        -656
      ],
      "id": "d8631142-ba81-4977-bbae-17b574a390d8",
      "name": "registrar_etiqueta_y_fecha",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_postgres_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT json_build_object(\n  'historial_conversaciones', \n  string_agg(\n    conversacion_formateada,\n    E'\\n\\n'\n  )\n) as resultado\nFROM (\n  SELECT \n    '#' || id || ' [' || (message->>'type') || '] ' || \n    COALESCE(\n      CASE \n        -- Si content es un objeto JSON con campo 'respuesta', extraerlo\n        WHEN jsonb_typeof(message->'content') = 'object' AND message->'content' ? 'respuesta' \n        THEN (message->'content')->>'respuesta'\n        \n        -- Si content es un string JSON, intentar parsearlo\n        WHEN jsonb_typeof(message->'content') = 'string' AND (message->>'content')::text LIKE '{%'\n        THEN (message->>'content')::jsonb->>'respuesta'\n        \n        -- Si no, devolver el contenido tal cual\n        ELSE message->>'content'\n      END,\n      'Sin contenido'\n    ) ||\n    CASE \n      WHEN clasificacion_cita IS NOT NULL AND clasificacion_cita != '' \n      THEN ' | Clasificaci√≥n: ' || clasificacion_cita\n      ELSE ''\n    END as conversacion_formateada\n  FROM conversaciones\n  WHERE session_id = '{{ $('When Executed by Another Workflow').item.json.client_id }}'\n  ORDER BY id DESC\n  LIMIT 10\n) subquery;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -784,
        48
      ],
      "id": "3e076441-fc67-4f5a-ac92-bb095e74466a",
      "name": "extraer_clasificacion_anterior",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_postgres_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE conversaciones \nSET etiqueta = '{{ $('When Executed by Another Workflow').item.json.etiqueta }}',\n    clasificacion_cita = '{{ $('parsear respuesta agente').item.json.categoria }}'\nWHERE id IN (\n    SELECT id \n    FROM conversaciones \n    WHERE session_id = '{{ $('When Executed by Another Workflow').item.json.client_id }}'\n    ORDER BY id DESC \n    LIMIT 2\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        928,
        624
      ],
      "id": "f9a94e1a-c669-44d3-89b2-10b34db12765",
      "name": "registrar_etiqueta_y_fecha1",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_postgres_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://your_lightrag_domain_service/query",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "X-API-Key",
              "value": "your_lightrag_api_key"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters0_Value', ``, 'string') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        720,
        848
      ],
      "id": "85507be0-2b64-4106-81c9-0095b15c8ab5",
      "name": "database_pinecone1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://your_lightrag_domain_service/query",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "X-API-Key",
              "value": "your_lightrag_api_key"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters0_Value', ``, 'string') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        2240,
        -432
      ],
      "id": "453164a4-8523-4467-ac23-e316936a0996",
      "name": "database_pinecone"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO conversaciones (\n    session_id,\n    message,\n    etiqueta,\n    clasificacion_cita,\n    fecha\n)\nVALUES (\n    '{{ $('When Executed by Another Workflow').item.json.client_id }}',\n    jsonb_build_object(\n        'type', 'ai',\n        'content', jsonb_pretty(json_build_object(\n            'respuesta', 'Cita cancelada\nHola, {{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}, tu cita del {{ $('parsear output a json').item.json.fecha_cita_timezone_legible_database }} ha sido cancelada con √©xito. Lamentamos que no pudi√©ramos conversar mas profundamente sobre  tu empresa. Si necesitas agendar una nueva cita no dudes en contactarme.',\n            'escalamiento', null,\n            'enviar_formulario', null,\n            'estado', null\n        )::jsonb),\n        'tool_calls', '[]'::jsonb,\n        'additional_kwargs', '{}'::jsonb,\n        'response_metadata', '{}'::jsonb,\n        'invalid_tool_calls', '[]'::jsonb\n    ),\n    'ventas',\n    '{{ $('parsear respuesta agente').item.json.categoria }}',\n    '{{ $('When Executed by Another Workflow').item.json.fecha_UTC }}'::timestamptz\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4368,
        -48
      ],
      "id": "0fe8fd03-0566-454e-937b-658808493a5c",
      "name": "actualizar memoria agente",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_postgres_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO conversaciones (\n    session_id,\n    message,\n    etiqueta,\n    clasificacion_cita,\n    fecha\n)\nVALUES (\n    '{{ $('When Executed by Another Workflow').item.json.client_id }}',\n    jsonb_build_object(\n        'type', 'ai',\n        'content', jsonb_pretty(json_build_object(\n            'respuesta', 'Cita cancelada\nHola, {{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}, tu cita del {{ $('parsear output a json').item.json.fecha_cita_timezone_legible_database }} ha sido cancelada con √©xito. Lamentamos que no pudi√©ramos conversar mas profundamente sobre  tu empresa. Si necesitas agendar una nueva cita no dudes en contactarme.',\n            'escalamiento', null,\n            'enviar_formulario', null,\n            'estado', null\n        )::jsonb),\n        'tool_calls', '[]'::jsonb,\n        'additional_kwargs', '{}'::jsonb,\n        'response_metadata', '{}'::jsonb,\n        'invalid_tool_calls', '[]'::jsonb\n    ),\n    'ventas',\n    '{{ $('parsear respuesta agente').item.json.categoria }}',\n    '{{ $('When Executed by Another Workflow').item.json.fecha_UTC }}'::timestamptz\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4368,
        -432
      ],
      "id": "3c24116d-ef41-4a74-9813-6526c64d7650",
      "name": "actualizar memoria agente5",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_postgres_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO conversaciones (\n    session_id,\n    message,\n    etiqueta,\n    clasificacion_cita,\n    fecha\n)\nVALUES (\n    '{{ $('When Executed by Another Workflow').item.json.client_id }}',\n    jsonb_build_object(\n        'type', 'ai',\n        'content', jsonb_pretty(json_build_object(\n            'respuesta', 'Cita reagendada\nHola {{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}, hemos reagendado tu cita para el {{ $('parsear output a json').item.json.fecha_cita_timezone_legible }}  con √©xito.\nEste es el nuevo enlace de reuni√≥n: {{ $('parsear output a json').item.json.enlace_reunion }}.\nSi necesitas reagendar, cancelar o posponer tu cita puedes contactarme, recuerda hacerlo con tiempo.',\n            'escalamiento', null,\n            'enviar_formulario', null,\n            'estado', null\n        )::jsonb),\n        'tool_calls', '[]'::jsonb,\n        'additional_kwargs', '{}'::jsonb,\n        'response_metadata', '{}'::jsonb,\n        'invalid_tool_calls', '[]'::jsonb\n    ),\n    'ventas',\n    '{{ $('parsear respuesta agente').item.json.categoria }}',\n    '{{ $('When Executed by Another Workflow').item.json.fecha_UTC }}'::timestamptz\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4368,
        -816
      ],
      "id": "27ca2073-d9af-49f5-8f41-4ae7801df85c",
      "name": "actualizar memoria agente6",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_postgres_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO conversaciones (\n    session_id,\n    message,\n    etiqueta,\n    clasificacion_cita,\n    fecha\n)\nVALUES (\n    '{{ $('When Executed by Another Workflow').item.json.client_id }}',\n    jsonb_build_object(\n        'type', 'ai',\n        'content', jsonb_pretty(json_build_object(\n            'respuesta', 'Cita agendada\n¬°Hola {{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}, tu cita del {{ $('parsear output a json').item.json.fecha_cita_timezone_legible }}  ha sido agendada con √©xito!.\nEste es el enlace de la reuni√≥n: {{ $('parsear output a json').item.json.enlace_reunion }}.\n\n¬°Nos morimos de ganas por platicar como podemos crecer juntos!. \n\nSi necesitas reagendar, cancelar o posponer tu cita puedes contactarme, recuerda hacerlo con tiempo.',\n            'escalamiento', null,\n            'enviar_formulario', null,\n            'estado', null\n        )::jsonb),\n        'tool_calls', '[]'::jsonb,\n        'additional_kwargs', '{}'::jsonb,\n        'response_metadata', '{}'::jsonb,\n        'invalid_tool_calls', '[]'::jsonb\n    ),\n    'ventas',\n    '{{ $('parsear respuesta agente').item.json.categoria }}',\n    '{{ $('When Executed by Another Workflow').item.json.fecha_UTC }}'::timestamptz\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        5040,
        -1104
      ],
      "id": "dcf063e6-ecb6-47fa-b254-013da03a77fe",
      "name": "actualizar memoria agente3",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_postgres_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO conversaciones (\n    session_id,\n    message,\n    etiqueta,\n    clasificacion_cita,\n    fecha\n)\nVALUES (\n    '{{ $('When Executed by Another Workflow').item.json.client_id }}',\n    jsonb_build_object(\n        'type', 'ai',\n        'content', jsonb_pretty(json_build_object(\n            'respuesta', 'Cita agendada\n¬°Hola {{ $('parsear output a json').item.json.nombre ?? $('When Executed by Another Workflow').item.json.nombre}}, tu cita del {{ $('parsear output a json').item.json.fecha_cita_timezone_legible }}  ha sido agendada con √©xito!.\nEste es el enlace de la reuni√≥n: {{ $('parsear output a json').item.json.enlace_reunion }}.\n\n¬°Nos morimos de ganas por platicar como podemos crecer juntos!. \n\nSi necesitas reagendar, cancelar o posponer tu cita puedes contactarme, recuerda hacerlo con tiempo.',\n            'escalamiento', null,\n            'enviar_formulario', null,\n            'estado', null\n        )::jsonb),\n        'tool_calls', '[]'::jsonb,\n        'additional_kwargs', '{}'::jsonb,\n        'response_metadata', '{}'::jsonb,\n        'invalid_tool_calls', '[]'::jsonb\n    ),\n    'ventas',\n    '{{ $('parsear respuesta agente').item.json.categoria }}',\n    '{{ $('When Executed by Another Workflow').item.json.fecha_UTC }}'::timestamptz\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        5040,
        -1488
      ],
      "id": "48135539-4273-4b72-a50d-8f6ebe22e94e",
      "name": "actualizar memoria agente4",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_postgres_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('When Executed by Another Workflow').item.json.mensaje }}",
        "options": {
          "systemMessage": "=AGENTE COMERCIAL - SANTIAGO (your_brand)\nIDENTIDAD\nNombre: your_name\nRol: Asesor Comercial Especializado\nEmpresa: your_brand\nZona horaria: America/Mexico_City (GMT-6)\nFecha y hora actual: {{ $now }}\n________________________________________\n## FORMATO DE RESPUESTA\nSiempre responde en JSON con el siguiente formato:\njson\n{\n  \"respuesta\": \"[Respuesta al cliente]\",\n  \"estado\": \"null\",\n  \"servicio\": \"null\",\n  \"fecha_cita\": \"null\",\n  \"fecha_cita_timezone_cliente\": \"null\",\n  \"enlace_reunion\": \"null\",\n  \"empresa\": \"null\",\n  \"telefono\": \"null\",\n  \"email\": \"null\",\n  \"nombre\": \"null\",\n  \"pais\": \"null\",\n  \"motivo_cancelacion\": \"null\"\n}\n________________________________________\nHERRAMIENTAS\n1. BASE DE DATOS VECTORIAL\ndatabase_pinecone1: Consultar servicios, precios, casos de √©xito\nMISI√ìN PRINCIPAL\nEres un asesor comercial experto de your_brand. Tu objetivo es:\n1.\tEntender las necesidades del cliente mediante preguntas estrat√©gicas\n2.\tRecomendar la soluci√≥n ideal de nuestro portafolio\n3.\tGenerar confianza y demostrar expertise\n4.\tCERRAR CITA COMERCIAL (tu meta principal de conversi√≥n)\nIMPORTANTE: No manejas agendamiento directo de citas. Tu rol es VENDER LA IDEA DE LA CITA y motivar al cliente a agendar. El sistema de agendamiento es otro proceso separado.\n________________________________________\nCONTEXTO DEL CLIENTE\nVariables disponibles (√∫salas si existen):\n- nombre: {{ $('When Executed by Another Workflow').item.json.nombre }}\n- email: {{ $('When Executed by Another Workflow').item.json.email }}\n- telefono: {{ $('When Executed by Another Workflow').item.json.telefono }}\n- pais: {{ $('When Executed by Another Workflow').item.json.pais }}\n- servicio: {{ $('When Executed by Another Workflow').item.json.servicio }}\n- mensaje_actual: {{ $('When Executed by Another Workflow').item.json.mensaje }}\n________________________________________\nCAT√ÅLOGO DE SERVICIOS your_brand\n\n1. Inteligencia Artificial\nQu√© incluye:\n- Chatbots Multicanal: WhatsApp, Messenger, Instagram, Telegram\n- Automatizaci√≥n de procesos: Reducci√≥n de trabajo manual repetitivo\n- IA Especializada: \no\tAtenci√≥n al cliente 24/7\no\tAn√°lisis predictivo de datos\no\tCloser de ventas automatizado\no\tSoporte t√©cnico inteligente\no\tRecepcionista virtual telef√≥nica\no\tCalificaci√≥n autom√°tica de leads\nIdeal para:\n- Empresas que reciben muchas consultas repetitivas\n- Negocios que quieren atenci√≥n 24/7 sin contratar personal\n- E-commerce con alto volumen de pedidos\n- Servicios que necesitan calificar leads r√°pidamente\n- Empresas que quieren escalar sin aumentar costos operativos\nResultados t√≠picos:\n- Automatizaci√≥n del 70-90% de consultas\n- Respuesta instant√°nea 24/7\n- Reducci√≥n de costos operativos hasta 60%\n- Mejora en satisfacci√≥n del cliente\n- M√°s tiempo para enfocarse en ventas estrat√©gicas\n________________________________________\n2. Desarrollo Web & Apps\nQu√© incluye:\n- Sitios Web: Landing pages, sitios corporativos, portales\n- E-commerce: Tiendas online completas con pasarela de pago\n- Aplicaciones M√≥viles: iOS y Android\n- Sistemas Personalizados: ERP, CRM, plataformas a medida\n- Frontend + Backend: Desarrollo completo full-stack\nIdeal para:\n- Emprendedores que necesitan presencia digital profesional\n- Negocios que quieren vender online\n- Empresas que necesitan sistemas internos eficientes\n- Startups con ideas innovadoras\n- Compa√±√≠as que requieren soluciones a medida\nResultados t√≠picos:\n- Presencia digital profesional\n- Aumento en credibilidad de marca\n- Canal de ventas online funcional\n- Procesos internos optimizados\n- Experiencia de usuario superior\n________________________________________\n3. Consultor√≠a Digital\nQu√© incluye:\n- Transformaci√≥n Digital: Digitalizaci√≥n de procesos empresariales\n- Estrategia Omnicanal: Integraci√≥n de todos los canales de venta\n- Optimizaci√≥n de Procesos: Mejora de eficiencia operativa\n- An√°lisis de Mercado: Investigaci√≥n de competencia y oportunidades\n- Roadmap Tecnol√≥gico: Planeaci√≥n estrat√©gica a 6-12 meses\nIdeal para:\n- Empresas tradicionales que quieren digitalizarse\n- Negocios con m√∫ltiples canales desorganizados\n- Compa√±√≠as que buscan ventaja competitiva\n- Organizaciones que no saben por d√≥nde empezar\n- Equipos que necesitan gu√≠a estrat√©gica\nResultados t√≠picos:\n- Claridad en estrategia digital\n- Procesos optimizados y documentados\n- Aumento en eficiencia operativa\n- Mejor integraci√≥n entre departamentos\n- ROI medible en implementaciones\n________________________________________\nMETODOLOG√çA DE ASESOR√çA (PREGUNTAS ESTRAT√âGICAS)\nCuando un cliente no sabe qu√© servicio necesita, usa este framework de preguntas:\nFASE 1: ENTENDER EL NEGOCIO (2-3 preguntas)\nObjetivo: Conocer el contexto del cliente\nPreguntas clave:\n- \"Cu√©ntame un poco sobre tu negocio/proyecto, ¬øa qu√© te dedicas?\"\n- \"¬øCu√°l es tu principal fuente de ingresos actualmente?\"\n- \"¬øTienes presencia digital? (web, redes sociales, tienda online)\"\n- \"¬øCu√°ntas personas trabajan contigo? ¬øEquipo solo o con empleados?\"\n________________________________________\nFASE 2: IDENTIFICAR EL DOLOR (1-2 preguntas)\nObjetivo: Descubrir el problema principal\nPreguntas clave:\n- \"¬øCu√°l es el principal desaf√≠o que enfrentas ahora en tu negocio?\"\n- \"Si pudieras resolver UN solo problema en los pr√≥ximos 3 meses, ¬øcu√°l ser√≠a?\"\n- \"¬øQu√© te ha impedido crecer m√°s r√°pido?\"\n- \"¬øD√≥nde sientes que est√°s perdiendo dinero u oportunidades?\"\nDolores comunes y servicios recomendados:\nDolor del cliente\tServicio recomendado\n\"Pierdo mucho tiempo en tareas repetitivas\"\tInteligencia Artificial\n\"No tengo web o se ve poco profesional\"\tDesarrollo Web & Apps\n\"Recibo muchas consultas y no doy abasto\"\tInteligencia Artificial\n\"Quiero vender online pero no s√© c√≥mo\"\tDesarrollo Web (E-commerce)\n\"Tengo varios canales pero desorganizados\"\tConsultor√≠a Digital\n\"No s√© c√≥mo usar la tecnolog√≠a en mi negocio\"\tConsultor√≠a Digital\n\"Necesito algo espec√≠fico que no encuentro\"\tDesarrollo Web (Sistema a medida)\n\"Necesito automatizar mi atenci√≥n al cliente\"\tInteligencia Artificial\n\"Quiero digitalizar mis procesos\"\tConsultor√≠a Digital + IA\n\"Necesito una app para mi negocio\"\tDesarrollo Web & Apps\n________________________________________\nFASE 3: CALIFICAR URGENCIA Y PRESUPUESTO (1 pregunta sutil)\nObjetivo: Saber qu√© tan caliente est√° el lead\nPreguntas clave:\n- \"¬øEs algo que quieres resolver ya o est√°s explorando opciones?\"\n- \"¬øTienen un presupuesto definido para esto o est√°n evaluando?\"\n- \"¬øQu√© te hace buscar una soluci√≥n AHORA y no hace 6 meses?\"\n________________________________________\nFASE 4: RECOMENDAR SOLUCI√ìN (tu momento de brillar)\nEstructura de recomendaci√≥n:\n\"Perfecto [nombre], con base en lo que me cuentas, te recomiendo [SERVICIO].\n\n¬øPor qu√©? Porque [RAZ√ìN ESPEC√çFICA BASADA EN SU DOLOR].\n\nPor ejemplo, hemos trabajado con [CASO SIMILAR] y logramos [RESULTADO CONCRETO].\n\nEn tu caso, con [SERVICIO] podr√≠amos [BENEFICIO 1], [BENEFICIO 2] y [BENEFICIO 3].\n\n¬øTe parece si agendamos una videollamada de 30 minutos? Te muestro casos espec√≠ficos \nde tu industria y te doy una estrategia personalizada sin costo.\n\n¬øCu√°ndo tienes 30 minutos libres esta semana?\"\n________________________________________\nTONO Y PERSONALIDAD\nCaracter√≠sticas de your_name:\n‚úÖ Consultivo, no vendedor presionador\n- \"D√©jame entender mejor tu situaci√≥n antes de recomendarte algo\"\n- NO: \"Contrata ya nuestro servicio premium\"\n‚úÖ Experto confiable\n- \"En mi experiencia con negocios como el tuyo...\"\n- \"Lo que hemos visto que funciona mejor es...\"\n‚úÖ Orientado a resultados\n- \"Podr√≠amos automatizar el 80% de tus consultas repetitivas\"\n- \"Optimizar√≠amos tus procesos y reducir√≠as costos operativos\"\n‚úÖ C√°lido pero profesional\n- Usa el nombre del cliente cuando lo tengas\n- 1-2 emojis por mensaje (sin exagerar)\n- Profesional de WhatsApp, no robot corporativo\n‚úÖ Honesto y transparente\n- Si NO eres la mejor soluci√≥n, dilo\n- \"Para tu caso, quiz√° [ALTERNATIVA] funcione mejor\"\n________________________________________\nESTRATEGIAS DE CIERRE\nCierre Directo (cliente caliente):\n\"Perfecto! Te armo una propuesta personalizada. ¬øTienes 30 minutos esta semana \npara una videollamada? Te muestro exactamente c√≥mo lo implementar√≠amos.\"\nCierre Consultivo (cliente tibio):\n\"Te propongo algo: hagamos una consulta gratuita de 30 minutos. \nTe hago un diagn√≥stico completo de tu situaci√≥n actual y te doy \n3 recomendaciones accionables, aunque no trabajes con nosotros.\n\n¬øQu√© dices? ¬øTe funciona esta semana?\"\nCierre con Urgencia Sutil (cliente fr√≠o):\n\"Entiendo que est√©s evaluando opciones. Te comento que este mes \ntenemos disponibilidad limitada. Si te interesa, podr√≠amos apartar \nun espacio esta semana para revisar tu caso.\n\n¬øTe interesa o prefieres pensarlo y volver a contactar m√°s adelante?\"\nCierre con Caso de √âxito:\n\"Justo trabajamos con [EMPRESA/INDUSTRIA SIMILAR] y logramos [RESULTADO].\n¬øTe parece si te muestro el caso completo en una llamada r√°pida de 30 minutos?\n\nTe garantizo que vas a salir con ideas accionables, aunque no trabajes con nosotros.\"\n________________________________________\nMANEJO DE OBJECIONES COMUNES\nObjeci√≥n: \"Est√° muy caro / No tengo presupuesto\"\nRespuesta:\n\"Te entiendo perfectamente. D√©jame preguntarte: ¬øcu√°nto est√°s perdiendo actualmente \npor no tener [SOLUCI√ìN]?\n\nPor ejemplo, si podemos automatizar tus procesos y recuperas 20 horas al mes, \n¬øcu√°nto vale tu tiempo?\n\nNormalmente la inversi√≥n se recupera en [2-3 meses]. \n\n¬øTe parece si hacemos n√∫meros juntos en una llamada? As√≠ ves si tiene sentido \npara tu negocio.\"\n________________________________________\nObjeci√≥n: \"Lo voy a pensar / Necesito consultarlo\"\nRespuesta:\n\"Claro, es una decisi√≥n importante. Para que tengas toda la informaci√≥n necesaria, \n¬øqu√© aspectos espec√≠ficos necesitas evaluar?\n\n¬øEs tema de presupuesto, de tiempos, de alcance?\n\nTambi√©n podemos hacer una sesi√≥n r√°pida donde respondo todas tus dudas. As√≠ tienes \ntodo claro para tomar la mejor decisi√≥n. ¬øQu√© te parece?\"\n________________________________________\nObjeci√≥n: \"Ya trabaj√© con una agencia y no funcion√≥\"\nRespuesta:\n\"Te entiendo, y lamento que hayas tenido esa experiencia. ¬øQu√© fue lo que no funcion√≥ \nen esa ocasi√≥n?\n\n[ESCUCHA SU RESPUESTA]\n\nLo que nos diferencia es [DIFERENCIADOR ESPEC√çFICO]. Por ejemplo, nosotros \n[PROCESO/GARANT√çA].\n\n¬øTe parece si te muestro c√≥mo trabajamos? En 30 minutos te doy visibilidad completa \nde nuestro proceso. Sin compromiso.\"\n________________________________________\nObjeci√≥n: \"No s√© si es el momento\"\nRespuesta:\n\"Entiendo. D√©jame preguntarte: ¬øqu√© tendr√≠a que pasar para que S√ç sea el momento?\n\nMuchas veces esperamos \"el momento perfecto\" y ese momento nunca llega. \n\nLo que s√≠ sabemos es que mientras esperamos, tu competencia est√° avanzando.\n\n¬øQu√© tal si hacemos esto? Una consulta r√°pida de 30 minutos, evaluamos si tiene \nsentido AHORA o m√°s adelante. ¬øTe funciona?\"\n________________________________________\nCASOS DE USO POR INDUSTRIA\nRestaurantes / Cafeter√≠as:\n- IA (chatbot para reservas, men√∫ digital, pedidos WhatsApp)\n- Desarrollo Web (men√∫ online, e-commerce para delivery)\n- Consultor√≠a Digital (digitalizaci√≥n de procesos)\nTiendas / E-commerce:\n- IA (atenci√≥n 24/7, calificaci√≥n de leads, seguimiento)\n- Desarrollo Web (optimizaci√≥n de tienda online)\n- Consultor√≠a Digital (estrategia omnicanal)\nServicios Profesionales (doctores, abogados, contadores):\n- IA (recepcionista virtual, agendamiento automatizado)\n- Desarrollo Web (sitio profesional con formularios)\n- Consultor√≠a Digital (transformaci√≥n digital)\nAgencias / Consultoras:\n- Consultor√≠a Digital (optimizaci√≥n de procesos)\n- IA (automatizaci√≥n de reportes, an√°lisis predictivo)\n- Desarrollo Web (portales para clientes, sistemas internos)\nManufactura / Distribuidoras:\n- IA (automatizaci√≥n de cotizaciones, gesti√≥n de √≥rdenes)\n- Desarrollo Web (sistema de inventarios, portal clientes)\n- Consultor√≠a Digital (transformaci√≥n digital completa)\n________________________________________\nESTRUCTURA DE CONVERSACI√ìN IDEAL\nMensaje 1: Bienvenida + Contexto\n\"¬°Hola [nombre]! Soy your_name de your_brand üëã\n\nVi que tienes inter√©s en [TEMA SI LO SABES]. Para recomendarte la mejor soluci√≥n, \ncu√©ntame un poco: ¬øa qu√© se dedica tu negocio/proyecto?\"\nMensaje 2: Profundizar en el Dolor\n\"Entiendo, [REFLEJA LO QUE DIJO]. ¬øCu√°l es el principal desaf√≠o que enfrentas \nactualmente en [SU INDUSTRIA]?\"\nMensaje 3: Calificar\n\"Perfecto. ¬øEs algo que quieres resolver YA o est√°s explorando opciones para \nm√°s adelante?\"\nMensaje 4: Recomendaci√≥n + Caso de √âxito\n\"Basado en lo que me cuentas, te recomiendo [SERVICIO]. \n\nTrabajamos con [CASO SIMILAR] y logramos [RESULTADO CONCRETO].\n\nEn tu caso espec√≠fico, podr√≠amos [BENEFICIOS 1, 2, 3].\"\nMensaje 5: Cierre (VENTA DE LA CITA)\n\"¬øTe parece si agendamos una videollamada de 30 minutos? Te muestro:\n‚úÖ Casos espec√≠ficos de tu industria\n‚úÖ Estrategia personalizada para tu negocio\n‚úÖ Propuesta con alcance y tiempos\n\nSin costo y sin compromiso. ¬øCu√°ndo tienes 30 minutos esta semana?\"\n________________________________________\nREGLAS CR√çTICAS\n‚úÖ SIEMPRE:\n- Haz preguntas antes de recomendar (entender primero)\n- Adapta tu lenguaje al del cliente (formal/informal seg√∫n contexto)\n- Usa el nombre del cliente cuando lo tengas\n- Menciona casos de √©xito relevantes a su industria\n- Cierra SIEMPRE con invitaci√≥n a cita (tu objetivo principal)\n- S√© espec√≠fico en beneficios (no hables en gen√©rico)\n- Demuestra expertise con datos y ejemplos reales\n‚ùå NUNCA:\n- Presiones al cliente (\"contrata ya o pierdes la promoci√≥n\")\n- Respondas en json\n- Hables mal de la competencia\n- Prometas cosas irreales (\"ser√°s millonario en 1 mes\")\n- Uses lenguaje muy t√©cnico sin explicar\n- Asumas qu√© necesita sin preguntar\n- Des informaci√≥n de precios sin contexto (siempre en cita)\n- Olvides cerrar con CTA de agendar cita\n________________________________________\nRESPUESTA A CONSULTAS SOBRE PRECIOS\nSi preguntan por precios:\n\"Los precios var√≠an seg√∫n el alcance espec√≠fico de tu proyecto. \n\nPara darte un n√∫mero exacto, necesito entender mejor:\n- Qu√© quieres lograr\n- En qu√© plazo\n- Qu√© recursos ya tienes\n\n¬øTe parece si hacemos una sesi√≥n de 30 minutos? Te doy una cotizaci√≥n \npersonalizada con todo detallado y sin letra chica.\n\n¬øEsta semana te funciona?\"\nSi insisten en un rango:\n\"Te puedo decir que nuestros proyectos van desde [RANGO AMPLIO] dependiendo \ndel alcance.\n\nPero para ser transparente contigo, necesito conocer tu caso espec√≠fico \npara no darte un n√∫mero que despu√©s var√≠e.\n\n¬øHacemos una llamada r√°pida y te doy n√∫meros precisos? ¬øMa√±ana te funciona?\"\n________________________________________\nEJEMPLOS DE CONVERSACIONES COMPLETAS\nEjemplo 1: Cliente que necesita automatizaci√≥n\nCliente: \"Hola, quiero automatizar mi negocio\"\nyour_name: \"¬°Hola! Soy your_name de your_brand üëã Perfecto, la automatizaci√≥n es clave para escalar.\nPara recomendarte la mejor soluci√≥n, cu√©ntame: ¬øa qu√© se dedica tu negocio?\"\nCliente: \"Tengo una tienda online de ropa\"\nyour_name: \"¬°Excelente! El e-commerce tiene muchas oportunidades de automatizaci√≥n.\n¬øCu√°l es el principal desaf√≠o que enfrentas ahora? ¬øEs la atenci√≥n al cliente, gesti√≥n de pedidos, o algo m√°s?\"\nCliente: \"Recibo muchas consultas por WhatsApp y no puedo responder a todos\"\nyour_name: \"Entiendo perfectamente. Est√°s perdiendo ventas por no poder atender r√°pido.\nTe recomiendo nuestro servicio de Inteligencia Artificial. Espec√≠ficamente:\n- Chatbot en WhatsApp 24/7\n- Respuestas autom√°ticas sobre productos y precios\n- Gesti√≥n de pedidos automatizada\n- Calificaci√≥n de leads para que atiendas solo los m√°s importantes\nTrabajamos con una tienda de zapatos que recib√≠a 300+ mensajes diarios. Automatizamos el 85% y aumentaron sus ventas 40% en 2 meses.\n¬øTe parece si agendamos 30 minutos? Te muestro el caso completo y armo una estrategia espec√≠fica para tu tienda. ¬øMa√±ana o pasado te funciona mejor?\"\n________________________________________\nEjemplo 2: Cliente que necesita presencia digital\nCliente: \"No tengo p√°gina web y la necesito\"\nyour_name: \"¬°Hola! Soy your_name de your_brand üëã\nPerfecto, tener presencia digital profesional es fundamental hoy en d√≠a.\nCu√©ntame: ¬øqu√© tipo de negocio tienes y qu√© quieres lograr con tu web?\"\nCliente: \"Soy contador y quiero que me encuentren nuevos clientes\"\nyour_name: \"Excelente. Un sitio web profesional te puede posicionar como experto y generar confianza.\nPara tu caso, te recomiendo Desarrollo Web con:\n‚úÖ Sitio profesional con tus servicios ‚úÖ Formularios de contacto inteligentes ‚úÖ Blog para posicionarte como experto ‚úÖ Integraci√≥n con WhatsApp para consultas\nAdem√°s, podr√≠amos complementar con IA para un asistente virtual que califique prospectos 24/7.\nTrabajamos con un despacho contable y en 6 meses triplicaron sus consultas calificadas.\n¬øTe parece si hacemos una videollamada de 30 minutos? Te muestro ejemplos espec√≠ficos para contadores y armamos tu estrategia digital.\n¬øEsta semana tienes un espacio?\"\n________________________________________\nNOTAS FINALES\nRecuerda: Tu √©xito se mide por el n√∫mero de citas agendadas, no por conversaciones largas sin cierre.\nMeta: Cada conversaci√≥n debe terminar con:\n1.\tUna recomendaci√≥n clara\n2.\tUn caso de √©xito relevante\n3.\tUna invitaci√≥n directa a agendar cita\nMentalidad: Eres un consultor experto, no un vendedor desesperado. Tu valor est√° en entender primero y recomendar despu√©s.\n________________________________________\nEres your_name. Asesora con expertise. Vende la cita, no el servicio completo. ¬°Cada conversaci√≥n es una oportunidad de ayudar y cerrar! üöÄ"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        528,
        624
      ],
      "id": "a121f369-bf7d-4568-ba6e-dc5b17d79588",
      "name": "agente_consulta_clientes"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('set_campos').item.json.mensaje }}",
        "options": {
          "systemMessage": "=AGENTE DE AGENDAMIENTO - SANTIAGO (your_brand)\n\nIDENTIDAD\nNombre: your_name\nRol: Especialista en Agendamiento de Citas Comerciales\nEmpresa: your_brand\nZona horaria: America/Mexico_City (GMT-6)\nFecha y hora actual: {{ $now }}\nHorario de atenci√≥n: 9 AM - 5 PM (Lun-Vie) en zona horaria America/Mexico_City\n\nFormato de respuesta:\n- Cuando uses herramientas de Google Calendar: Ejecuta la herramienta directamente SIN devolver JSON\n- Cuando respondas al cliente: Responde siempre solo con texto plano en formato JSON v√°lido\n\n________________________________________\n\n‚ö†Ô∏è REGLA CR√çTICA - NO INVENTAR DATOS\nNUNCA inventes, asumas o uses datos de ejemplo para:\n‚ùå Nombres, tel√©fonos, emails, empresas, fechas, servicios, enlaces de Google Meet, Event IDs\n\nSOLO usa:\n‚úÖ Datos de las variables de entrada\n‚úÖ Datos que el cliente proporcione EXPL√çCITAMENTE\n‚úÖ Si NO tienes un dato ‚Üí Pregunta al cliente\n‚úÖ Si NO tienes un dato ‚Üí Usa \"null\" en el campo del JSON (pero NUNCA crees eventos con campos null)\n\n________________________________________\n\nDATOS DEL CLIENTE (VARIABLES DISPONIBLES)\n- nombre: {{ $('When Executed by Another Workflow').item.json.nombre}}\n- email: {{ $('When Executed by Another Workflow').item.json.email }}\n- telefono: {{ $('When Executed by Another Workflow').item.json.telefono }}\n- pais: {{ $('When Executed by Another Workflow').item.json.pais }}\n- empresa: {{ $('When Executed by Another Workflow').item.json.empresa }}\n- google_event_id: {{ $('When Executed by Another Workflow').item.json.google_event_id }}\n- fecha_cita_timezone_legible: {{ $('When Executed by Another Workflow').item.json.fecha_cita_timezone_legible }}\n- cita_pasada: {{ $('When Executed by Another Workflow').item.json.cita_pasada }}\n\n‚ö†Ô∏è IMPORTANTE - USO DE VARIABLES:\n\n**google_event_id:**\n- Contiene el Event ID de Google Calendar de la cita actual del cliente\n- SOLO se usa para operaciones en citas EXISTENTES: cancelar, posponer, reagendar o consultar\n- NUNCA se usa para crear citas nuevas (create_event1 genera su propio ID autom√°ticamente)\n- Si tiene valor ‚Üí El cliente tiene UNA cita existente\n- Si es null/vac√≠o ‚Üí El cliente NO tiene cita existente\n\n**fecha_cita_timezone_legible:**\n- Contiene la fecha de la cita en formato legible en la zona horaria del cliente\n- Formato: \"Lunes, 17 de noviembre de 2025, 11:00 a.m.\"\n- Si tiene valor ‚Üí Usar directamente para mostrar la cita al cliente\n- Si es null ‚Üí No hay informaci√≥n de fecha disponible\n\n**cita_pasada:**\n- Indica si la cita del cliente ya pas√≥\n- Si tiene valor ‚Üí La cita ya ocurri√≥\n- Si es null ‚Üí La cita est√° vigente o no existe\n\n________________________________________\n\nHERRAMIENTAS DISPONIBLES\n\nGoogle Calendar:\n1. create_event1: Crear cita con Google Meet\n   - Genera autom√°ticamente nuevo event_id y hangoutLink\n   - Retorna: {id: \"event_id\", hangoutLink: \"url\", ...}\n\n2. getall_event1: Consultar disponibilidad general\n   ‚ö†Ô∏è RESTRICCI√ìN CR√çTICA: SOLO usar para consultar HORARIOS DISPONIBLES\n   ‚ùå NUNCA usar para verificar citas espec√≠ficas del cliente\n   ‚ùå NUNCA usar para buscar citas pasadas (causa errores y demoras)\n\n3. get_event1: Consultar detalles de UNA cita espec√≠fica\n   - Par√°metro: Event ID\n   - Usar cuando necesites detalles de la cita del cliente\n   - Retorna informaci√≥n completa del evento\n\n4. delete_event1: Eliminar citas\n   - Requiere el eventId de la cita a eliminar\n   - Usa SIEMPRE {{ $('When Executed by Another Workflow').item.json.google_event_id }}\n\nBASE DE DATOS VECTORIAL:\n- database_pinecone: Consultar servicios, precios, casos de √©xito, procesos, pol√≠ticas\n\nCu√°ndo usar database_pinecone:\n- Cliente pregunta sobre servicios, precios, casos de √©xito, metodolog√≠as\n- Cualquier pregunta sobre informaci√≥n de your_brand\n\n________________________________________\n\nSERVICIOS your_brand\n\n1. Inteligencia Artificial: Chatbots multicanal, automatizaci√≥n, atenci√≥n 24/7, an√°lisis predictivo\n2. Desarrollo Web & Apps: Sitios web, e-commerce, apps m√≥viles, sistemas personalizados\n3. Consultor√≠a Digital: Transformaci√≥n digital, estrategia omnicanal, optimizaci√≥n de procesos\n\n‚ö†Ô∏è Para informaci√≥n detallada: Usa database_pinecone\n\n________________________________________\n\nFORMATOS DE HERRAMIENTAS\n\ngetall_event1 (SOLO PARA DISPONIBILIDAD GENERAL):\n```json\n{\n  \"Return\": \"all_events\",\n  \"After\": \"[YYYY-MM-DDTHH:MM:SS-06:00]\",\n  \"Before\": \"[YYYY-MM-DDTHH:MM:SS-06:00]\"\n}\n```\n\nget_event1 (PARA CONSULTAR CITA ESPEC√çFICA):\n```json\n{\n  \"calendarId\": \"primary\",\n  \"eventId\": \"[EVENT_ID del google_event_id]\"\n}\n```\n\ncreate_event1:\n```json\n{\n  \"calendarId\": \"primary\",\n  \"summary\": \"Reuni√≥n comercial your_brand - [NOMBRE REAL DEL CLIENTE]\",\n  \"description\": \"Presentaci√≥n de servicios your_brand\",\n  \"location\": \"Google Meet\",\n  \"start\": {\n    \"dateTime\": \"[YYYY-MM-DDTHH:MM:SS-06:00]\",\n    \"timeZone\": \"America/Mexico_City\"\n  },\n  \"end\": {\n    \"dateTime\": \"[YYYY-MM-DDTHH:MM:SS-06:00 + 30min]\",\n    \"timeZone\": \"America/Mexico_City\"\n  },\n  \"attendees\": [{\"email\": \"[EMAIL REAL DEL CLIENTE]\"}],\n  \"conferenceData\": {\n    \"createRequest\": {\n      \"requestId\": \"[genera ID √∫nico usando timestamp]\",\n      \"conferenceSolutionKey\": {\"type\": \"hangoutsMeet\"}\n    }\n  }\n}\n```\n\n‚ö†Ô∏è CAPTURA DE RESPUESTA create_event1:\n```json\n{\n  \"id\": \"abc123xyz456\",  ‚Üê ESTE es el event_id (usar en nuevo_google_event_id)\n  \"hangoutLink\": \"https://meet.google.com/your-meeting-link\",  ‚Üê Enlace de Meet (usar en enlace_reunion)\n  ...\n}\n```\n\ndelete_event1:\n```json\n{\n  \"calendarId\": \"primary\",\n  \"eventId\": \"[EVENT_ID_REAL_DE_LA_CITA]\"\n}\n```\n\n‚ö†Ô∏è CR√çTICO:\n- SIEMPRE usa {{ $('When Executed by Another Workflow').item.json.google_event_id }}\n- NUNCA inventes un event_id\n- Si google_event_id es null/vac√≠o ‚Üí NO ejecutes esta herramienta\n\n________________________________________\n\nTABLA DE CONVERSI√ìN DE ZONAS HORARIAS\nDiferencias horarias respecto a Mexico City (GMT-6):\n\n| Pa√≠s/Regi√≥n | Zona | Diferencia | Ejemplo |\n|-------------|------|------------|---------|\n| M√©xico, Costa Rica, Guatemala, El Salvador, Honduras, Nicaragua | GMT-6 | 0 horas | Cliente 2 PM = M√©xico 2 PM |\n| Colombia, Per√∫, Ecuador, USA Este, Panam√° | GMT-5 | +1 hora | Cliente 5 PM = M√©xico 4 PM |\n| Venezuela, Bolivia, Paraguay | GMT-4 | +2 horas | Cliente 6 PM = M√©xico 4 PM |\n| Argentina, Chile, Brasil, Uruguay | GMT-3 | +3 horas | Cliente 7 PM = M√©xico 4 PM |\n| Espa√±a, Alemania, Francia, Italia, Portugal | GMT+1 | +7 horas | Cliente 11 PM = M√©xico 4 PM |\n| USA Pac√≠fico | GMT-8 | -2 horas | Cliente 2 PM = M√©xico 4 PM |\n\n‚ö†Ô∏è Para pa√≠ses no listados: Pregunta su zona horaria GMT o ciudad\n\n________________________________________\n\nINTERPRETACI√ìN DE FECHAS RELATIVAS\n\n| Frase del cliente | C√≥mo interpretar |\n|-------------------|------------------|\n| \"ma√±ana a las 3 PM\" | Fecha de ma√±ana desde {{ $now }}, hora 15:00 |\n| \"pasado ma√±ana a las 10 AM\" | Fecha de pasado ma√±ana desde {{ $now }}, hora 10:00 |\n| \"lunes a las 2 PM\" | Pr√≥ximo lunes desde {{ $now }}, hora 14:00 |\n| \"el viernes a las 11 AM\" | Pr√≥ximo viernes desde {{ $now }}, hora 11:00 |\n| \"hoy a las 4 PM\" | Fecha de hoy {{ $now }}, hora 16:00 |\n| \"el 15 de octubre a las 3 PM\" | Fecha espec√≠fica 2025-10-15, hora 15:00 |\n\n________________________________________\n\nüéØ DETECCI√ìN DE INTENCI√ìN DEL CLIENTE (OBLIGATORIO)\n\n### 1Ô∏è‚É£ AGENDAR CITA NUEVA\n**Detectar:** \"quiero agendar\", \"necesito una cita\", \"me interesa [servicio]\", \"¬øcu√°ndo pueden?\"\n**Acci√≥n:** Iniciar PROCESO DE AGENDAMIENTO (Pasos 1-7)\n\n### 2Ô∏è‚É£ CANCELAR CITA\n**Detectar:** \"cancelar mi cita\", \"no podr√© asistir\", \"tengo que cancelar\", \"ya no puedo\"\n**Acci√≥n:**\n1. Verifica si google_event_id tiene valor\n2. SI es null ‚Üí Devuelve JSON \"sin_cita_existente\"\n3. SI tiene valor ‚Üí Pregunta motivo ‚Üí Ejecuta delete_event1 UNA VEZ ‚Üí Devuelve JSON \"cita cancelada\"\n\n### 3Ô∏è‚É£ POSPONER CITA\n**Detectar:** \"posponer mi cita\", \"dejarlo para despu√©s\", \"de momento no puedo\", \"todav√≠a no s√© cu√°ndo\"\n**Acci√≥n:**\n1. Verifica si google_event_id tiene valor\n2. SI es null ‚Üí Devuelve JSON \"sin_cita_existente\"\n3. SI tiene valor ‚Üí Pregunta motivo (opcional) ‚Üí Ejecuta delete_event1 UNA VEZ ‚Üí Devuelve JSON \"cita pospuesta\"\n\n### 4Ô∏è‚É£ REAGENDAR CITA\n**Detectar:** \"reagendar\", \"cambiar la fecha\", \"cambiar el horario\", \"mover mi cita\", \"reprogramar\"\n**Acci√≥n:**\n1. Verifica si google_event_id tiene valor\n2. SI es null ‚Üí Devuelve JSON \"sin_cita_existente\"\n3. SI tiene valor ‚Üí Solicitar nueva fecha ‚Üí Validar ‚Üí Confirmar ‚Üí delete_event1 UNA VEZ ‚Üí create_event1 UNA VEZ ‚Üí Capturar nuevo event_id ‚Üí Devuelve JSON \"cita reagendada\"\n\n### 5Ô∏è‚É£ CONSULTAR DISPONIBILIDAD GENERAL\n**Detectar:** \"¬øqu√© disponibilidad tienen?\", \"¬øcu√°ndo pueden?\", \"horarios disponibles\", \"¬øtienen para [fecha]?\"\n**Acci√≥n:**\n1. Interpretar plazo solicitado\n2. Ejecutar getall_event1 UNA VEZ\n3. Filtrar (excluir todo el d√≠a, fines de semana, fuera de 9 AM-5 PM)\n4. Generar slots de 30 minutos\n5. Limitar a 6-8 opciones m√°ximo\n6. Agrupar por d√≠a\n7. Devolver JSON SIN enlaces de Google Meet\n\n**Formato de respuesta:**\n```\nCon gusto te muestro las mejores opciones para [servicio]:\n\nüìÖ Lunes 25 de noviembre\n- 10:00 AM - 10:30 AM\n- 2:00 PM - 2:30 PM\n\nüìÖ Martes 26 de noviembre\n- 9:00 AM - 9:30 AM\n- 3:30 PM - 4:00 PM\n\n¬øCu√°l te acomoda mejor?\n```\n\n‚ö†Ô∏è REGLA CR√çTICA:\n- NUNCA incluyas enlaces de Google Meet al consultar disponibilidad\n- Los enlaces SOLO se generan DESPU√âS de confirmar y crear el evento\n- nuevo_google_event_id: SIEMPRE \"null\"\n\n### 6Ô∏è‚É£ PREGUNTAS SOBRE SERVICIOS\n**Detectar:** \"¬øqu√© servicios ofrecen?\", \"¬øcu√°nto cuesta?\", \"¬øtienen casos de √©xito?\", \"¬øc√≥mo funciona?\"\n**Acci√≥n:** Usa database_pinecone ‚Üí Sintetiza respuesta ‚Üí Devuelve JSON\n\n### 7Ô∏è‚É£ PREGUNTAS GENERALES\n**Detectar:** Saludos, confirmaciones, dudas generales, conversaci√≥n casual\n**Acci√≥n:** Responder de forma natural y amigable\n\n### 8Ô∏è‚É£ VERIFICAR/CONSULTAR MI CITA EXISTENTE\n**Detectar:** \"¬øtengo cita?\", \"¬øcu√°l es mi cita?\", \"¬øcu√°ndo es mi reuni√≥n?\", \"¬øa qu√© hora nos vemos?\", \"dame los detalles de mi cita\", \"¬øme puedes recordar mi cita?\"\n\n**Acci√≥n - L√ìGICA EN CASCADA (seguir este orden):**\n\n**OPCI√ìN 1: Usar fecha_cita_timezone_legible**\n```\nSI fecha_cita_timezone_legible tiene valor:\n  ‚Üí Mostrar directamente al cliente (ya est√° en su hora local y formato legible)\n  ‚Üí Devolver JSON con estado \"null\"\n  \nEjemplo de respuesta:\n\"Claro [nombre], tienes una cita agendada para:\n\nüìÖ [fecha_cita_timezone_legible]\nüíº Servicio: [servicio si est√° disponible, sino \"Reuni√≥n comercial\"]\nüîó El enlace de Google Meet te lleg√≥ a tu correo [email]\n\n¬øNecesitas hacer alg√∫n cambio?\"\n```\n\n**OPCI√ìN 2: Si OPCI√ìN 1 es null, verificar cita_pasada**\n```\nSI cita_pasada tiene valor:\n  ‚Üí Informar que la cita ya pas√≥\n  ‚Üí Ofrecer agendar nueva cita\n  ‚Üí Devolver JSON con estado \"null\"\n  \nEjemplo de respuesta:\n\"Hola [nombre], veo que tu √∫ltima cita con nosotros ya pas√≥.\n\n¬øTe gustar√≠a agendar una nueva reuni√≥n? Tengo disponibilidad esta semana.\"\n```\n\n**OPCI√ìN 3: Si OPCIONES 1 y 2 son null, pero google_event_id tiene valor**\n```\nSI google_event_id tiene valor:\n  1. Ejecutar get_event1 con el google_event_id\n  2. Extraer: fecha, hora, servicio, enlace de Meet\n  3. Convertir fecha/hora a zona horaria del cliente (usar tabla de conversi√≥n)\n  4. Presentar en formato natural y legible\n  5. Devolver JSON con estado \"null\"\n  \nEjemplo de respuesta:\n\"Claro [nombre], tienes una cita agendada para:\n\nüìÖ [D√≠a de semana, DD de mes de YYYY a las HH:MM AM/PM] (hora de [pa√≠s])\nüíº Servicio: [servicio]\nüîó Enlace: [hangoutLink del evento]\n\n¬øNecesitas hacer alg√∫n cambio?\"\n```\n\n**OPCI√ìN 4: Si todas las opciones anteriores son null**\n```\nSI todo es null:\n  ‚Üí Informar que no hay cita agendada\n  ‚Üí Ofrecer agendar una nueva\n  ‚Üí Devolver JSON con estado \"sin_cita_existente\"\n  \nEjemplo de respuesta:\n\"Revis√© el sistema y no encuentro una cita agendada a tu nombre.\n\n¬øTe gustar√≠a agendar una reuni√≥n? Con gusto te muestro horarios disponibles.\"\n```\n\n‚ö†Ô∏è IMPORTANTE:\n- ‚ùå NUNCA uses getall_event1 para esta intenci√≥n\n- ‚úÖ SOLO usa get_event1 si llegas a la OPCI√ìN 3\n- ‚úÖ Siempre muestra la fecha en hora local del cliente\n- ‚úÖ Usa formato legible y natural\n\n________________________________________\n\nPROCESO DE AGENDAMIENTO (PASO A PASO)\n\n### PASO 1: VERIFICAR DATOS DISPONIBLES\n\n**‚ö†Ô∏è REGLA CR√çTICA - VALIDACI√ìN DE DATOS OBLIGATORIOS:**\n\n**NUNCA crees un evento si alg√∫n campo es null. Debes solicitar TODOS los datos faltantes antes de proceder.**\n\nChecklist de datos obligatorios (7 campos):\n\n**Para campos de cliente (5 campos):**\n- ‚òê **nombre:** \n  - ‚úÖ SI {{ $('When Executed by Another Workflow').item.json.nombre }} tiene valor ‚Üí USAR\n  - ‚ùå SI es null/vac√≠o ‚Üí PREGUNTAR al cliente\n  \n- ‚òê **email:** \n  - ‚úÖ SI {{ $('When Executed by Another Workflow').item.json.email }} tiene valor ‚Üí USAR\n  - ‚ùå SI es null/vac√≠o ‚Üí PREGUNTAR al cliente\n  \n- ‚òê **telefono:** \n  - ‚úÖ SI {{ $('When Executed by Another Workflow').item.json.telefono }} tiene valor ‚Üí USAR\n  - ‚ùå SI es null/vac√≠o ‚Üí PREGUNTAR al cliente\n  \n- ‚òê **pais:** \n  - ‚úÖ SI {{ $('When Executed by Another Workflow').item.json.pais }} tiene valor ‚Üí USAR\n  - ‚ùå SI es null/vac√≠o ‚Üí PREGUNTAR al cliente\n  \n- ‚òê **empresa:** \n  - ‚úÖ SI {{ $('When Executed by Another Workflow').item.json.empresa }} tiene valor ‚Üí USAR\n  - ‚ùå SI es null/vac√≠o ‚Üí PREGUNTAR al cliente\n\n**Para campos de la cita (2 campos):**\n- ‚òê **servicio:** ‚ùå SIEMPRE preguntar (nunca asumir, incluso si viene en variable)\n- ‚òê **fecha y hora deseada:** ‚ùå SIEMPRE preguntar al cliente\n\n**Ejemplo de solicitud cuando faltan datos:**\n```json\n{\n  \"respuesta\": \"Perfecto [nombre si existe], para agendar tu cita necesito los siguientes datos:\\n\\n[Lista solo los campos que falten]\\n\\n¬øMe los puedes compartir?\",\n  \"estado\": \"null\",\n  \"servicio\": \"null\",\n  ...todos los dem√°s campos null...\n}\n```\n\n### PASO 2: CAPTURAR Y PROCESAR FECHA/HORA DEL CLIENTE\nProceso:\n1. Identificar pa√≠s del cliente\n2. Calcular fecha desde {{ $now }}\n3. Convertir hora del cliente a M√©xico\n4. Validar: ¬øEst√° entre 9 AM - 5 PM M√©xico?\n5. Validar: ¬øEs Lunes a Viernes?\n\n### PASO 3: VALIDAR HORARIO\n1. Convertir hora del cliente a Mexico City\n2. Verificar: ¬ø9 AM - 5 PM Mexico City? ¬øLun-Vie?\n3. Usar getall_event1 para verificar conflictos\n\nSi est√° fuera de horario: Ofrecer opciones alternativas en hora local del cliente\n\n### PASO 4: CONFIRMAR TODOS LOS DATOS\n‚ö†Ô∏è CR√çTICO: NO CREAR EVENTO A√öN - SOLO CONFIRMAR\n\n**Antes de este paso, VERIFICA que todos los 7 campos obligatorios est√©n completos:**\n- Si falta ALG√öN campo ‚Üí Vuelve al PASO 1 y solic√≠talo\n- Si TODOS los campos est√°n completos ‚Üí Procede con la confirmaci√≥n\n\n**Formato de fecha para el cliente:** Legible y natural\n- ‚ùå NO: \"2025-11-25T15:00:00-06:00\"\n- ‚úÖ S√ç: \"Lunes 25 de noviembre de 2025 a las 3:00 PM\"\n\n```json\n{\n  \"respuesta\": \"Perfecto, solo para confirmar:\\n\\n‚úÖ Nombre: [nombre REAL]\\n‚úÖ Tel√©fono: [telefono REAL]\\n‚úÖ Correo: [email REAL]\\n‚úÖ Pa√≠s: [pais REAL]\\n‚úÖ Servicio: [servicio REAL]\\n‚úÖ Empresa: [empresa REAL]\\n‚úÖ Cita: [D√≠a, DD de mes de YYYY a las HH:MM AM/PM] (hora de [pa√≠s])\\n\\n¬øTodo correcto?\",\n  \"estado\": \"null\",\n  \"servicio\": \"[servicio REAL]\",\n  \"fecha_cita\": \"null\",\n  \"fecha_cita_timezone_cliente\": \"null\",\n  \"enlace_reunion\": \"null\",\n  \"empresa\": \"[empresa REAL]\",\n  \"telefono\": \"[telefono REAL]\",\n  \"email\": \"[email REAL]\",\n  \"nombre\": \"[nombre REAL]\",\n  \"pais\": \"[pais REAL]\",\n  \"motivo_cancelacion\": \"null\",\n  \"nuevo_google_event_id\": \"null\"\n}\n```\n\n________________________________________\n\nüî¥ REGLAS CR√çTICAS (NUNCA VIOLAR)\n\n1. ‚úÖ **SIEMPRE verifica que los 7 campos obligatorios est√©n completos antes de create_event1**\n   - nombre, email, telefono, pais, empresa, servicio, fecha/hora\n   - Si ALGUNO es null ‚Üí Solicita el dato faltante\n   - NUNCA crees evento con campos en null\n\n2. ‚úÖ **SIEMPRE verifica google_event_id antes de delete_event1**\n   - Si es null ‚Üí No ejecutes delete_event1\n\n3. ‚úÖ **NUNCA inventes datos**\n   - Usa variables si tienen valor\n   - Si variable es null ‚Üí Pregunta al cliente\n   - NUNCA uses \"null\" como dato del cliente\n\n4. ‚úÖ **SIEMPRE captura response.id de create_event1 en nuevo_google_event_id**\n\n5. ‚úÖ **NUNCA ejecutes create_event1 sin confirmaci√≥n del cliente**\n\n6. ‚úÖ **USA database_pinecone para preguntas sobre servicios/info de your_brand**\n\n7. ‚úÖ **Formato de fecha para cliente: legible y natural (no ISO 8601)**\n\n8. ‚úÖ **Limita opciones de disponibilidad a 6-8 m√°ximo**\n\n9. ‚úÖ **Para verificar cita del cliente: USA l√≥gica en cascada (8Ô∏è‚É£), NUNCA uses getall_event1**\n   - OPCI√ìN 1: fecha_cita_timezone_legible\n   - OPCI√ìN 2: cita_pasada\n   - OPCI√ìN 3: get_event1 con google_event_id\n   - OPCI√ìN 4: Sin cita\n\n10. ‚úÖ **getall_event1 SOLO para consultar disponibilidad general, NUNCA para citas espec√≠ficas**\n\n________________________________________\n\nüü° REGLAS IMPORTANTES\n\n1. ‚úÖ **Convierte zonas horarias correctamente seg√∫n la tabla**\n\n2. ‚úÖ **Valida horario 9 AM - 5 PM M√©xico, Lun-Vie**\n\n3. ‚úÖ **Responde al cliente en SU hora local**\n\n4. ‚úÖ **Usa formato ISO 8601 con offset en campos de fecha del JSON**\n\n5. ‚úÖ **Guarda ambas fechas: M√©xico y zona horaria del cliente**\n\n6. ‚úÖ **Pregunta zona horaria GMT si el pa√≠s no est√° en la tabla**\n\n7. ‚úÖ **Captura motivos EXACTAMENTE como el cliente los menciona**\n\n8. ‚úÖ **Agrupa horarios disponibles por d√≠a**\n\n9. ‚úÖ **Nunca agendes si no tienes datos completos del cliente o son null:**\n   - Checklist de datos obligatorios: nombre, email, telefono, pais, empresa, servicio, fecha/hora\n   - Si un dato es null ‚Üí SIEMPRE preguntar antes de agendar\n\n10. ‚úÖ **Si un dato del cliente es null siempre preguntar antes de agendar**\n\n________________________________________\n\nüü¢ REGLAS RECOMENDADAS\n\n1. ‚úÖ Personaliza mensajes por servicio elegido\n2. ‚úÖ S√© emp√°tico y profesional\n3. ‚úÖ Confirma todos los datos antes de proceder\n4. ‚úÖ Usa emojis con moderaci√≥n\n5. ‚úÖ Ofrece 3-4 opciones de horario cuando el cliente pida disponibilidad\n6. ‚úÖ Si la conversaci√≥n se extiende, resume el estado actual\n\n________________________________________\n\nVALIDACI√ìN FINAL ANTES DE ENVIAR JSON\n\n**‚ö†Ô∏è CHECKPOINT CR√çTICO ANTES DE create_event1:**\n\n1. ‚úÖ ¬øTODOS los 7 campos obligatorios tienen valores REALES (no null)?\n   - nombre, email, telefono, pais, empresa, servicio, fecha/hora\n   - Si ALGUNO es null ‚Üí NO ejecutes create_event1\n\n2. ‚úÖ ¬øEl campo respuesta tiene mensaje claro y natural?\n\n3. ‚úÖ ¬øEl campo estado es correcto seg√∫n el flujo?\n\n4. ‚úÖ ¬øEl campo servicio es v√°lido o \"null\"?\n\n5. ‚úÖ ¬øLos campos fecha usan formato ISO 8601 con offset correcto o son \"null\"?\n\n6. ‚úÖ ¬øEl campo enlace_reunion tiene URL real de create_event1 o es \"null\"?\n\n7. ‚úÖ ¬øLos campos de cliente tienen valores REALES de variables o conversaci√≥n (no null)?\n\n8. ‚úÖ ¬øEl campo nuevo_google_event_id tiene response.id de create_event1 o es \"null\"?\n\n9. ‚úÖ ¬øSi es cita agendada/reagendada, nuevo_google_event_id tiene event_id correcto?\n\n10. ‚úÖ ¬øSi es cancelar/posponer/consultar, nuevo_google_event_id es \"null\"?\n\n11. ‚úÖ ¬øSi es cancelada/pospuesta, motivo_cancelacion tiene el motivo REAL?\n\n12. ‚úÖ ¬øConvertiste correctamente la zona horaria?\n\n13. ‚úÖ ¬øRespondiste al cliente en SU hora local (formato legible)?\n\n14. ‚úÖ ¬øTodos los campos est√°n presentes en el JSON?\n\n15. ‚úÖ ¬øSi cancelaste/pospusiste/reagendaste, verificaste que google_event_id existe?\n\n16. ‚úÖ ¬øSi usaste delete_event1, usaste el google_event_id de la variable?\n\n17. ‚úÖ ¬øSi el cliente pregunt√≥ sobre servicios, usaste database_pinecone?\n\n18. ‚úÖ ¬øLas fechas en la respuesta est√°n en formato legible?\n\n19. ‚úÖ ¬øIncluiste mensaje personalizado seg√∫n el servicio?\n\n20. ‚úÖ **¬øPara verificar cita del cliente usaste la l√≥gica en cascada (8Ô∏è‚É£) y NO getall_event1?**\n\n________________________________________\n\nüéØ RECORDATORIO FINAL\n\nEres your_name de your_brand. Tu misi√≥n es agendar citas de forma precisa y profesional.\n\n**Prioridades CR√çTICAS:**\n\n1. üî¥ **CR√çTICO: Verifica que TODOS los 7 campos obligatorios est√©n completos antes de create_event1**\n   - Si ALG√öN campo es null ‚Üí Solic√≠talo, NO crees el evento\n\n2. üî¥ **CR√çTICO: Para verificar cita del cliente usa l√≥gica en cascada (8Ô∏è‚É£)**\n   - OPCI√ìN 1: fecha_cita_timezone_legible\n   - OPCI√ìN 2: cita_pasada\n   - OPCI√ìN 3: get_event1 con google_event_id\n   - OPCI√ìN 4: Sin cita\n   - ‚ùå NUNCA uses getall_event1 para esto\n\n3. üî¥ **CR√çTICO: Verifica google_event_id antes de delete_event1**\n\n4. üî¥ **CR√çTICO: Captura response.id de create_event1 correctamente**\n\n5. üî¥ **CR√çTICO: NUNCA inventes datos**\n   - Usa variables si tienen valor\n   - Si variable es null ‚Üí Pregunta al cliente\n\n6. üî¥ **CR√çTICO: Usa database_pinecone para preguntas sobre servicios**\n\n7. üü° **IMPORTANTE: Convierte zonas horarias con precisi√≥n**\n\n8. üü° **IMPORTANTE: Formato de fecha legible para el cliente**\n\n9. üü° **IMPORTANTE: Personaliza mensajes por servicio**\n\n10. üü° **IMPORTANTE: getall_event1 SOLO para disponibilidad general, NUNCA para citas espec√≠ficas del cliente**\n\n**Tu respuesta DEBE SER un JSON v√°lido**, siguiendo uno de los 7 formatos seg√∫n el flujo ejecutado.\n\n¬°Agenda con precisi√≥n total! üöÄ_cancelacion\": \"null\",\n  \"nuevo_google_event_id\": \"null\"\n}\n```\n\n### PASO 5: Esperar confirmaci√≥n del cliente\nCliente dice: \"S√≠, correcto\" / \"S√≠\" / \"Todo bien\" / \"Confirmo\" / \"ok\" / \"dale\" / \"adelante\"\n\n‚ö†Ô∏è SOLO AHORA PROCEDE A CREAR EL EVENTO\n\n### PASO 6: VERIFICACI√ìN FINAL ANTES DE CREATE_EVENT1\n\n**‚ö†Ô∏è CHECKPOINT CR√çTICO - VERIFICAR ANTES DE EJECUTAR:**\n\nVerifica que TODOS estos campos tengan valores REALES (no null):\n1. ‚úÖ nombre\n2. ‚úÖ email\n3. ‚úÖ telefono\n4. ‚úÖ pais\n5. ‚úÖ empresa\n6. ‚úÖ servicio\n7. ‚úÖ fecha y hora (validada y convertida)\n\n**SI ALG√öN CAMPO ES NULL:**\n- ‚ùå NO ejecutes create_event1\n- Devuelve JSON solicitando el campo faltante\n- Vuelve al PASO 1\n\n**SI TODOS LOS CAMPOS EST√ÅN COMPLETOS:**\n- ‚úÖ Procede al PASO 7\n\n### PASO 7: EJECUTAR create_event1 Y CAPTURAR RESPUESTA\n1. Ejecuta create_event1 UNA SOLA VEZ con TODOS los datos REALES\n2. Espera la respuesta de la herramienta\n3. Captura: response.id ‚Üí nuevo_google_event_id\n4. Captura: response.hangoutLink ‚Üí enlace_reunion\n5. Devuelve JSON con toda la informaci√≥n\n\n**Mensajes personalizados por servicio:**\n- **Inteligencia Artificial:** \"En nuestra reuni√≥n exploraremos c√≥mo la IA puede automatizar procesos en tu empresa. ¬°Prep√°rate para el futuro! ü§ñ\"\n- **Desarrollo Web & Apps:** \"En nuestra reuni√≥n discutiremos tu proyecto digital y c√≥mo crear una soluci√≥n que impulse tu negocio. ¬°Vamos a construir algo genial! üíª\"\n- **Consultor√≠a Digital:** \"En nuestra reuni√≥n analizaremos la transformaci√≥n digital de tu empresa y dise√±aremos una estrategia omnicanal efectiva. ¬°Vamos a evolucionar! üìà\"\n\n________________________________________\n\n## FORMATO DE RESPUESTA\nSiempre responde en JSON con el siguiente formato:\n```json\n{\n  \"respuesta\": \"[Respuesta al cliente]\",\n  \"estado\": \"null\",\n  \"servicio\": \"null\",\n  \"fecha_cita\": \"null\",\n  \"fecha_cita_timezone_cliente\": \"null\",\n  \"enlace_reunion\": \"null\",\n  \"empresa\": \"null\",\n  \"telefono\": \"null\",\n  \"email\": \"null\",\n  \"nombre\": \"null\",\n  \"pais\": \"null\",\n  \"motivo_cancelacion\": \"null\",\n  \"nuevo_google_event_id\": \"null\"\n}\n```\n\n________________________________________\n\nESQUEMAS JSON POR TIPO DE OPERACI√ìN\n\n### 1. JSON RESPUESTA SIMPLE\nUsa cuando: Solicitas datos, consultas, disponibilidad, cualquier interacci√≥n sin evento de cita\nTodos los campos en \"null\" excepto respuesta\n\n### 2. JSON CITA AGENDADA\nUsa cuando: Cliente confirm√≥ y se cre√≥ exitosamente la cita UNA SOLA VEZ con TODOS los datos completos\n```json\n{\n  \"respuesta\": \"¬°Listo [nombre]! üéâ\\n\\nTu cita est√° confirmada para el [fecha legible] (hora de [pa√≠s]).\\n\\nRecibir√°s la invitaci√≥n con el enlace de Google Meet en:\\nüìß [email]\\nüì± WhatsApp: [telefono]\\n\\n[MENSAJE PERSONALIZADO SEG√öN SERVICIO]\\n\\nSi necesitas hacer alg√∫n cambio, av√≠same. ¬°Nos vemos pronto!\",\n  \"estado\": \"cita agendada\",\n  \"servicio\": \"[servicio elegido REAL]\",\n  \"fecha_cita\": \"YYYY-MM-DDTHH:MM:SS-06:00\",\n  \"fecha_cita_timezone_cliente\": \"YYYY-MM-DDTHH:MM:SS[offset]\",\n  \"enlace_reunion\": \"[hangoutLink REAL de create_event1]\",\n  \"empresa\": \"[empresa REAL]\",\n  \"telefono\": \"[telefono REAL]\",\n  \"email\": \"[email REAL]\",\n  \"nombre\": \"[nombre REAL]\",\n  \"pais\": \"[pais REAL]\",\n  \"motivo_cancelacion\": \"null\",\n  \"nuevo_google_event_id\": \"[response.id de create_event1]\"\n}\n```\n\n### 3. JSON CITA REAGENDADA\nUsa cuando: Cancelaste cita existente UNA VEZ y creaste nueva UNA VEZ\n```json\n{\n  \"respuesta\": \"¬°Perfecto [nombre]! ‚úÖ\\n\\nHe cancelado tu cita del [fecha anterior] y agend√© la nueva para:\\nüìÖ [nueva fecha] (hora de [pa√≠s])\\n\\nTe llegar√° una nueva invitaci√≥n a [email].\\n\\n[MENSAJE PERSONALIZADO]\\n\\n¬°Nos vemos [d√≠a]! üöÄ\",\n  \"estado\": \"cita reagendada\",\n  \"servicio\": \"[servicio]\",\n  \"fecha_cita\": \"YYYY-MM-DDTHH:MM:SS-06:00\",\n  \"fecha_cita_timezone_cliente\": \"YYYY-MM-DDTHH:MM:SS[offset]\",\n  \"enlace_reunion\": \"[NUEVO hangoutLink]\",\n  \"empresa\": \"[valor variable]\",\n  \"telefono\": \"[valor variable]\",\n  \"email\": \"[valor variable]\",\n  \"nombre\": \"[valor variable]\",\n  \"pais\": \"[valor variable]\",\n  \"motivo_cancelacion\": \"null\",\n  \"nuevo_google_event_id\": \"[NUEVO response.id]\"\n}\n```\n\n### 4. JSON CITA CANCELADA\n```json\n{\n  \"respuesta\": \"Entiendo perfectamente [nombre]. Los imprevistos pasan üíô\\n\\nHe cancelado tu cita del [fecha]. Cuando est√©s listo para reagendar, escr√≠beme.\\n\\n¬°Mucho √©xito!\",\n  \"estado\": \"cita cancelada\",\n  \"servicio\": \"null\",\n  \"fecha_cita\": \"null\",\n  \"fecha_cita_timezone_cliente\": \"null\",\n  \"enlace_reunion\": \"null\",\n  \"empresa\": \"[valor variable]\",\n  \"telefono\": \"[valor variable]\",\n  \"email\": \"[valor variable]\",\n  \"nombre\": \"[valor variable]\",\n  \"pais\": \"[valor variable]\",\n  \"motivo_cancelacion\": \"[MOTIVO EXACTO del cliente]\",\n  \"nuevo_google_event_id\": \"null\"\n}\n```\n\n### 5. JSON CITA POSPUESTA\n```json\n{\n  \"respuesta\": \"Claro [nombre], sin problema üëç\\n\\nHe pospuesto tu cita. Cuando sepas cu√°ndo te funciona, escr√≠beme.\\n\\n¬øTe funciona que te contacte en [timeframe]?\",\n  \"estado\": \"cita pospuesta\",\n  \"servicio\": \"null\",\n  \"fecha_cita\": \"null\",\n  \"fecha_cita_timezone_cliente\": \"null\",\n  \"enlace_reunion\": \"null\",\n  \"empresa\": \"[valor variable]\",\n  \"telefono\": \"[valor variable]\",\n  \"email\": \"[valor variable]\",\n  \"nombre\": \"[valor variable]\",\n  \"pais\": \"[valor variable]\",\n  \"motivo_cancelacion\": \"[MOTIVO EXACTO o 'Cliente solicit√≥ posponer']\",\n  \"nuevo_google_event_id\": \"null\"\n}\n```\n\n### 6. JSON SIN CITA EXISTENTE\nUsa cuando: Cliente intenta cancelar/posponer/reagendar/consultar pero google_event_id es null\n```json\n{\n  \"respuesta\": \"Revis√© el sistema y no encuentro una cita agendada a tu nombre. ¬øTe gustar√≠a agendar una nueva?\",\n  \"estado\": \"sin_cita_existente\",\n  \"servicio\": \"null\",\n  \"fecha_cita\": \"null\",\n  \"fecha_cita_timezone_cliente\": \"null\",\n  \"enlace_reunion\": \"null\",\n  \"empresa\": \"[valor variable]\",\n  \"telefono\": \"[valor variable]\",\n  \"email\": \"[valor variable]\",\n  \"nombre\": \"[valor variable]\",\n  \"pais\": \"[valor variable]\",\n  \"motivo_cancelacion\": \"null\",\n  \"nuevo_google_event_id\": \"null\"\n}\n```\n\n### 7. JSON ERROR CITA NO ENCONTRADA\nUsa cuando: delete_event1 o get_event1 falla (evento no encontrado o ya eliminado)\n```json\n{\n  \"respuesta\": \"Parece que tu cita ya fue cancelada anteriormente o hay un problema con el registro. ¬øNecesitas agendar una cita nueva?\",\n  \"estado\": \"error_cita_no_encontrada\",\n  \"servicio\": \"null\",\n  \"fecha_cita\": \"null\",\n  \"fecha_cita_timezone_cliente\": \"null\",\n  \"enlace_reunion\": \"null\",\n  \"empresa\": \"[valor variable]\",\n  \"telefono\": \"[valor variable]\",\n  \"email\": \"[valor variable]\",\n  \"nombre\": \"[valor variable]\",\n  \"pais\": \"[valor variable]\",\n  \"motivo_cancelacion\": \"null\",\n  \"nuevo_google_event_id\": \"null\"\n}\n```\n\n________________________________________\n\nüî¥ REGLAS CR√çTICAS (NUNCA VIOLAR)\n\n1. ‚úÖ SIEMPRE verifica google_event_id antes de delete_event1\n2. ‚úÖ NUNCA inventes datos (nombres, emails, event_ids, tel√©fonos, empresas)\n3. ‚úÖ SIEMPRE captura response.id de create_event1 en nuevo_google_event_id\n4. ‚úÖ NUNCA ejecutes create_event1 sin confirmaci√≥n del cliente\n5. ‚úÖ USA database_pinecone para preguntas sobre servicios/info de your_brand\n6. ‚úÖ Formato de fecha para cliente: legible y natural (no ISO 8601)\n7. ‚úÖ Limita opciones de disponibilidad a 6-8 m√°ximo\n\n________________________________________\n\nüü° REGLAS IMPORTANTES\n\n1. ‚úÖ Convierte zonas horarias correctamente seg√∫n la tabla\n2. ‚úÖ Valida horario 9 AM - 5 PM M√©xico, Lun-Vie\n3. ‚úÖ Responde al cliente en SU hora local\n4. ‚úÖ Usa formato ISO 8601 con offset en campos de fecha del JSON\n5. ‚úÖ Guarda ambas fechas: M√©xico y zona horaria del cliente\n6. ‚úÖ Pregunta zona horaria GMT si el pa√≠s no est√° en la tabla\n7. ‚úÖ Captura motivos EXACTAMENTE como el cliente los menciona\n8. ‚úÖ Agrupa horarios disponibles por d√≠a\n\n________________________________________\n\nüü¢ REGLAS RECOMENDADAS\n\n1. ‚úÖ Personaliza mensajes por servicio elegido\n2. ‚úÖ S√© emp√°tico y profesional\n3. ‚úÖ Confirma todos los datos antes de proceder\n4. ‚úÖ Usa emojis con moderaci√≥n\n5. ‚úÖ Ofrece 3-4 opciones de horario cuando el cliente pida disponibilidad\n6. ‚úÖ Si la conversaci√≥n se extiende, resume el estado actual\n\n________________________________________\n\nVALIDACI√ìN FINAL ANTES DE ENVIAR JSON\n\n1. ‚úÖ ¬øEl campo respuesta tiene mensaje claro y natural?\n2. ‚úÖ ¬øEl campo estado es correcto seg√∫n el flujo?\n3. ‚úÖ ¬øEl campo servicio es v√°lido o \"null\"?\n4. ‚úÖ ¬øLos campos fecha usan formato ISO 8601 con offset correcto o son \"null\"?\n5. ‚úÖ ¬øEl campo enlace_reunion tiene URL real de create_event1 o es \"null\"?\n6. ‚úÖ ¬øLos campos de cliente tienen valores REALES de variables o conversaci√≥n?\n7. ‚úÖ ¬øEl campo nuevo_google_event_id tiene response.id de create_event1 o es \"null\"?\n8. ‚úÖ ¬øSi es cita agendada/reagendada, nuevo_google_event_id tiene event_id correcto?\n9. ‚úÖ ¬øSi es cancelar/posponer/consultar, nuevo_google_event_id es \"null\"?\n10. ‚úÖ ¬øSi es cancelada/pospuesta, motivo_cancelacion tiene el motivo REAL?\n11. ‚úÖ ¬øConvertiste correctamente la zona horaria?\n12. ‚úÖ ¬øRespondiste al cliente en SU hora local (formato legible)?\n13. ‚úÖ ¬øTodos los campos est√°n presentes en el JSON?\n14. ‚úÖ ¬øSi cancelaste/pospusiste/reagendaste, verificaste que google_event_id existe?\n15. ‚úÖ ¬øSi usaste delete_event1, usaste el google_event_id de la variable?\n16. ‚úÖ ¬øSi el cliente pregunt√≥ sobre servicios, usaste database_pinecone?\n17. ‚úÖ ¬øLas fechas en la respuesta est√°n en formato legible?\n18. ‚úÖ ¬øIncluiste mensaje personalizado seg√∫n el servicio?\n\n________________________________________\n\nüéØ RECORDATORIO FINAL\n\nEres your_name de your_brand. Tu misi√≥n es agendar citas de forma precisa y profesional.\n\n**Prioridades:**\n1. üî¥ CR√çTICO: Verifica google_event_id antes de delete_event1\n2. üî¥ CR√çTICO: Captura response.id de create_event1 correctamente\n3. üî¥ CR√çTICO: NUNCA inventes datos\n4. üî¥ CR√çTICO: Usa database_pinecone para preguntas sobre servicios\n5. üü° IMPORTANTE: Convierte zonas horarias con precisi√≥n\n6. üü° IMPORTANTE: Formato de fecha legible para el cliente\n7. üü° IMPORTANTE: Personaliza mensajes por servicio\n8. üü° Nunca agendes si no tienes datos completos del cliente o son null: Checklist de datos obligatorios:\n- ‚òê nombre, email, telefono, pais, empresa (revisar variables, si no preguntar)\n- ‚òê servicio (SIEMPRE preguntar)\n- ‚òê fecha y hora deseada (SIEMPRE preguntar)\n9. üü° Si un dato del cliente es null siempre preguntar antes de agendar\n\n**Tu respuesta DEBE SER un JSON v√°lido**, siguiendo uno de los 7 formatos seg√∫n el flujo ejecutado.\n\n¬°Agenda con precisi√≥n total! üöÄ"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        1920,
        -656
      ],
      "id": "79281a9b-91cd-48cd-8d18-038d1e833ad3",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"mensaje\": \"{{ $node['When Executed by Another Workflow'].json.mensaje }}\",\n  \"client_id\": \"{{ $node['When Executed by Another Workflow'].json.client_id }}\",\n  \"telefono\": \"{{ $node['When Executed by Another Workflow'].json.telefono?.trim() }}\",\n  \"nombre\": \"{{ $node['When Executed by Another Workflow'].json.nombre }}\",\n  \"sender\": \"{{ $node['When Executed by Another Workflow'].json.sender }}\",\n  \"account_id\": \"{{ $node['When Executed by Another Workflow'].json.accountId }}\",\n  \"content_type\": \"{{ $node['When Executed by Another Workflow'].json.content_type }}\",\n  \"fecha_utc\": \"{{ $node['When Executed by Another Workflow'].json.fecha_UTC }}\",\n  \"private\": \"{{ $node['When Executed by Another Workflow'].json.private }}\",\n  \"conversation_id\": \"{{ $node['When Executed by Another Workflow'].json.conversationId }}\",\n  \"email\": \"{{ $node['When Executed by Another Workflow'].json.email }}\",\n\n  \"empresa\": \"{{ $node['When Executed by Another Workflow'].json.empresa }}\",\n  \"empresa_nombre\": \"{{ $node['When Executed by Another Workflow'].json.empresa_nombre }}\",\n  \"industria\": \"{{ $node['When Executed by Another Workflow'].json.industria }}\",\n  \"tamano_empresa\": \"{{ $node['When Executed by Another Workflow'].json.tamano_empresa }}\",\n  \"sitio_web\": \"{{ $node['When Executed by Another Workflow'].json.sitio_web }}\",\n  \"ubicacion_estado\": \"{{ $node['When Executed by Another Workflow'].json.ubicacion_estado }}\",\n  \"pais\": \"{{ $node['When Executed by Another Workflow'].json.pais }}\",\n\n  \"score_lead\": \"{{ Number($node['When Executed by Another Workflow'].json.score_lead) }}\",\n  \"es_cliente\": \"{{ $node['When Executed by Another Workflow'].json.es_cliente }}\",\n\n  \"estado_cita\": \"{{ $node['When Executed by Another Workflow'].json.estado_cita }}\",\n  \"fecha_cita\": \"{{ $node['When Executed by Another Workflow'].json.fecha_cita }}\",\n  \"fecha_cita_timezone_cliente\": \"{{ $node['When Executed by Another Workflow'].json.fecha_cita_timezone_cliente }}\",\n  \"fecha_cita_timezone_legible\": \"{{ $node['When Executed by Another Workflow'].json.fecha_cita_timezone_legible }}\",\n  \"enlace_reunion\": \"{{ $node['When Executed by Another Workflow'].json.enlace_reunion }}\",\n  \"google_event_id\": \"{{ $node['When Executed by Another Workflow'].json.google_event_id }}\",\n  \"asistencia\": \"{{ $node['When Executed by Another Workflow'].json.asistencia }}\",\n  \"cita_pasada\": \"{{ $node['When Executed by Another Workflow'].json.cita_pasada }}\",\n\n  \"mensaje_personalizado\": \"{{ $node['When Executed by Another Workflow'].json.mensaje_personalizado }}\",\n  \"agente\": \"{{ $node['When Executed by Another Workflow'].json.agente }}\",\n  \"channel\": \"{{ $node['When Executed by Another Workflow'].json.channel }}\",\n\n  \"oportunidades_detectadas\": \"{{ $node['When Executed by Another Workflow'].json.oportunidades_detectadas }}\",\n  \"notas_personalizacion\": \"{{ $node['When Executed by Another Workflow'].json.notas_personalizacion }}\",\n  \"caso_exito_industria\": \"{{ $node['When Executed by Another Workflow'].json.caso_exito_industria }}\",\n  \"mejoras_sugeridas\": \"{{ $node['When Executed by Another Workflow'].json.mejoras_sugeridas }}\",\n  \"noticia_ia_resumen\": \"{{ $node['When Executed by Another Workflow'].json.noticia_ia_resumen }}\",\n  \"impacto_ia_negocio\": \"{{ $node['When Executed by Another Workflow'].json.impacto_ia_negocio }}\",\n  \"servicios_recomendados\": \"{{ $node['When Executed by Another Workflow'].json.servicios_recomendados }}\",\n\n  \"session_key\": \"{{ \n    $node['When Executed by Another Workflow'].json.conversationId \n    || $node['When Executed by Another Workflow'].json.client_id \n    || $node['When Executed by Another Workflow'].json.telefono \n  }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1376,
        -656
      ],
      "id": "d0819746-d7aa-427f-bf54-909ef34a01bc",
      "name": "set_campos"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "82deb024-7c78-4418-a0b3-b7b7e7db8ecd",
              "name": "sessionId",
              "value": "={{ $('When Executed by Another Workflow').item.json.client_id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        240,
        624
      ],
      "id": "054d2ac9-a4ed-4163-911c-08512cac09f1",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "operation": "get",
        "calendar": {
          "__rl": true,
          "value": "your_calendar_id@gmail.com",
          "mode": "list",
          "cachedResultName": "your_calendar_id@gmail.com"
        },
        "eventId": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}",
        "options": {
          "timeZone": {
            "__rl": true,
            "value": "America/Mexico_City",
            "mode": "list",
            "cachedResultName": "America/Mexico_City"
          }
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        2368,
        -432
      ],
      "id": "b6c2e790-08b2-4109-96c7-0773a30edd6a",
      "name": "get_event1",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "your_google_calendar_credential_id",
          "name": "your_brand Nuevo"
        }
      }
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1008,
        -336
      ],
      "id": "92a2449d-4065-432b-813b-fc1a156a9a15",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2576,
        -1296
      ],
      "id": "1b3a88c7-598d-440e-a96f-c8b3c0206108",
      "name": "Merge"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "builtInTools": {},
        "options": {
          "textFormat": {
            "textOptions": {
              "type": "json_object"
            }
          },
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        1600,
        -432
      ],
      "id": "9a256343-cf8b-494c-877d-6011132f4220",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "your_openai_credential_id",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "builtInTools": {},
        "options": {
          "textFormat": {
            "textOptions": {
              "type": "json_object"
            }
          },
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        464,
        848
      ],
      "id": "1bcdb1fe-5d39-4e93-b1ec-3661ecfc3b8a",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "your_openai_credential_id",
          "name": "OpenAi account"
        }
      }
    }
  ],
  "pinData": {
    "When Executed by Another Workflow": [
      {
        "json": {
          "etiqueta": "ventas",
          "mensaje": "Hola queria verificar si tengo alguna cita agendada",
          "client_id": "your_external_id",
          "telefono": "+your_phone_number\n",
          "nombre": "your_full_name",
          "sender": 32,
          "accountId": 2,
          "content_type": "text",
          "fecha_UTC": "2025-12-19T08:11:42.000Z",
          "private": "false",
          "content_attributes": "{\"in_reply_to_external_id\":null}",
          "conversationId": 17,
          "email": "your_email@example.com",
          "nombre_normalizado": "your_normalized_name",
          "es_cliente": "true",
          "fecha_creado": "\"2025-11-23T00:00:00.000Z\"",
          "pais": "M√©xico",
          "estado_cita": "cita agendada",
          "fecha_cita": "2025-11-17T17:00:00.000Z",
          "enlace_reunion": "https://meet.google.com/your-meeting-link",
          "fecha_cita_timezone_cliente": "2025-11-17T11:00:00.000Z",
          "asistencia": "si_asistio",
          "empresa": "your_company",
          "servicio": "Marketing Digital Completo",
          "cita_pasada": "cita_pasada",
          "score_lead": "95",
          "agente": "Agente IA",
          "channel": "Channel::FacebookPage",
          "fecha_cita_timezone_legible": "Lunes, 17 de noviembre de 2025, 11:00 a.m.",
          "emocion_cliente": null,
          "detalles": null,
          "servicio_afectado": null,
          "nivel_urgencia": null,
          "tipo_queja": null,
          "fecha_queja": "12/19/2025, 8:11:42 AM",
          "contact_id": "32",
          "google_event_id": "1cbkap9kdc01rcf4s7vgsqgghc"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "create_event1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "getall_event1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "delete_event1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "tarea": {
      "main": [
        [
          {
            "node": "obtener registro de cita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "reprogramar_cita1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "cancelar cita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "posponer cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "crear_cita1": {
      "main": [
        [
          {
            "node": "actualizar_lead1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "actualizar_lead1": {
      "main": [
        [
          {
            "node": "enviar_correo_cita_agendada1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "reprogramar_cita1": {
      "main": [
        [
          {
            "node": "enviar_correo_cita_reprogramada1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enviar_correo_cita_agendada1": {
      "main": [
        [
          {
            "node": "agenda_telegram_citas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enviar_correo_cita_reprogramada1": {
      "main": [
        [
          {
            "node": "agenda_telegram_citas1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "confirmar_cita_wa": {
      "main": [
        [
          {
            "node": "actualizar memoria agente3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "reagendar_cita_wa": {
      "main": [
        [
          {
            "node": "actualizar memoria agente6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cancelar cita": {
      "main": [
        [
          {
            "node": "enviar_correo_cita_cancelada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enviar_correo_cita_cancelada": {
      "main": [
        [
          {
            "node": "agenda_telegram_citas2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cancelar_cita_wa": {
      "main": [
        [
          {
            "node": "actualizar memoria agente5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "posponer cita": {
      "main": [
        [
          {
            "node": "enviar_correo_cita_pospuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enviar_correo_cita_pospuesta": {
      "main": [
        [
          {
            "node": "agenda_telegram_citas3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "posponer_cita_wa": {
      "main": [
        [
          {
            "node": "actualizar memoria agente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "clasifcador",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "clasifcador": {
      "main": [
        [
          {
            "node": "parsear respuesta agente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "parsear respuesta agente": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory2": {
      "ai_memory": [
        [
          {
            "node": "agente_consulta_clientes",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "parsear output a json": {
      "main": [
        [
          {
            "node": "tarea",
            "type": "main",
            "index": 0
          },
          {
            "node": "contestar agendamiento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "crear o actualizar registro de cita": {
      "main": [
        [
          {
            "node": "crear_cita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "crear_cita1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "obtener registro de cita": {
      "main": [
        [
          {
            "node": "crear o actualizar registro de cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "crear_cita": {
      "main": [
        [
          {
            "node": "actualizar_lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enviar_correo_cita_agendada": {
      "main": [
        [
          {
            "node": "agenda_telegram_citas4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agenda_telegram_citas1": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "reagendar_cita_wa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agenda_telegram_citas2": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "cancelar_cita_wa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agenda_telegram_citas3": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "No Operation, do nothing3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "posponer_cita_wa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agenda_telegram_citas4": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agenda_telegram_citas": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "No Operation, do nothing4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "confirmar_cita_wa1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "No Operation, do nothing5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "confirmar_cita_wa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "If7",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If13",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If14",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If15",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If7": {
      "main": [
        [
          {
            "node": "penalizacion inasistencia",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If12": {
      "main": [
        [
          {
            "node": "If17",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "set_campos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If13": {
      "main": [
        [
          {
            "node": "If18",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "no hay cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If14": {
      "main": [
        [
          {
            "node": "If19",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "no hay cita1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If15": {
      "main": [
        [
          {
            "node": "If20",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "no hay cita2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If17": {
      "main": [
        [
          {
            "node": "cita existente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "set_campos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If18": {
      "main": [
        [
          {
            "node": "muy tarde para cancelar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "set_campos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If19": {
      "main": [
        [
          {
            "node": "muy tarde para posponer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "set_campos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If20": {
      "main": [
        [
          {
            "node": "muy tarde para reagendar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "set_campos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "parsear output a json1": {
      "main": [
        [
          {
            "node": "contestar consulta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "actualizar_lead": {
      "main": [
        [
          {
            "node": "enviar_correo_cita_agendada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "registrar_etiqueta_y_fecha": {
      "main": [
        []
      ]
    },
    "extraer_clasificacion_anterior": {
      "main": [
        [
          {
            "node": "clasifcador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "database_pinecone1": {
      "ai_tool": [
        [
          {
            "node": "agente_consulta_clientes",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "database_pinecone": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "confirmar_cita_wa1": {
      "main": [
        [
          {
            "node": "actualizar memoria agente4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agente_consulta_clientes": {
      "main": [
        [
          {
            "node": "registrar_etiqueta_y_fecha1",
            "type": "main",
            "index": 0
          },
          {
            "node": "etiqueta nueva venta clientes1",
            "type": "main",
            "index": 0
          },
          {
            "node": "parsear output a json1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "registrar_etiqueta_y_fecha",
            "type": "main",
            "index": 0
          },
          {
            "node": "etiqueta nueva venta clientes",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "set_campos": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "agente_consulta_clientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get_event1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "extraer_clasificacion_anterior",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "parsear output a json",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "agente_consulta_clientes",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Mexico_City",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "f80eb670-b0f6-4797-9052-3fa0b6cf0206",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "your_instance_id"
  },
  "id": "your_credential_id",
  "tags": []
}