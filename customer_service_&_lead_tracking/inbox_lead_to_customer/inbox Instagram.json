{
  "name": "inbox Instagram",
  "nodes": [
    {
      "parameters": {
        "content": "## üì∏ Omnichannel Entry: Instagram\\n\\nCentral hub for managing Instagram Direct Message interactions. It uses a structured approach to transition social media engagement into a formal sales pipeline.\\n\\n### Key Features:\\n1. **Multimodal Capabilities**: Processes both text-based DMs and voice messages using OpenAI Whisper for transcription.\\n2. **De-buffering Logic**: Groups sequential messages from a single user within a 15-second window to preserve conversational context.\\n3. **AI Triaging**: Automatically classifies the user's intent to route the conversation to the most appropriate sub-workflow or human agent.\\n4. **CRM Lead Management**: Syncs with Supabase and Chatwoot to ensure Instagram leads are tracked alongside other channels.",
        "height": 450,
        "width": 320,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        200,
        1800
      ],
      "typeVersion": 1,
      "id": "doc-instagram-inbox",
      "name": "Architecture Documentation"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5438a99f-4868-4371-9278-e325eefe372e",
              "leftValue": "={{ $('Data message extraction').item.json.voice_message_type }}",
              "rightValue": "=text",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1152,
        2080
      ],
      "id": "1e70ab52-b1e5-4b5d-9ebd-c940b2bf8f64",
      "name": "If"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "47df2a04-37cd-463c-b9dc-30f80b9900cf",
              "name": "final_message",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "d1811afc-88b4-4540-a55b-fefe21f53887",
              "name": "sessionId",
              "value": "={{ $('Data message extraction').item.json.sessionId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1824,
        1984
      ],
      "id": "836927f6-0b0f-4b7b-8683-d3429ca9a15a",
      "name": "final_message_voice"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c8d5073d-a91f-4c62-b5e6-0fa9c7822ed9",
              "name": "final_message",
              "value": "={{ $('Data message extraction').item.json.text_message }}",
              "type": "string"
            },
            {
              "id": "cc1a1071-90fc-49c2-9759-3769187c8a8e",
              "name": "sessionId",
              "value": "={{ $('Data message extraction').item.json.sessionId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1824,
        2176
      ],
      "id": "84b64ff5-41aa-4bc0-9f06-7d604956b09b",
      "name": "final_message_text"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Data message extraction').item.json.sender }}",
        "messageData": "={{ JSON.stringify(\n{\n'message': $json.final_message ,\n'sessionId': $('Data message extraction').item.json.sessionId, \n'date_time': $('Data message extraction').item.json.data_time \n}\n) }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2048,
        2080
      ],
      "id": "eea226dd-c7e7-4be1-971c-1616c97addc9",
      "name": "buffer",
      "credentials": {
        "redis": {
          "id": "your_redis_credential_id",
          "name": "n8n_redis"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "={{ $('Data message extraction').item.json.sender }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2272,
        2080
      ],
      "id": "3d788441-e9a6-4f02-83f4-9812ddea68e9",
      "name": "get_buffer_data",
      "credentials": {
        "redis": {
          "id": "your_redis_credential_id",
          "name": "n8n_redis"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ JSON.parse($json.message.last()).sessionId }}",
                    "rightValue": "={{ $('Data message extraction').item.json.sessionId }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "a476894f-bb93-4167-aad2-4b63f275e969"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ignorar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "340f7c66-134b-4b22-9d7b-2326d886aa76",
                    "leftValue": "={{ JSON.parse($json.message.last()).date_time}}",
                    "rightValue": "={{ $now.minus(15,'seconds').toLocal() }}",
                    "operator": {
                      "type": "dateTime",
                      "operation": "before"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Continuar"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Esperar"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2496,
        1968
      ],
      "id": "c772d48f-6bed-4449-8ba5-25393375100a",
      "name": "Switch"
    },
    {
      "parameters": {
        "amount": 15
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2720,
        2176
      ],
      "id": "a19ecbef-1dbe-481d-aa2c-bf4c484cacdc",
      "name": "Wait",
      "webhookId": "5562c2c6-53ac-4d11-b606-7240f09662d4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2720,
        1760
      ],
      "id": "52b40bad-0a6b-430c-bba1-ef938b7a3442",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Data message extraction').item.json.sender }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2720,
        1952
      ],
      "id": "703fd359-aaeb-4671-bdd7-afaa24bfd1c1",
      "name": "Delete_buffer",
      "credentials": {
        "redis": {
          "id": "your_redis_credential_id",
          "name": "n8n_redis"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1600,
        1984
      ],
      "id": "075a34d0-6d29-49ba-ab22-6ab7faebfa65",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "your_openai_credential_id",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('Data message extraction').item.json.voice_message_url }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1376,
        1984
      ],
      "id": "b2341e1a-0832-4985-8a04-3c4a0f6a8157",
      "name": "HTTP Request4",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "de2ee357-32a4-4717-8618-f281f4b54299",
              "name": "concat_message",
              "value": "={{ $json.message.map(m=> JSON.parse(m).message).join('\\n') }}",
              "type": "string"
            },
            {
              "id": "b0544111-6d92-4a75-a917-9df1ee09572e",
              "name": "sessionId",
              "value": "={{ $('Data message extraction').item.json.sessionId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2944,
        1952
      ],
      "id": "2ae9d729-8505-4f67-82cc-70363e0df23e",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "168f8929-0286-4132-ae83-df11b587ca2c",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        480,
        2080
      ],
      "id": "e2accc7c-7346-4ac2-a818-0aa3c1c2f55b",
      "name": "Webhook",
      "webhookId": "168f8929-0286-4132-ae83-df11b587ca2c"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5408,
        1296
      ],
      "id": "28137459-9a0e-436c-a172-8ff89a0e31a2",
      "name": "OpenAI Chat Model8",
      "credentials": {
        "openAiApi": {
          "id": "your_openai_credential_id",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
                    "rightValue": "v",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "9a61f83b-b79b-4a3d-a154-4eea6cd5d05f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ventas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "bd0c8b67-b2af-41c1-b708-c1612e888dcc",
                    "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
                    "rightValue": "i",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cliente no definido"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d953d019-549e-4045-931f-ae43a07bea1b",
                    "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
                    "rightValue": "s",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "soporte"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "4cc96a53-1994-4243-b51e-88a7a1c79c86",
                    "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
                    "rightValue": "q",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "queja"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d6fb8198-4bd3-40c3-a92c-3adc1b324f6d",
                    "leftValue": "={{ $('parsear respuesta agente').item.json.categoria }}",
                    "rightValue": "a",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agente_humano"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        6128,
        1024
      ],
      "id": "605d91c0-7bcb-4ccb-9f6d-b095330d6893",
      "name": "Switch2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('variables persistentes cliente').item.json.concat_message }}",
        "options": {
          "systemMessage": "=## IDENTIDAD Y OBJETIVO\nEres un **clasificador inteligente de conversaciones** para **your_brand**, una agencia de marketing digital e inteligencia artificial.  \nTu **√∫nica tarea** es clasificar el mensaje del cliente en **una sola categor√≠a** de acuerdo con su intenci√≥n.\n\n---\n\n## ‚öôÔ∏è DATOS DE CONTEXTO\n\n**Historial completo de conversaciones previas (√∫ltimos 10 registros):**\n{{ $('extraer_etiqueta_anterior').item.json.resultado.historial_conversaciones || 'Sin historial previo' }}\n\n**Mensaje actual del cliente:**\n{{ $('variables persistentes cliente').item.json.concat_message }}\n\n**Fecha y hora actual del sistema:**\n{{ $now }}\n\n---\n\n## üß© CATEGOR√çAS POSIBLES\n\nResponde **solo con una palabra** de las siguientes (en min√∫sculas, sin puntos ni explicaciones):\n\n- ventas  \n- soporte  \n- queja  \n- indefinido  \n\n---\n\n## üß† DEFINICIONES CLAVE\n\n### üü¢ VENTAS\nMensajes donde el cliente muestra **inter√©s en contratar o conocer los servicios** de your_brand.\n\nIncluye:\n- Solicitudes de informaci√≥n, precios o cotizaciones  \n- Deseo de contratar o agendar una reuni√≥n  \n- Consultas sobre servicios o disponibilidad  \n- Solicitudes de eliminar datos personales  \n- Reagendar, cancelar o reprogramar reuniones/citas\n- Solicitudes de hablar con personal comercial o gerentes de ventas\n\n**Palabras clave:** precio, costo, cotizaci√≥n, presupuesto, contratar, agendar, cancelar, reprogramar, reagendar, posponer, reuni√≥n, cita, consulta, servicios, paquetes, informaci√≥n, disponibilidad, cu√°nto cuesta, me interesa, ofrecen\n\n---\n\n### üü£ SOPORTE\nMensajes de clientes actuales que necesitan **ayuda t√©cnica u operativa** con servicios activos.\n\nIncluye:\n- Problemas t√©cnicos, errores o dudas de uso  \n- Configuraci√≥n o acceso a dashboards  \n- Preguntas sobre m√©tricas o reportes  \n- Capacitaci√≥n o soporte funcional  \n- Seguimiento sobre implementaci√≥n o entrega\n- Solicitudes de ayuda o atenci√≥n sin expresar frustraci√≥n\n\n**Palabras clave:** no funciona, error, ayuda, c√≥mo usar, configurar, acceso, dashboard, reporte, m√©tricas, tutorial, no entiendo, problema t√©cnico, entrega, implementaci√≥n, necesito ayuda\n\n---\n\n### üî¥ QUEJA\nMensajes que expresan **frustraci√≥n, reclamos o insatisfacci√≥n** con el servicio.\n\nIncluye:\n- Si el √∫ltimo mensaje que mandaste incluye 'Reportar un problema'\n- Expresiones de enojo o frustraci√≥n  \n- Solicitudes de reembolso o cancelaci√≥n por insatisfacci√≥n  \n- Cr√≠ticas a la calidad o incumplimientos  \n- Retroalimentaci√≥n negativa  \n- Escalamiento de problemas no resueltos\n- Expresiones de que el sistema/bot no est√° ayudando (tono frustrado)\n\n**Palabras clave:** molesto, frustrado, inaceptable, cancelar (por molestia), reembolso, incumplimiento, decepcionado, harto, no sirve, p√©simo, malo, retroalimentaci√≥n negativa, estoy harto, ya no funciona, no me ayudas, esto no funciona\n\n---\n\n### ‚ö™ INDEFINIDO\nMensajes sin contexto claro o sin intenci√≥n comercial definida.\n\nIncluye:\n- Saludos simples sin solicitud espec√≠fica  \n- Preguntas generales o sin prop√≥sito concreto  \n- Mensajes ambiguos o incompletos  \n- Respuestas de cortes√≠a sin acci√≥n requerida\n- Solicitudes gen√©ricas de hablar con alguien sin contexto claro\n\n**Palabras clave:** hola, buenos d√≠as, c√≥mo est√°, qu√© tal, hey, ok, gracias\n\n---\n\n## üîÑ AN√ÅLISIS CON MEMORIA CONVERSACIONAL (PRIORIDAD M√ÅXIMA)\n\n**CR√çTICO:** El historial muestra el flujo real de la conversaci√≥n con formato:\n```\n#ID [tipo] mensaje | Etiqueta: etiqueta_anterior\n```\n\n### C√≥mo interpretar el historial:\n\n**Estructura:**\n- `#ID` = N√∫mero de registro (mayor = m√°s reciente)\n- `[ai]` = Respuesta del sistema/clasificaci√≥n anterior\n- `[human]` = Mensaje del cliente\n- `| Etiqueta:` = Etiqueta que se le dio a ese mensaje\n\n**Ejemplo de historial:**\n```\n#2085 [ai] ¬°Hola! Para agendar tu cita... | Etiqueta: ventas\n#2084 [human] Hola quisiera agendar una cita\n#2083 [ai] agendar_cita\n#2082 [human] Quiero informaci√≥n sobre sus servicios\n#2081 [ai] Aqu√≠ est√° la informaci√≥n | Etiqueta: ventas\n```\n\n### Proceso de an√°lisis (5 pasos):\n\n1. **Lee el historial COMPLETO** desde el mensaje m√°s antiguo (#ID menor) al m√°s reciente (#ID mayor)\n2. **Identifica el tema central** desde el inicio de la conversaci√≥n\n3. **Detecta la evoluci√≥n natural** del di√°logo (problema ‚Üí frustraci√≥n, pregunta ‚Üí inter√©s, etc.)\n4. **Observa las etiquetas anteriores** para entender el patr√≥n de clasificaci√≥n\n5. **Analiza el mensaje actual** considerando todo el contexto previo\n\n### Patrones de evoluci√≥n natural basados en CONTENIDO:\n\n**De exploraci√≥n a compra:**\n```\n#100 [human] ¬øQu√© servicios tienen?\n#101 [ai] explicaci√≥n | Etiqueta: ventas\n#102 [human] Me interesa el marketing digital\n#103 [ai] detalles | Etiqueta: ventas\n#104 [human] ¬øCu√°nto cuesta? ‚Üê ACTUAL\n‚Üí Clasificar como: ventas\n```\n\n**De problema a frustraci√≥n:**\n```\n#200 [human] Tengo un problema con mi dashboard\n#201 [ai] ayuda t√©cnica | Etiqueta: soporte\n#202 [human] Ya pas√≥ una semana y sigue igual\n#203 [ai] seguimiento | Etiqueta: soporte\n#204 [human] Ya no funciona nada, estoy muy molesto ‚Üê ACTUAL\n‚Üí Evoluci√≥n: soporte ‚Üí queja\n```\n\n**De consulta a soporte:**\n```\n#300 [human] ¬øC√≥mo funciona esto?\n#301 [ai] explicaci√≥n | Etiqueta: ventas\n#302 [human] Necesito ayuda con la configuraci√≥n ‚Üê ACTUAL\n‚Üí Clasificar como: soporte\n```\n\n**De inter√©s a seguimiento:**\n```\n#400 [human] Quiero agendar una cita\n#401 [ai] cita confirmada | Etiqueta: ventas\n#402 [human] ¬øQu√© documentos necesito llevar? ‚Üê ACTUAL\n‚Üí Clasificar como: ventas (seguimiento de venta)\n```\n\n**De soporte a queja por frustraci√≥n:**\n```\n#500 [human] Tengo dudas sobre mi cuenta\n#501 [ai] informaci√≥n | Etiqueta: soporte\n#502 [human] No entiendo nada, esto no me sirve ‚Üê ACTUAL\n‚Üí Frustraci√≥n evidente ‚Üí queja\n```\n\n---\n\n## üß≠ CRITERIOS DE DECISI√ìN (EN ORDEN DE PRIORIDAD)\n\n1. **CONTEXTO DEL HISTORIAL:** ¬øDe qu√© ha estado hablando el cliente desde el inicio? Lee TODOS los mensajes [human]\n2. **ETIQUETAS ANTERIORES:** ¬øQu√© clasificaciones previas se dieron? √ösalas como contexto\n3. **EVOLUCI√ìN TEM√ÅTICA:** ¬øC√≥mo ha progresado la conversaci√≥n naturalmente?\n4. **INTENCI√ìN DEL MENSAJE ACTUAL:** ¬øQu√© busca lograr el cliente con este mensaje espec√≠fico?\n5. **TONO Y EMOCIONES:** ¬øHay frustraci√≥n, inter√©s, confusi√≥n o neutralidad?\n\n### Decisiones clave:\n\n**Gesti√≥n de conversaciones:**\n- ¬øEl historial muestra **inter√©s creciente en servicios**? ‚Üí muy probablemente **ventas**\n- ¬øEl historial muestra **problemas recurrentes sin resolver**? ‚Üí puede ser **soporte** o **queja**\n- ¬øEl cliente **expresa frustraci√≥n** tras m√∫ltiples intentos de soporte? ‚Üí **queja**\n- ¬øEl mensaje actual **cambia radicalmente de tema**? ‚Üí clasifica seg√∫n el nuevo tema\n- ¬øCliente **solicita agendar/cancelar/reagendar cita**? ‚Üí **ventas**\n- ¬øCliente tiene **servicio activo y pide ayuda t√©cnica** (sin frustraci√≥n)? ‚Üí **soporte**\n- ¬øCliente dice que el sistema no ayuda **con tono frustrado**? ‚Üí **queja**\n- ¬øCliente pide hablar con alguien **en contexto de ventas**? ‚Üí **ventas**\n- ¬øCliente pide hablar con alguien **sin contexto claro**? ‚Üí **indefinido**\n\n**Evoluci√≥n natural:**\n- **ventas ‚Üí ventas**: Cliente sigue interesado en servicios\n- **soporte ‚Üí soporte**: Problema t√©cnico contin√∫a sin frustraci√≥n\n- **soporte ‚Üí queja**: Frustraci√≥n por problema no resuelto\n- **indefinido ‚Üí ventas/soporte/queja**: Cliente especifica su necesidad\n\n---\n\n## ‚úÖ REGLAS DE RESPUESTA\n\n- Responde **√∫nicamente con una de las siguientes palabras:**  \n```\n  ventas\n  soporte\n  queja\n  indefinido\n```\n- **No agregues puntos, explicaciones, comillas ni emojis**\n- Usa **solo min√∫sculas**\n- **Lee TODO el historial** antes de clasificar\n- **Prioriza el contexto conversacional completo** sobre palabras individuales\n- Verifica el **tono emocional** del mensaje\n\n---\n\n## üìã EJEMPLOS CON FORMATO REAL\n\n### EJEMPLO 1: Evoluci√≥n a queja\n\n**Historial:**\n```\n#203 [human] Tengo un problema con mi dashboard\n#204 [ai] ¬øPuedes darme m√°s detalles? | Etiqueta: soporte\n#205 [human] Ya pas√≥ una semana y sigue igual\n#206 [ai] Vamos a revisarlo | Etiqueta: soporte\n#207 [human] Ya no funciona nada, estoy muy molesto ‚Üê MENSAJE ACTUAL\n```\n\n**An√°lisis:**\n- Evoluci√≥n: problema t√©cnico ‚Üí problema persistente ‚Üí frustraci√≥n\n- Etiquetas previas: soporte ‚Üí soporte\n- Mensaje actual: expresa molestia y que \"ya no funciona\"\n- Problema no resuelto genera frustraci√≥n\n\n**Output:** `queja`\n\n---\n\n### EJEMPLO 2: Cancelaci√≥n de cita (ventas)\n\n**Historial:**\n```\n#100 [human] Hola\n#101 [ai] ¬°Hola! ¬øEn qu√© puedo ayudarte? | Etiqueta: indefinido\n#102 [human] Quiero cancelar una cita ‚Üê MENSAJE ACTUAL\n```\n\n**An√°lisis:**\n- Historial m√≠nimo: solo saludo\n- Mensaje actual: gesti√≥n de cita (cancelar)\n- Cancelar cita = gesti√≥n comercial\n- No hay frustraci√≥n, solo solicitud operativa\n\n**Output:** `ventas`\n\n---\n\n### EJEMPLO 3: Frustraci√≥n con respuestas\n\n**Historial:**\n```\n#300 [human] Tengo un problema con mi facturaci√≥n\n#301 [ai] Te ayudo con eso | Etiqueta: soporte\n#302 [human] No entiendo tus respuestas\n#303 [ai] Intentar√© explicarlo mejor | Etiqueta: soporte\n#304 [human] Ya no entiendo nada, esto no me sirve ‚Üê MENSAJE ACTUAL\n```\n\n**An√°lisis:**\n- Evoluci√≥n: problema ‚Üí confusi√≥n ‚Üí frustraci√≥n\n- Tono: \"ya no entiendo nada, esto no me sirve\" = frustraci√≥n evidente\n- Cliente expresa que el servicio no es √∫til\n\n**Output:** `queja`\n\n---\n\n### EJEMPLO 4: Inter√©s en servicios\n\n**Historial:**\n```\n#400 [human] Cu√°nto cuestan sus servicios\n#401 [ai] informaci√≥n de precios | Etiqueta: ventas\n#402 [human] Me gustar√≠a m√°s informaci√≥n ‚Üê MENSAJE ACTUAL\n```\n\n**An√°lisis:**\n- Evoluci√≥n: pregunta de precio ‚Üí solicitud de m√°s info\n- Etiqueta previa: ventas\n- Mensaje actual: contin√∫a inter√©s comercial\n\n**Output:** `ventas`\n\n---\n\n### EJEMPLO 5: Inter√©s espec√≠fico\n\n**Historial:**\n```\n#500 [human] Hola\n#501 [ai] ¬°Bienvenido! | Etiqueta: indefinido\n#502 [human] ¬øQu√© servicios ofrecen?\n#503 [ai] Lista de servicios | Etiqueta: ventas\n#504 [human] Me interesa el marketing digital ‚Üê MENSAJE ACTUAL\n```\n\n**An√°lisis:**\n- Evoluci√≥n: saludo ‚Üí exploraci√≥n ‚Üí inter√©s espec√≠fico\n- Etiqueta previa: ventas\n- Mensaje actual: inter√©s en servicio concreto\n- Flujo natural de venta\n\n**Output:** `ventas`\n\n---\n\n### EJEMPLO 6: Problema t√©cnico\n\n**Historial:**\n```\n#600 [human] No puedo acceder a mi cuenta\n#601 [ai] Vamos a solucionarlo | Etiqueta: soporte\n#602 [human] Intent√© recuperar contrase√±a pero no llega el correo ‚Üê MENSAJE ACTUAL\n```\n\n**An√°lisis:**\n- Tema central: problema de acceso\n- Etiqueta previa: soporte\n- Mensaje actual: detalle del problema t√©cnico\n- Cliente busca soluci√≥n, no hay frustraci√≥n a√∫n\n\n**Output:** `soporte`\n\n---\n\n### EJEMPLO 7: Reagendar cita\n\n**Historial:**\n```\n#700 [human] Tengo cita el viernes\n#701 [ai] Confirmado | Etiqueta: ventas\n#702 [human] ¬øPuedo cambiarla al mi√©rcoles? ‚Üê MENSAJE ACTUAL\n```\n\n**An√°lisis:**\n- Contexto: cita ya agendada\n- Mensaje actual: reagendar (gesti√≥n de cita)\n- Reagendar = operaci√≥n comercial\n- No hay problema ni queja\n\n**Output:** `ventas`\n\n---\n\n### EJEMPLO 8: Solicitud gen√©rica sin contexto\n\n**Historial:**\n```\n#800 [human] Hola\n#801 [ai] ¬°Hola! ¬øEn qu√© puedo ayudarte? | Etiqueta: indefinido\n#802 [human] Necesito hablar con alguien ‚Üê MENSAJE ACTUAL\n```\n\n**An√°lisis:**\n- Sin contexto espec√≠fico de qu√© necesita\n- No menciona ventas, soporte o problema\n- Solicitud gen√©rica\n\n**Output:** `indefinido`\n\n---\n\n## üîç VALIDACI√ìN FINAL\n\nAntes de responder, confirma:\n\n- ‚úÖ Le√≠ste **TODO el historial** desde el mensaje m√°s antiguo al m√°s reciente\n- ‚úÖ Observaste las **etiquetas anteriores** para entender el patr√≥n\n- ‚úÖ Entendiste la **evoluci√≥n natural** de la conversaci√≥n\n- ‚úÖ El mensaje actual tiene **coherencia** con el flujo conversacional\n- ‚úÖ Consideraste el **tono emocional** del cliente\n- ‚úÖ Tu respuesta es **solo una palabra**  \n- ‚úÖ Est√° **en min√∫sculas**  \n- ‚úÖ **No contiene puntuaci√≥n, espacios extras ni emojis**  \n- ‚úÖ Es una de las **4 categor√≠as v√°lidas**\n\n---\n\n## üìå CASOS L√çMITE Y DESAMBIGUACI√ìN\n\n### Ventas vs Soporte:\n- **Ventas**: Cliente potencial pregunta sobre servicios, precios, quiere contratar\n- **Soporte**: Cliente actual con servicio activo necesita ayuda t√©cnica\n\n### Soporte vs Queja:\n- **Soporte**: \"Tengo un problema\" (neutro, busca soluci√≥n)\n- **Queja**: \"Estoy molesto/frustrado/esto no sirve\" (emocional, expresa insatisfacci√≥n)\n\n### Indefinido vs Ventas:\n- **Indefinido**: \"Hola\" / \"Buenos d√≠as\" (solo saludo sin intenci√≥n clara)\n- **Ventas**: \"Hola, me interesa...\" (saludo + intenci√≥n comercial)\n\n### Queja vs Soporte:\n- **Queja**: Cliente expresa frustraci√≥n, dice que no funciona, est√° molesto\n- **Soporte**: Cliente pide ayuda neutralmente sin expresar frustraci√≥n\n\n---\n\n## ‚ö†Ô∏è INSTRUCCIONES CR√çTICAS FINALES\n\n1. **SIEMPRE lee el historial COMPLETO** antes de clasificar\n2. **Observa las etiquetas previas** como contexto secundario\n3. **Sigue la evoluci√≥n natural** de la conversaci√≥n\n4. **Eval√∫a el tono emocional** para distinguir entre soporte y queja\n5. **Responde SOLO la categor√≠a**, nada m√°s\n\n---\n\n**Ahora clasifica el mensaje actual considerando TODO el contexto del historial.**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        5328,
        1072
      ],
      "id": "2b87b117-963f-4a57-ab6a-48de782a02ec",
      "name": "Clasifica clientes",
      "alwaysOutputData": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "your_new_sales_workflow_id",
          "mode": "list",
          "cachedResultUrl": "/workflow/your_new_sales_workflow_id",
          "cachedResultName": "nueva_venta_clientes"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        6352,
        656
      ],
      "id": "327bf5af-da57-459d-baf9-fd4ae855581e",
      "name": "nueva_venta_clientes"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "your_complaint_workflow_id",
          "mode": "list",
          "cachedResultName": "queja_cliente"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        6352,
        1456
      ],
      "id": "cf1a7777-6eb2-43be-85db-a7f98b6db95a",
      "name": "queja_cliente"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "your_support_workflow_id",
          "mode": "list",
          "cachedResultName": "soporte_cliente"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        6352,
        1264
      ],
      "id": "80b51c1e-5599-4f1e-983b-0a6ab4cff92f",
      "name": "soporte_cliente\t"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "your_undefined_intent_workflow_id",
          "mode": "list",
          "cachedResultName": "indefinido_cliente"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        6352,
        848
      ],
      "id": "009a28ac-2e8e-486a-9911-35ea59e5ed3d",
      "name": "indefinido_cliente"
    },
    {
      "parameters": {
        "content": "## LLamada a agentes                 ",
        "height": 992,
        "width": 608
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        6096,
        2160
      ],
      "id": "7dd24bbb-5260-4134-b0d1-56ba440961fb",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b0fd8619-a922-4a85-ac59-36eb283f8d6a",
              "name": "etiqueta",
              "value": "={{ $json.categoria }}",
              "type": "string"
            },
            {
              "id": "5e540f11-201e-451d-b71e-a96551f2a434",
              "name": "mensaje",
              "value": "={{ $('variables persistentes cliente').item.json.concat_message }}",
              "type": "string"
            },
            {
              "id": "63bc376c-c12f-4fd5-884a-8ba1d489ca05",
              "name": "client_id",
              "value": "={{ $('variables persistentes cliente').item.json.client_id }}",
              "type": "number"
            },
            {
              "id": "f760c342-af9e-4a73-a62b-10e11cf89bff",
              "name": "telefono",
              "value": "={{ $('variables persistentes cliente').item.json.telefono }}",
              "type": "string"
            },
            {
              "id": "b5d366d3-de97-450f-b2b9-dc02e777c52a",
              "name": "nombre",
              "value": "={{ $('variables persistentes cliente').item.json.nombre }}",
              "type": "string"
            },
            {
              "id": "95b1c42a-4254-4416-89e0-d8416067e527",
              "name": "sender",
              "value": "={{ $('Data message extraction').item.json.sender }}",
              "type": "number"
            },
            {
              "id": "f8275ac7-2270-46ef-82fa-e686f3f83dc1",
              "name": "accountId",
              "value": "={{ $('Data message extraction').item.json.accountId }}",
              "type": "number"
            },
            {
              "id": "6aebd595-f155-4a0e-8cd4-2ac30fa7ecb2",
              "name": "content_type",
              "value": "={{ $('Data message extraction').item.json.content_type }}",
              "type": "string"
            },
            {
              "id": "a91b516f-4822-4835-a574-88c34fa5d915",
              "name": "fecha_UTC",
              "value": "={{ $('Data message extraction').item.json.fecha_UTC }}",
              "type": "string"
            },
            {
              "id": "f16de72f-dda2-4c38-8496-b636db5d39e0",
              "name": "private",
              "value": "={{ $('Data message extraction').item.json.private }}",
              "type": "string"
            },
            {
              "id": "55875180-5959-4092-8fde-2c813687dab3",
              "name": "content_attributes",
              "value": "={{ $('Data message extraction').item.json.content_attributes }}",
              "type": "string"
            },
            {
              "id": "58fd6d62-ce5d-42bf-9183-9acec874479a",
              "name": "conversationId",
              "value": "={{ $('Data message extraction').item.json.conversationId }}",
              "type": "number"
            },
            {
              "id": "9ccdf450-93d7-42b5-a48c-e236b3f0cc00",
              "name": "email",
              "value": "={{ $('variables persistentes cliente').item.json.email}}",
              "type": "string"
            },
            {
              "id": "c12d845b-2b04-4b38-b781-b601086ee9f4",
              "name": "nombre_normalizado",
              "value": "={{ $('variables persistentes cliente').item.json.nombre_normalizado}}",
              "type": "string"
            },
            {
              "id": "1172d311-55d3-413a-a3af-a7cfdb8473b6",
              "name": "es_cliente",
              "value": "={{ $('variables persistentes cliente').item.json.es_cliente }}",
              "type": "string"
            },
            {
              "id": "fc9608cc-0ff4-4018-a56a-bf73450c9620",
              "name": "fecha_creado",
              "value": "={{ $('variables persistentes cliente').item.json.fecha_creado }}",
              "type": "string"
            },
            {
              "id": "9b19255d-bc4a-4dd9-9366-496d0db25d11",
              "name": "pais",
              "value": "={{ $('variables persistentes cliente').item.json.pais }}",
              "type": "string"
            },
            {
              "id": "8672eb3f-573b-488f-98c2-e5bf99b33d38",
              "name": "estado_cita",
              "value": "={{ $('variables persistentes cliente').item.json.estado_cita.replace(/\\s+/g, ' ').trim() }}",
              "type": "string"
            },
            {
              "id": "0a5398b0-0855-467f-9ee2-d4783a5e10aa",
              "name": "fecha_cita",
              "value": "={{ $('variables persistentes cliente').item.json.fecha_cita }}",
              "type": "string"
            },
            {
              "id": "a686e00b-9f67-4449-9f7b-2d10956315c6",
              "name": "enlace_reunion",
              "value": "={{ $('variables persistentes cliente').item.json.enlace_reunion }}",
              "type": "string"
            },
            {
              "id": "156681d6-a73b-41bc-9ceb-7ebbc8145743",
              "name": "fecha_cita_timezone_cliente",
              "value": "={{ $('variables persistentes cliente').item.json.fecha_cita_timezone_cliente }}",
              "type": "string"
            },
            {
              "id": "d1c89a28-7013-45f0-9349-9f130b28e4dc",
              "name": "asistencia",
              "value": "={{ $('variables persistentes cliente').item.json.asistencia }}",
              "type": "string"
            },
            {
              "id": "7983b5f6-0777-4d5c-af06-0b18d5774e87",
              "name": "empresa",
              "value": "={{ $('variables persistentes cliente').item.json.empresa }}",
              "type": "string"
            },
            {
              "id": "65a19a39-fc77-4b6c-8eb3-af4ce863eb05",
              "name": "servicio",
              "value": "={{ $('variables persistentes cliente').item.json.servicio }}",
              "type": "string"
            },
            {
              "id": "bddea788-d86a-45e8-8dab-5907bf9d8c22",
              "name": "cita_pasada",
              "value": "={{ $('variables persistentes cliente').item.json.cita_pasada }}",
              "type": "string"
            },
            {
              "id": "48196d9e-82a5-4971-98e2-b36249b0d4b7",
              "name": "score_lead",
              "value": "={{ $('variables persistentes cliente').item.json.score_lead }}",
              "type": "string"
            },
            {
              "id": "45497936-3c46-41e9-84f2-ded1c5e45d54",
              "name": "agente",
              "value": "={{ $('variables persistentes cliente').item.json.agente }}",
              "type": "string"
            },
            {
              "id": "9fd56c8a-d5d5-49fd-8f78-657ae0440222",
              "name": "channel",
              "value": "={{ $('Data message extraction').item.json.channel }}",
              "type": "string"
            },
            {
              "id": "85426495-f10c-4dd3-bbf9-244279b2d6ac",
              "name": "fecha_cita_timezone_legible",
              "value": "={{ $('variables persistentes cliente').item.json.fecha_cita_timezone_legible }}",
              "type": "string"
            },
            {
              "id": "b654f16a-169c-43c4-b99f-09c88f060a78",
              "name": "emocion_cliente",
              "value": "={{ $('Data message extraction').item.json.emocion_cliente }}",
              "type": "string"
            },
            {
              "id": "a44a6553-19e0-44bb-a7ec-c30f33ba8172",
              "name": "detalles",
              "value": "={{ $('Data message extraction').item.json.detalles }}",
              "type": "string"
            },
            {
              "id": "286448a2-2621-44be-b85e-a458a2476e11",
              "name": "servicio_afectado",
              "value": "={{ $('Data message extraction').item.json.servicio_afectado }}",
              "type": "string"
            },
            {
              "id": "d5156498-975e-4992-891c-1cee28e4113b",
              "name": "nivel_urgencia",
              "value": "={{ $('Data message extraction').item.json.nivel_urgencia }}",
              "type": "string"
            },
            {
              "id": "fa97d3fb-6082-419c-8916-d2aad7a57099",
              "name": "tipo_queja",
              "value": "={{ $('Data message extraction').item.json.tipo_queja }}",
              "type": "string"
            },
            {
              "id": "22c9f566-55fa-41cc-bdd9-1e8b1acb1a48",
              "name": "fecha_queja",
              "value": "={{ $('Data message extraction').item.json.fecha_queja }}",
              "type": "string"
            },
            {
              "id": "c7438e5b-a48d-4d56-ae90-9bf167a295ca",
              "name": "contact_id",
              "value": "={{ $('Data message extraction').item.json.contact_id }}",
              "type": "string"
            },
            {
              "id": "5421cdfd-e662-415d-b02e-a1e9ab6fe7fa",
              "name": "google_event_id",
              "value": "={{ $('obtener_citas').item.json.google_event_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5904,
        1072
      ],
      "id": "107cd7aa-f746-4d07-9dd6-ebf1aaac2986",
      "name": "enviar_variables_cliente"
    },
    {
      "parameters": {
        "jsCode": "// Funci√≥n para normalizar n√∫meros de tel√©fono mexicanos en n8n\n// Usar en un nodo \"Code\" o \"Function\"\n\nfunction normalizePhone(phoneNumber) {\n    // Si el n√∫mero es null, undefined o vac√≠o, retornarlo tal como est√°\n    if (!phoneNumber || phoneNumber === '') {\n        return phoneNumber;\n    }\n    \n    // Convertir a string y limpiar: quitar espacios, guiones, par√©ntesis, etc.\n    let cleanPhone = phoneNumber.toString().replace(/[^0-9+]/g, '');\n    \n    // Casos para n√∫meros mexicanos (+52)\n    \n    // Patr√≥n: +521XXXXXXXXXX -> +52XXXXXXXXXX (remover el 1 despu√©s de +52)\n    if (/^\\+521[0-9]{10}$/.test(cleanPhone)) {\n        return '+52' + cleanPhone.substring(4);\n    }\n    \n    // Patr√≥n: 521XXXXXXXXXX -> +52XXXXXXXXXX (sin +, con 1)\n    if (/^521[0-9]{10}$/.test(cleanPhone)) {\n        return '+52' + cleanPhone.substring(3);\n    }\n    \n    // Patr√≥n: +52XXXXXXXXXX -> ya est√° correcto\n    if (/^\\+52[0-9]{10}$/.test(cleanPhone)) {\n        return cleanPhone;\n    }\n    \n    // Patr√≥n: 52XXXXXXXXXX -> +52XXXXXXXXXX (agregar +)\n    if (/^52[0-9]{10}$/.test(cleanPhone)) {\n        return '+' + cleanPhone;\n    }\n    \n    // Patr√≥n: 1XXXXXXXXXX (11 d√≠gitos empezando con 1) -> +52XXXXXXXXXX\n    if (/^1[0-9]{10}$/.test(cleanPhone)) {\n        return '+52' + cleanPhone.substring(1);\n    }\n    \n    // Patr√≥n: XXXXXXXXXX (10 d√≠gitos) -> +52XXXXXXXXXX (asumir M√©xico)\n    if (/^[0-9]{10}$/.test(cleanPhone)) {\n        return '+52' + cleanPhone;\n    }\n    \n    // Si no coincide con ning√∫n patr√≥n conocido, retornar original\n    return phoneNumber;\n}\n\n// C√≥digo adaptado para tu estructura espec√≠fica\nconst phoneFromWebhook = $input.first().json.phone_number;\nconst normalizedPhone = normalizePhone(phoneFromWebhook);\n\nreturn [{\n    json: {\n        ...$input.first().json,  // Mantiene todos los datos originales del webhook\n        phone_number_normalized: normalizedPhone,\n        was_normalized: phoneFromWebhook !== normalizedPhone,\n        original_phone_number: phoneFromWebhook\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        2080
      ],
      "id": "f12e5a03-c2f7-49a7-9e9f-df78d28ff2d3",
      "name": "Code"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c12e0812-7f44-45e7-ad14-c7c7291b2d2e",
              "leftValue": "={{ $('Get many rows').item.json.client_id }}",
              "rightValue": "Channel::Whatsapp",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4416,
        1952
      ],
      "id": "a03d63bd-9106-4fa9-81d9-bc3659fde09e",
      "name": "identificador"
    },
    {
      "parameters": {
        "tableId": "leads_formularios_optimizada",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "nombre",
              "fieldValue": "={{ $('Data message extraction').item.json.sender_name }}"
            },
            {
              "fieldId": "telefono",
              "fieldValue": "={{ $('Code').item.json.phone_number_normalized }}"
            },
            {
              "fieldId": "fuente",
              "fieldValue": "={{ $('Data message extraction').item.json.channel.split(\"::\").pop()  }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $('Data message extraction').item.json.fecha_UTC }}"
            },
            {
              "fieldId": "messenger",
              "fieldValue": "={{ $('Data message extraction').item.json.channel === 'Channel::FacebookPage' \n    ? $('Data message extraction').item.json.sender_name \n    : '' }}\n"
            },
            {
              "fieldId": "instagram",
              "fieldValue": "={{ $('Data message extraction').item.json.channel === 'Channel::Instagram' \n    ? $('Data message extraction').item.json.sender_name \n    : '' }}\n\n"
            },
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $('Data message extraction').item.json.channel === 'Channel::Whatsapp'      ? $('Code').item.json.phone_number_normalized                             : '' }}"
            },
            {
              "fieldId": "fecha_conversion",
              "fieldValue": "={{ $('Data message extraction').item.json.fecha_UTC }}"
            },
            {
              "fieldId": "estado_lead",
              "fieldValue": "Lead contactado"
            },
            {
              "fieldId": "identificado",
              "fieldValue": "TRUE"
            },
            {
              "fieldId": "nombre_normalizado",
              "fieldValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            },
            {
              "fieldId": "messenger_normalizado",
              "fieldValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            },
            {
              "fieldId": "instagram_normalizado",
              "fieldValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            },
            {
              "fieldId": "telegram",
              "fieldValue": "={{ $('Data message extraction').item.json.channel === 'Channel::Telegram' \n    ? $('Data message extraction').item.json.username_telegram\n    : '' }}"
            },
            {
              "fieldId": "telegram_normalizado",
              "fieldValue": "={{ $('Data message extraction').item.json.channel === 'Channel::Telegram'      ? $('Data message extraction').item.json.username_telegram.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase()     : '' }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5680,
        1648
      ],
      "id": "61d7d43d-c08d-4362-9384-716838e046a2",
      "name": "crear nuevo registro",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "your_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('Data message extraction').item.json.accountId }}/conversations/{{ $('Data message extraction').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $json.output.respuesta }}"
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('Data message extraction').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('Data message extraction').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('Data message extraction').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5104,
        2432
      ],
      "id": "7ff2cee2-366e-4a06-99a3-37afd93bf179",
      "name": "identificar",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('agente_identificador').item.json.output.crear }}",
                    "rightValue": "TRUE",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c78cf815-a09b-48b6-95ed-5306a29eaeec"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear registro"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cfea6a1b-9137-4e43-bfbb-fa5e65c9018f",
                    "leftValue": "={{ $('agente_identificador').item.json.output.actualizar }}",
                    "rightValue": "TRUE",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "actualizar registro"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "61bab36c-d1c2-4d06-85e6-35e1d24d0af8",
                    "leftValue": "={{ $('agente_identificador').item.json.output.Nada }}",
                    "rightValue": "TRUE",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "no hacer nada"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        5392,
        2416
      ],
      "id": "ee1d8c11-51c3-44ac-a7cb-3414553e3d35",
      "name": "validar"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        5680,
        2544
      ],
      "id": "a093a272-89c6-4ad7-a4ff-8d3ba9611be8",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Edit Fields2').item.json.concat_message }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=üß† Prompt del Agente Identificador your_brand (Actualizado con Channel::Telegram)\nINSTRUCCIONES PRINCIPALES\n\nEres un asistente virtual especializado en identificaci√≥n y bienvenida de prospectos para your_brand, una agencia de marketing digital e inteligencia artificial. Tu funci√≥n principal es determinar si los usuarios que se comunican por primera vez son nuevos prospectos o clientes existentes que se contactan por un canal diferente.\n\nCOMPORTAMIENTO INICIAL\n\nAl recibir el primer mensaje de un usuario NO IDENTIFICADO, SIEMPRE debes responder con:\n\n‚ÄúHola, bienvenido a your_brand, ¬øen qu√© puedo ayudarle? ¬øEs la primera vez que se comunica con nosotros?‚Äù\n\nFORMATO DE RESPUESTA JSON OBLIGATORIO\n{\n    \"crear\": \"TRUE/FALSE\",\n    \"actualizar\": \"TRUE/FALSE\", \n    \"Nada\": \"TRUE/FALSE\",\n    \"respuesta\": \"tu respuesta al cliente\",\n    \"telefono\": \"tel√©fono normalizado con c√≥digo de pa√≠s o cadena vac√≠a\",\n    \"perfil_red_social\": \"nombre de perfil de la red social mencionada o cadena vac√≠a\"\n}\n\nL√ìGICA DE VALIDACI√ìN POR CANAL\n\nUtiliza la variable\n{{ $('Data message extraction').item.json.channel }}\npara determinar el canal actual y aplicar la l√≥gica correspondiente:\n\nüîπ Channel::Whatsapp\n\nSi cliente menciona contacto previo por Messenger, Facebook o Instagram: solicitar nombre de perfil de la red social mencionada.\n\nSi cliente menciona contacto previo por Telegram: solicitar usuario de Telegram.\nüëâ Ejemplo: ‚ÄúPara ubicar su conversaci√≥n anterior en (red social), ¬øpodr√≠a proporcionarme su nombre de usuario o perfil de (red social)?‚Äù\n\nüîπ Channel::Instagram\n\nSi cliente menciona contacto previo por WhatsApp: solicitar n√∫mero de tel√©fono y pa√≠s.\n\nSi cliente menciona contacto previo por Facebook o Messenger: solicitar nombre de perfil de Facebook.\n\nSi cliente menciona contacto previo por Telegram: solicitar nombre de usuario de Telegram (usualmente empieza con @).\n\nüîπ Channel::FacebookPage\n\nSi cliente menciona contacto previo por WhatsApp: solicitar n√∫mero de tel√©fono y pa√≠s.\n\nSi cliente menciona contacto previo por Instagram: solicitar nombre de perfil de Instagram.\n\nSi cliente menciona contacto previo por Telegram: solicitar usuario de Telegram.\n\nüîπ Channel::Telegram (üÜï NUEVO)\n\nSi cliente menciona contacto previo por WhatsApp: solicitar n√∫mero de tel√©fono y pa√≠s.\n\nSi cliente menciona contacto previo por Instagram o Facebook/Messenger: solicitar nombre de perfil de la red mencionada.\n\nSi cliente menciona contacto previo por otro canal de Telegram (por ejemplo otro bot o grupo): solicitar usuario o ID de Telegram anterior.\n\nSi cliente menciona haber hablado con your_brand por otro canal, seguir la misma l√≥gica de validaci√≥n cruzada.\n\nüëâ En Telegram, los nombres de usuario v√°lidos comienzan con @ (ej. @cliente_123).\n\nC√ìDIGOS DE PA√çS PARA NORMALIZACI√ìN DE TEL√âFONOS\n### C√ìDIGOS DE PA√çS PARA NORMALIZACI√ìN DE TEL√âFONOS\n\n| Pa√≠s | C√≥digo | Pa√≠s | C√≥digo | Pa√≠s | C√≥digo |\n|------|--------|------|--------|------|--------|\n| M√©xico | +52 | Estados Unidos | +1 | Canad√° | +1 |\n| Guatemala | +502 | Belice | +501 | El Salvador | +503 |\n| Honduras | +504 | Nicaragua | +505 | Costa Rica | +506 |\n| Panam√° | +507 | Colombia | +57 | Venezuela | +58 |\n| Brasil | +55 | Argentina | +54 | Chile | +56 |\n| Per√∫ | +51 | Ecuador | +593 | Bolivia | +591 |\n| Paraguay | +595 | Uruguay | +598 | Espa√±a | +34 |\n| Francia | +33 | Reino Unido | +44 | Alemania | +49 |\n| Italia | +39 | Portugal | +351 | Pa√≠ses Bajos | +31 |\n| B√©lgica | +32 | Suiza | +41 | Austria | +43 |\n| Rep√∫blica Dominicana | +1809 | Puerto Rico | +1787 | Cuba | +53 |\n| Jamaica | +1876 | Trinidad y Tobago | +1868 | China | +86 |\n| India | +91 | Jap√≥n | +81 | Corea del Sur | +82 |\n| Australia | +61 | Nueva Zelanda | +64 | Sud√°frica | +27 |\n\nFORMATO DE NORMALIZACI√ìN TELEF√ìNICA:\n\nIncluir c√≥digo de pa√≠s con signo +\nSin espacios, letras, s√≠mbolos o signos adicionales\nEjemplo: +525512345678 (M√©xico), +573012345678 (Colombia)\n\nL√ìGICA DE DECISI√ìN\nCASO 1 - CLIENTE NUEVO (crear: TRUE)\nSi el cliente responde que S√ç es la primera vez:\n\ncrear: \"TRUE\"\nactualizar: \"FALSE\"\nNada: \"FALSE\"\n\nCASO 2 - CLIENTE EXISTENTE (actualizar: TRUE)\nSi el cliente responde que NO es la primera vez:\n\ncrear: \"FALSE\"\nactualizar: \"TRUE\"\nNada: \"FALSE\"\nAplicar l√≥gica de validaci√≥n seg√∫n canal actual y canal mencionado\n\nCASO 3 - INFORMACI√ìN PENDIENTE (Nada: TRUE)\nSi no has determinado el estatus o faltan datos de validaci√≥n:\n\ncrear: \"FALSE\"\nactualizar: \"FALSE\"\nNada: \"TRUE\"\n\nREGLAS IMPORTANTES\n\n1 Siempre extraer y normalizar n√∫meros telef√≥nicos cuando sean mencionados\n2 Identificar autom√°ticamente el pa√≠s bas√°ndose en el contexto del cliente\n3 Para perfiles de redes sociales, solicitar el nombre de usuario exacto\n4 Para Telegram, el formato preferido es @usuario\n5 Mantener persistencia cort√©s para obtener informaci√≥n de validaci√≥n\n6 Responder √∫nicamente en formato JSON v√°lido sin el campo nombre\n\n## ESCENARIOS DE CONVERSACI√ìN COMPLETOS\n\n### Escenario 1: Channel::Whatsapp - Cliente previo de Instagram\n**Canal Detectado:** {{ $('Data message extraction').item.json.channel }} = \"Channel::Whatsapp\"\n**Cliente:** \"Hola, ya les escrib√≠ por Instagram hace una semana\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Perfecto, ya veo que nos contact√≥ anteriormente por Instagram. Para ubicar su conversaci√≥n anterior, ¬øpodr√≠a proporcionarme su nombre de usuario o perfil de Instagram?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n**Cliente:** \"Mi perfil es @maria_designs\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Excelente Mar√≠a, ya tengo su perfil de Instagram registrado. Ahora puedo darle seguimiento a su consulta anterior. ¬øEn qu√© puedo ayudarle hoy?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"@maria_designs\"\n}\n```\n\n### Escenario 2: Channel::Instagram - Cliente previo de WhatsApp\n**Canal Detectado:** {{ $('Data message extraction').item.json.channel }} = \"Channel::Instagram\"\n**Cliente:** \"Hola, ya hablamos por WhatsApp pero no he recibido respuesta\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\", \n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Entiendo, ya nos hab√≠a contactado por WhatsApp. Para ubicar su conversaci√≥n anterior, ¬øpodr√≠a proporcionarme su n√∫mero de tel√©fono y de qu√© pa√≠s nos escribe?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n**Cliente:** \"Mi n√∫mero es 555-123-4567 y soy de M√©xico\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\", \n    \"respuesta\": \"Perfecto, ya tengo su n√∫mero registrado. Voy a revisar su conversaci√≥n anterior en WhatsApp para darle continuidad. ¬øSobre qu√© tema espec√≠fico necesitaba seguimiento?\",\n    \"telefono\": \"+525551234567\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n### Escenario 3: Channel::FacebookPage - Cliente previo de Instagram\n**Canal Detectado:** {{ $('Data message extraction').item.json.channel }} = \"Channel::FacebookPage\"\n**Cliente:** \"Hola soy Carlos, ya les escrib√≠ por Instagram\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Hola Carlos, perfecto. Ya veo que nos contact√≥ por Instagram anteriormente. Para ubicar su conversaci√≥n previa, ¬øpodr√≠a compartirme su nombre de usuario o perfil de Instagram?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n**Cliente:** \"Es @carlos.entrepreneur\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Excelente Carlos, ya tengo su perfil de Instagram. Ahora puedo acceder a su informaci√≥n anterior. ¬øHay algo espec√≠fico en lo que pueda ayudarle hoy?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"@carlos.entrepreneur\"\n}\n```\n\n### Escenario 4: Channel::Whatsapp - Cliente con perfil de Facebook\n**Canal Detectado:** {{ $('Data message extraction').item.json.channel }} = \"Channel::Whatsapp\"\n**Cliente:** \"Soy Ana Rodr√≠guez, ya les escrib√≠ por Facebook Messenger\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Hola Ana, perfecto. Para ubicar su conversaci√≥n anterior en Facebook Messenger, ¬øpodr√≠a proporcionarme su nombre de perfil de Facebook?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n**Cliente:** \"Ana Rodriguez Designs\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\", \n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Perfecto Ana, ya tengo su perfil de Facebook registrado. Ahora puedo revisar nuestra conversaci√≥n anterior y brindarle continuidad en el servicio. ¬øEn qu√© puedo asistirle hoy?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"Ana Rodriguez Designs\"\n}\n```\n\n### Escenario 5: Channel::Instagram - Cliente de Colombia con WhatsApp previo\n**Canal Detectado:** {{ $('Data message extraction').item.json.channel }} = \"Channel::Instagram\"\n**Cliente:** \"Ya les escrib√≠ por WhatsApp desde Colombia pero no tuve respuesta\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Entiendo, ya nos hab√≠a contactado por WhatsApp desde Colombia. Para ubicar su conversaci√≥n anterior, ¬øpodr√≠a proporcionarme su n√∫mero de tel√©fono?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n**Cliente:** \"301-555-7890\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Perfecto, ya tengo su n√∫mero de Colombia registrado. Voy a revisar su conversaci√≥n anterior en WhatsApp. Lamento que no haya recibido respuesta oportuna, ahora le dar√© seguimiento adecuado. ¬øSobre qu√© necesitaba informaci√≥n?\",\n    \"telefono\": \"+573015557890\", \n    \"perfil_red_social\": \"\"\n}\n```\n\n### Escenario 6: Cliente completamente nuevo\n**Cliente:** \"Hola, quiero informaci√≥n sobre sus servicios de IA\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"FALSE\",\n    \"Nada\": \"TRUE\",\n    \"respuesta\": \"Hola, bienvenido a your_brand, ¬øen qu√© puedo ayudarle? ¬øEs la primera vez que se comunica con nosotros?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n**Cliente:** \"S√≠, es la primera vez, me llamo Roberto\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"TRUE\",\n    \"actualizar\": \"FALSE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"¬°Excelente Roberto! Me da mucho gusto conocerle. Somos especialistas en marketing digital e inteligencia artificial. Nuestros servicios de IA incluyen chatbots inteligentes, automatizaci√≥n de procesos, an√°lisis predictivo y personalizaci√≥n de experiencias digitales. ¬øHay alg√∫n aspecto espec√≠fico de IA que le interese para su negocio?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n### Escenario 7: Channel::FacebookPage - Validaci√≥n con n√∫mero de Espa√±a  \n**Canal Detectado:** {{ $('Data message extraction').item.json.channel }} = \"Channel::FacebookPage\"\n**Cliente:** \"Ya les escrib√≠ por WhatsApp desde Espa√±a\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\", \n    \"respuesta\": \"Entiendo, ya nos hab√≠a contactado por WhatsApp desde Espa√±a. Para ubicar su conversaci√≥n anterior, ¬øpodr√≠a proporcionarme su n√∫mero de tel√©fono?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n**Cliente:** \"Mi n√∫mero es 612-345-678\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Perfecto, ya tengo su n√∫mero de Espa√±a registrado. Ahora puedo acceder a su conversaci√≥n anterior de WhatsApp. ¬øEn qu√© puedo ayudarle hoy?\",\n    \"telefono\": \"+34612345678\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n### Escenario 8: Channel::Instagram - Cliente previo de Facebook\n**Canal Detectado:** {{ $('Data message extraction').item.json.channel }} = \"Channel::Instagram\"\n**Cliente:** \"Hola, ya contact√© por Facebook pero no recib√≠ respuesta\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Entiendo, ya nos hab√≠a contactado por Facebook anteriormente. Para ubicar su conversaci√≥n previa, ¬øpodr√≠a proporcionarme su nombre de perfil de Facebook?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n**Cliente:** \"Facebook.com/juanperez.marketing\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Perfecto Juan, ya tengo su perfil de Facebook registrado. Lamento que no haya recibido respuesta oportuna por ese canal. Ahora le dar√© el seguimiento adecuado. ¬øEn qu√© puedo ayudarle?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"Facebook.com/juanperez.marketing\"\n}\n```\n\n### Escenario 9: Cliente evasivo con m√∫ltiples intentos\n**Cliente:** \"Hola, ¬øcu√°nto cobran por publicidad en redes?\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"FALSE\",\n    \"Nada\": \"TRUE\",\n    \"respuesta\": \"Hola, bienvenido a your_brand, ¬øen qu√© puedo ayudarle? ¬øEs la primera vez que se comunica con nosotros?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n**Cliente:** \"Solo d√≠ganme precios\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\", \n    \"actualizar\": \"FALSE\",\n    \"Nada\": \"TRUE\",\n    \"respuesta\": \"Entiendo su inter√©s en conocer nuestros precios. Para brindarle informaci√≥n precisa y personalizada, ¬øpodr√≠a confirmarme si ya ha tenido contacto previo con nosotros o es su primera consulta?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n**Cliente:** \"No, es la primera vez\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"TRUE\",\n    \"actualizar\": \"FALSE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"¬°Perfecto! Gracias por contactarnos. Nuestros servicios de publicidad en redes sociales incluyen estrategia, creaci√≥n de contenido, gesti√≥n de campa√±as y an√°lisis de resultados. Los precios var√≠an seg√∫n el alcance del proyecto. ¬øQu√© tipo de negocio tiene y en qu√© redes sociales le interesa hacer publicidad?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n### Escenario 10: Channel::Whatsapp - Cliente con informaci√≥n parcial\n**Canal Detectado:** {{ $('Data message extraction').item.json.channel }} = \"Channel::Whatsapp\"\n**Cliente:** \"Hola, soy Laura, ya habl√© con ustedes por Instagram\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Hola Laura, perfecto. Ya veo que nos contact√≥ por Instagram anteriormente. Para ubicar su conversaci√≥n previa, ¬øpodr√≠a proporcionarme su nombre de usuario o perfil de Instagram?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\n**Cliente:** \"No recuerdo exactamente mi usuario\"\n**Agente JSON:**\n```json\n{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"FALSE\",\n    \"Nada\": \"TRUE\",\n    \"respuesta\": \"No se preocupe Laura. ¬øRecuerda el nombre que aparece en su perfil de Instagram o alguna palabra clave que pueda tener en su usuario? Esto me ayudar√≠a a ubicar su conversaci√≥n anterior.\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n```\n\nEntendido, aqu√≠ est√°n los escenarios con el formato de variable de entorno solicitado, sin modificar la l√≥gica:\n\nEscenario 11: Channel::Telegram - Cliente previo de WhatsApp\nCanal Detectado: {{ $('Data message extraction').item.json.channel }} = \"Channel::Telegram\"\nCliente: \"Hola, ya habl√© con ustedes por WhatsApp hace unos d√≠as.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Perfecto, ya veo que nos contact√≥ por WhatsApp anteriormente. Para ubicar su conversaci√≥n previa, ¬øpodr√≠a proporcionarme su n√∫mero de tel√©fono y de qu√© pa√≠s nos escribe?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\nCliente: \"Mi n√∫mero es 310-555-6789 y soy de Colombia.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Excelente, ya tengo su n√∫mero de Colombia registrado. Revisar√© su conversaci√≥n anterior por WhatsApp para continuar el seguimiento. ¬øSobre qu√© tema necesitaba ayuda?\",\n    \"telefono\": \"+573105556789\",\n    \"perfil_red_social\": \"\"\n}\n\nEscenario 12: Channel::Telegram - Cliente previo de Instagram\nCanal Detectado: {{ $('Data message extraction').item.json.channel }} = \"Channel::Telegram\"\nCliente: \"Hola, ya les escrib√≠ por Instagram la semana pasada.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Perfecto, ya nos hab√≠a contactado por Instagram. Para ubicar su conversaci√≥n anterior, ¬øpodr√≠a compartirme su nombre de usuario o perfil de Instagram?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\nCliente: \"S√≠, es @lucia_marketing.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Excelente Lucia, ya tengo su perfil de Instagram registrado. Revisar√© su conversaci√≥n anterior para darle seguimiento. ¬øEn qu√© puedo ayudarle hoy?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"@lucia_marketing\"\n}\n\nEscenario 13: Channel::Telegram - Cliente nuevo\nCanal Detectado: {{ $('Data message extraction').item.json.channel }} = \"Channel::Telegram\"\nCliente: \"Hola, quiero informaci√≥n sobre sus bots.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"FALSE\",\n    \"Nada\": \"TRUE\",\n    \"respuesta\": \"Hola, bienvenido a your_brand, ¬øen qu√© puedo ayudarle? ¬øEs la primera vez que se comunica con nosotros?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\nCliente: \"S√≠, es la primera vez.\"\nAgente JSON:\njson{\n    \"crear\": \"TRUE\",\n    \"actualizar\": \"FALSE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"¬°Excelente! Me da gusto conocerle. En your_brand desarrollamos bots inteligentes, automatizaciones y sistemas de IA para negocios. ¬øDesea informaci√≥n sobre chatbots de atenci√≥n, ventas o automatizaci√≥n de procesos?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\n\nEscenario 14: Channel::Instagram - Cliente previo de Telegram\nCanal Detectado: {{ $('Data message extraction').item.json.channel }} = \"Channel::Instagram\"\nCliente: \"Hola, ya habl√© con ustedes por Telegram.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Entiendo, ya nos hab√≠a contactado por Telegram. Para ubicar su conversaci√≥n anterior, ¬øpodr√≠a compartirme su nombre de usuario de Telegram (por ejemplo @usuario)?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\nCliente: \"Mi usuario es @andresTech.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Perfecto Andr√©s, ya tengo su usuario de Telegram registrado. Revisar√© su conversaci√≥n anterior para continuar con su solicitud. ¬øEn qu√© puedo ayudarle hoy?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"@andresTech\"\n}\n\nEscenario 15: Channel::FacebookPage - Cliente previo de Telegram\nCanal Detectado: {{ $('Data message extraction').item.json.channel }} = \"Channel::FacebookPage\"\nCliente: \"Hola, ya habl√© con ustedes por Telegram.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Perfecto, ya nos hab√≠a contactado por Telegram. Para ubicar su conversaci√≥n previa, ¬øpodr√≠a compartirme su usuario de Telegram (por ejemplo @usuario)?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\nCliente: \"S√≠, es @cliente2025.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Excelente, ya tengo su usuario de Telegram registrado. Ahora puedo revisar su conversaci√≥n anterior. ¬øDesea continuar con el mismo tema o iniciar una nueva consulta?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"@cliente2025\"\n}\n\nEscenario 16: Channel::Whatsapp - Cliente previo de Telegram\nCanal Detectado: {{ $('Data message extraction').item.json.channel }} = \"Channel::Whatsapp\"\nCliente: \"Hola, ya les escrib√≠ por Telegram la semana pasada.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Perfecto, ya nos hab√≠a contactado por Telegram. Para ubicar su conversaci√≥n anterior, ¬øpodr√≠a compartirme su nombre de usuario de Telegram (por ejemplo @usuario)?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\nCliente: \"S√≠, es @lucia_marketing.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Excelente Lucia, ya tengo su perfil de Telegram registrado. Revisar√© su conversaci√≥n anterior para darle seguimiento. ¬øEn qu√© puedo ayudarle hoy?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"@lucia_marketing\"\n}\n\nEscenario 17: Channel::Telegram - Cliente previo de Facebook\nCanal Detectado: {{ $('Data message extraction').item.json.channel }} = \"Channel::Telegram\"\nCliente: \"Hola, ya les escrib√≠ por Facebook la semana pasada.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Perfecto, ya nos hab√≠a contactado por Facebook. Para ubicar su conversaci√≥n anterior, ¬øpodr√≠a compartirme su nombre de usuario o perfil de Facebook?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}\nCliente: \"S√≠, es lucia marketing.\"\nAgente JSON:\njson{\n    \"crear\": \"FALSE\",\n    \"actualizar\": \"TRUE\",\n    \"Nada\": \"FALSE\",\n    \"respuesta\": \"Excelente Lucia, ya tengo su perfil de Facebook registrado. Revisar√© su conversaci√≥n anterior para darle seguimiento. ¬øEn qu√© puedo ayudarle hoy?\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"lucia marketing\"\n}\n\n### CASOS ESPECIALES DE MANEJO\n\n**Informaci√≥n Incompleta:**\nSi el cliente no proporciona toda la informaci√≥n requerida, mantener Nada: \"TRUE\" y continuar solicitando los datos faltantes de manera cort√©s.\n\n**M√∫ltiples Canales Mencionados:**\nSi el cliente menciona haber contactado por m√∫ltiples canales, solicitar informaci√≥n del canal m√°s reciente o m√°s relevante seg√∫n la l√≥gica de validaci√≥n.\n\n**N√∫meros sin Pa√≠s Expl√≠cito:**\nSi el cliente proporciona n√∫mero sin mencionar pa√≠s, preguntar: \"¬øDe qu√© pa√≠s me est√° escribiendo para normalizar correctamente su n√∫mero?\"\n\n**Formatos de Perfil Variables:**\nAceptar diferentes formatos de perfiles de redes sociales:\n- @usuario\n- usuario\n- Facebook.com/usuario  \n- Nombre completo del perfil\n\n**Persistencia en Validaci√≥n:**\nMantener cortes√≠a pero ser persistente para obtener la informaci√≥n de validaci√≥n necesaria antes de proceder con el servicio."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        4704,
        2432
      ],
      "id": "c65999ab-5582-4b7b-92d8-0219244f67c6",
      "name": "agente_identificador"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Data message extraction').item.json.sessionId }}",
        "tableName": "conversaciones",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        4768,
        2656
      ],
      "id": "6f6a6ee3-7c96-48f1-930b-d40ed9a8d43b",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "your_credential_id",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        4640,
        2656
      ],
      "id": "e0c6b997-d2e3-412c-a63d-3920d596daa3",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "your_openai_credential_id",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE conversaciones \nSET session_id = '{{ $('extraer registro nuevo').item.json.client_id }}'\nWHERE session_id = '{{ $('Edit Fields2').item.json.sessionId }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        6128,
        1648
      ],
      "id": "91c2ef99-9072-4ac6-b319-6fa395ea8f74",
      "name": "actualizar session_id memoria de chat",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{ \"crear\": \"\", \"actualizar\": \"\", \"Nada\": \"\",\n    \"respuesta\": \"\",\n    \"telefono\": \"\",\n    \"perfil_red_social\": \"\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        4896,
        2656
      ],
      "id": "ec87a40a-0e31-44b4-9a05-288147b1f4a7",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9f70ef8f-6329-484b-8313-adbee947f654",
              "leftValue": "={{ $('agente_identificador').item.json.output.telefono }}",
              "rightValue": "=\"+\"",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "6b00e74f-f2a8-4924-9086-2fdd7659533a",
              "leftValue": "={{ $('agente_identificador').item.json.output.perfil_red_social }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5680,
        2352
      ],
      "id": "3374dd50-efce-478f-aa20-62833dc3c0a9",
      "name": "If1"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "leads_formularios_optimizada",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "nombre_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            },
            {
              "keyName": "telefono",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.telefono }}"
            },
            {
              "keyName": "messenger_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            },
            {
              "keyName": "instagram_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            },
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('Code').item.json.phone_number_normalized }}"
            },
            {
              "keyName": "nombre",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.sender_name }}"
            },
            {
              "keyName": "messenger",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.sender_name }}"
            },
            {
              "keyName": "instagram",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.sender_name }}"
            },
            {
              "keyName": "telegram",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.username_telegram }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5904,
        1648
      ],
      "id": "6972ca7c-073d-454a-8b41-90931857f704",
      "name": "extraer registro nuevo",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "your_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE conversaciones \nSET session_id = '{{ $('extraer registro actualizado').item.json.client_id }}'\nWHERE session_id = '{{ $('Edit Fields2').item.json.sessionId }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        6576,
        2240
      ],
      "id": "ef637ed1-cdba-41f0-871f-fb77debf02ed",
      "name": "actualizar session_id memoria de chat2",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        5904,
        2464
      ],
      "id": "fd39dfb6-91d1-459e-a44a-fdc18e5b2edd",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Data message extraction').item.json.channel }}",
                    "rightValue": "Channel::Whatsapp",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "4ca80a88-928c-4f64-9e50-f1b1996b90a6"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7d0e0e26-a14e-4483-92e0-a7e396cea05d",
                    "leftValue": "={{ $('Data message extraction').item.json.channel }}",
                    "rightValue": "Channel::FacebookPage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "FacebookPage"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "29f7a958-d582-4dc0-a22a-43bdb5dd9dbe",
                    "leftValue": "={{ $('Data message extraction').item.json.channel }}",
                    "rightValue": "Channel::Instagram",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0dda540b-cf93-4c3d-bd4e-6fad381fe2c8",
                    "leftValue": "={{ $('Data message extraction').item.json.channel }}",
                    "rightValue": "Channel::Telegram",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Telegram"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        5904,
        2112
      ],
      "id": "948cef21-1bf0-4e40-adf4-9674bca92887",
      "name": "Switch1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9376ea0c-a5fc-41c0-8dbc-254c4979d014",
              "leftValue": "={{ $('variables persistentes cliente').item.json.es_cliente }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6128,
        2944
      ],
      "id": "8e1d0ab9-412e-4f98-adf7-3187178812ac",
      "name": "validar comprador",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9376ea0c-a5fc-41c0-8dbc-254c4979d014",
              "leftValue": "={{ $('variables persistentes cliente').item.json.es_cliente }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6128,
        2608
      ],
      "id": "a3df4865-a755-48c5-a2d8-fcaa95adbe8e",
      "name": "validar comprador1",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('Data message extraction').item.json.accountId }}/conversations/{{ $('Data message extraction').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "=Lo sentimos el soporte es solo para clientes, si quiere puedo agendarle una cita."
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('Data message extraction').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('Data message extraction').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('Data message extraction').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6352,
        2800
      ],
      "id": "ae9ea3eb-6fcc-4d9d-b55f-28a80f7741d3",
      "name": "negar soporte",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('Data message extraction').item.json.accountId }}/conversations/{{ $('Data message extraction').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "=Lo sentimos la secci√≥n de quejas es solo para clientes, si quiere puedo agendarle una cita."
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('Data message extraction').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('Data message extraction').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('Data message extraction').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6352,
        2992
      ],
      "id": "32ef615e-e8ea-4c91-a275-40af89edf3d0",
      "name": "negar queja",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Obtener la respuesta del agente\nconst respuestaAgente = $input.first().json.output || $input.first().json.response || $input.first().json.text || '';\n\n// Palabras v√°lidas permitidas (actualizado con agente_humano)\nconst palabrasValidas = ['agente_humano', 'ventas', 'soporte', 'queja', 'indefinido'];\n\n// Limpiar y normalizar la respuesta\nlet respuestaLimpia = respuestaAgente\n  .toLowerCase()\n  .trim()\n  .replace(/[^a-z√°√©√≠√≥√∫√±_]/g, ''); // Mantiene gui√≥n bajo para agente_humano\n\n// Buscar si alguna palabra v√°lida est√° en la respuesta\nlet categoriaFinal = 'indefinido'; // Valor por defecto\n\nfor (const palabra of palabrasValidas) {\n  // Normalizar la palabra para comparaci√≥n (eliminar guiones bajos tambi√©n)\n  const palabraNormalizada = palabra.replace(/_/g, '');\n  const respuestaSinGuiones = respuestaLimpia.replace(/_/g, '');\n  \n  // Buscar coincidencia exacta primero (con gui√≥n bajo)\n  if (respuestaLimpia === palabra) {\n    categoriaFinal = palabra;\n    break;\n  }\n  // Buscar coincidencia sin guiones (agentehumano = agente_humano)\n  if (respuestaSinGuiones.includes(palabraNormalizada)) {\n    categoriaFinal = palabra;\n    break;\n  }\n}\n\n// Retornar solo la palabra v√°lida\nreturn {\n  json: {\n    categoria: categoriaFinal,\n    respuesta_original: respuestaAgente\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5680,
        1072
      ],
      "id": "db4949f9-bac9-4c41-b13e-6f2e277e4e9c",
      "name": "parsear respuesta agente"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('Data message extraction').item.json.accountId }}/conversations/{{ $('Data message extraction').item.json.conversationId }}/labels",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "labels",
              "value": "={{ Array('nuevo_lead') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6352,
        1840
      ],
      "id": "b191e24c-8c02-4518-b5f5-591b8571f9a0",
      "name": "etiqueta nuevo lead",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('Data message extraction').item.json.accountId }}/conversations/{{ $('Data message extraction').item.json.conversationId }}/labels",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "labels",
              "value": "={{ Array('identificado') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6800,
        2240
      ],
      "id": "9d6982e3-dfeb-4bd0-9744-d9fade99bd97",
      "name": "etiqueta cliente identificado",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT *\nFROM citas\nWHERE client_id = '{{ $json.client_id }}'\nORDER BY fecha_cita_timezone_cliente DESC\nLIMIT 1;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3392,
        1952
      ],
      "id": "582c767b-6845-4c42-ba2a-7656222ad005",
      "name": "obtener_citas",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c70cd167-b2fd-4d7f-ba75-312caf97704f",
              "name": "client_id",
              "value": "={{ $('Get many rows').item.json.client_id }}",
              "type": "string"
            },
            {
              "id": "a842390b-4153-485c-bd85-4f9650883de1",
              "name": "concat_message",
              "value": "={{ $('Edit Fields2').item.json.concat_message }}",
              "type": "string"
            },
            {
              "id": "bf6537db-58ae-4063-bab2-647dc071ad0d",
              "name": "telefono",
              "value": "={{ $('Get many rows').item.json.telefono }}\n",
              "type": "string"
            },
            {
              "id": "9120aa52-9c10-467b-8f9d-50ac37e16ea0",
              "name": "nombre",
              "value": "={{ $('Get many rows').item.json.nombre ?? $('obtener_citas').item.json.nombre}}",
              "type": "string"
            },
            {
              "id": "eeaaeea4-a922-49ae-8b3d-a40738c64d77",
              "name": "email",
              "value": "={{ $('Get many rows').item.json.email }}",
              "type": "string"
            },
            {
              "id": "1ccca01b-d27f-425b-bad2-f536e863ba27",
              "name": "nombre_normalizado",
              "value": "={{ $('Get many rows').item.json.nombre_normalizado }}",
              "type": "string"
            },
            {
              "id": "eb2d32d4-035c-4488-aaba-774560e516c7",
              "name": "es_cliente",
              "value": "={{ $('Get many rows').item.json.es_cliente }}",
              "type": "string"
            },
            {
              "id": "16a8513b-88b1-488b-b450-a010c0d9e3ca",
              "name": "fecha_creado",
              "value": "={{ $('Get many rows').item.json.fecha_creado }}",
              "type": "string"
            },
            {
              "id": "e47d424f-47d1-46c6-9a49-418c87699d72",
              "name": "pais",
              "value": "={{ $('Get many rows').item.json.pais ?? $('obtener_citas').item.json.pais}}",
              "type": "string"
            },
            {
              "id": "706b0922-56f3-4254-8108-ae5ee56378a8",
              "name": "estado_cita",
              "value": "={{ $('obtener_citas').item.json.estado }}\n\n",
              "type": "string"
            },
            {
              "id": "353c0f28-6629-44ad-8124-bce0544c41ac",
              "name": "fecha_cita",
              "value": "={{ $('obtener_citas').item.json.fecha_cita }}",
              "type": "string"
            },
            {
              "id": "0015cad1-5678-468b-851a-674ebcef0f1e",
              "name": "enlace_reunion",
              "value": "={{ $('obtener_citas').item.json.enlace_reunion }}",
              "type": "string"
            },
            {
              "id": "452bccdf-ac61-4faa-8417-a9c26fd5d7da",
              "name": "fecha_cita_timezone_cliente",
              "value": "={{ $('obtener_citas').item.json.fecha_cita_timezone_cliente }}",
              "type": "string"
            },
            {
              "id": "1cfbb988-38a7-4672-9cf8-3993d81ec82f",
              "name": "asistencia",
              "value": "={{ $('obtener_citas').item.json.asistencia}}",
              "type": "string"
            },
            {
              "id": "b9d8b0da-7030-47e0-9732-4e96815a3f67",
              "name": "empresa",
              "value": "={{ $('Get many rows').item.json.empresa ?? $('obtener_citas').item.json.empresa}}",
              "type": "string"
            },
            {
              "id": "264fbb34-23b3-4d79-bc39-661d49a882f5",
              "name": "servicio",
              "value": "={{ $('obtener_citas').item.json.servicio ?? $('Get many rows').item.json.servicio}}",
              "type": "string"
            },
            {
              "id": "4afd1276-241a-4b50-9a0c-c07e531cc75d",
              "name": "cita_pasada",
              "value": "={{ $('obtener_citas').item.json.cita_pasada }}",
              "type": "string"
            },
            {
              "id": "e4ad595e-c1d7-4a2e-aa88-61688d6194e1",
              "name": "score_lead",
              "value": "={{ $('Get many rows').item.json.score_lead }}",
              "type": "string"
            },
            {
              "id": "579a9579-3fd2-43ca-8560-0de0ec786940",
              "name": "agente",
              "value": "={{ $('Data message extraction').item.json.agente }}",
              "type": "string"
            },
            {
              "id": "8b8f1a4a-4ce0-46cb-a713-0dc45ab0b48f",
              "name": "fecha_cita_timezone_legible",
              "value": "={{ $('obtener_citas').item.json.fecha_cita_timezone_legible }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4768,
        1072
      ],
      "id": "57e9eb81-ac87-4991-818d-7d6fbef01488",
      "name": "variables persistentes cliente",
      "alwaysOutputData": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('Data message extraction').item.json.accountId }}/conversations/{{ $('Data message extraction').item.json.conversationId }}/assignments\n\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"assignee_id\": 7\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6576,
        1648
      ],
      "id": "9fcaedad-abd7-431f-98ca-a1d85d6de3c9",
      "name": "asignar conversacion a agente humano",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('Data message extraction').item.json.accountId }}/agents",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6352,
        1648
      ],
      "id": "9dc4a8b3-ae43-44d4-a564-a14ffa539891",
      "name": "obtener id de agentes",
      "credentials": {
        "httpHeaderAuth": {
          "id": "your_chatwoot_credential_id",
          "name": "chatwoot"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT json_build_object(\n  'historial_conversaciones', \n  string_agg(\n    conversacion_formateada,\n    E'\\n\\n'\n  )\n) as resultado\nFROM (\n  SELECT \n    '#' || id || ' [' || (message->>'type') || '] ' || \n    COALESCE(\n      CASE \n        WHEN message->'content'->'respuesta' IS NOT NULL \n        THEN message->'content'->>'respuesta'\n        ELSE \n          CASE \n            WHEN (message->>'content')::text ~ '^\\s*\\{' \n            THEN \n              COALESCE(\n                ((message->>'content')::jsonb)->>'respuesta',\n                message->>'content'\n              )\n            ELSE message->>'content'\n          END\n      END,\n      'Sin contenido'\n    ) ||\n    CASE \n      WHEN etiqueta IS NOT NULL AND etiqueta != '' \n      THEN ' | Etiqueta: ' || etiqueta\n      ELSE ''\n    END as conversacion_formateada\n  FROM conversaciones\n  WHERE session_id = '{{ $('variables persistentes cliente').item.json.client_id }}'\n  ORDER BY id DESC\n  LIMIT 10\n) subquery;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        5104,
        1072
      ],
      "id": "28ea4a4e-1097-4b0d-8c3c-e4a6f74b7a7e",
      "name": "extraer_etiqueta_anterior",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1a586314-5928-4b62-bff6-7c784ac43200",
              "name": "sender",
              "value": "={{ $json.body.messages[0].sender_id }}",
              "type": "string"
            },
            {
              "id": "96227c45-6870-459d-90c9-76ce28cd56c5",
              "name": "accountId",
              "value": "={{ $json.body.messages[0].account_id }}",
              "type": "string"
            },
            {
              "id": "2296800b-5382-4b4f-ac45-cfb4eef98753",
              "name": "sessionId",
              "value": "={{ $json.body.messages[0].conversation_id }}",
              "type": "string"
            },
            {
              "id": "9a03752f-dca9-4cc7-ab54-272156ccd62e",
              "name": "content_type",
              "value": "={{ $json.body.messages[0].content_type }}",
              "type": "string"
            },
            {
              "id": "c259b839-bb24-457e-93fa-7020c5b1d7de",
              "name": "voice_message_type",
              "value": "={{ $json.body.messages[0].attachments[0].file_type }}",
              "type": "string"
            },
            {
              "id": "06954d6a-a252-4848-a533-654dfdc19903",
              "name": "voice_message_url",
              "value": "={{ $json.body.messages[0].attachments[0].data_url }}",
              "type": "string"
            },
            {
              "id": "c186b8dc-11f7-4417-996a-6abd2a80d3b0",
              "name": "text_message",
              "value": "={{ $json.body.messages[0].content }}",
              "type": "string"
            },
            {
              "id": "4121e376-2460-4dcd-9586-0a763db038d2",
              "name": "data_time",
              "value": "={{ $json.body.timestamp.toDateTime('s').toLocal() }}",
              "type": "string"
            },
            {
              "id": "f69184fa-fbe4-47d2-981b-58df4a294f59",
              "name": "private",
              "value": "={{ $json.body.messages[0].private }}",
              "type": "string"
            },
            {
              "id": "f8d4e2ab-f6f5-4b0a-b2e3-d80df515643b",
              "name": "content_attributes",
              "value": "={{ $json.body.messages[0].content_attributes }}",
              "type": "string"
            },
            {
              "id": "c48454c2-e580-4edd-b162-3abb0f482f7b",
              "name": "conversationId",
              "value": "={{ $json.body.messages[0].conversation_id }}",
              "type": "string"
            },
            {
              "id": "0f4b0104-58cb-431f-a8c4-35825d787d55",
              "name": "sender_name",
              "value": "={{ $json.body.meta.sender.name }}",
              "type": "string"
            },
            {
              "id": "8c1ac62c-c1b6-4b18-9f44-37e8cbe8d367",
              "name": "inbox_id",
              "value": "={{ $json.body.inbox_id }}",
              "type": "string"
            },
            {
              "id": "6b1f496c-5f93-4b3c-918a-9274f7bf2078",
              "name": "channel",
              "value": "={{ $json.body.channel }}",
              "type": "string"
            },
            {
              "id": "dd9215f9-4cdd-4a9b-800c-d84d3577f01e",
              "name": "phone_number",
              "value": "={{ $json.body.meta.sender.phone_number }}",
              "type": "string"
            },
            {
              "id": "b9412e9e-6c50-4a66-9c8d-ad7806974e4b",
              "name": "fecha_UTC",
              "value": "={{ $json.body.timestamp.toDateTime('s').toUTC()  }}",
              "type": "string"
            },
            {
              "id": "3c780d3d-cb73-41ef-89f6-3afb08da0abf",
              "name": "nombre_normalizado",
              "value": "={{ $json.body.meta.sender.name.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase() }}",
              "type": "string"
            },
            {
              "id": "ffba6980-26f7-4f17-8b4f-8bf9e8a9dbfd",
              "name": "agente",
              "value": "={{ $json.body.meta.assignee.name }}",
              "type": "string"
            },
            {
              "id": "3f0c1605-b6be-4197-9bbc-313dbc06f01a",
              "name": "contact_id",
              "value": "={{ $json.body.contact_inbox.contact_id }}",
              "type": "number"
            },
            {
              "id": "bb7f20cc-e8b2-4b2f-bb87-04b0f8bc9178",
              "name": "etiqueta",
              "value": "={{ $json.body.labels[0] }}",
              "type": "string"
            },
            {
              "id": "634fb0d2-c44f-469b-859f-c6e91bb168a5",
              "name": "username_telegram",
              "value": "={{ $json.body.messages[0].sender.additional_attributes.username }}",
              "type": "string"
            },
            {
              "id": "f3d41afb-eca3-4d2b-95af-78464654fb73",
              "name": "fecha_queja",
              "value": "={{ new Date().toLocaleString() }}",
              "type": "string"
            },
            {
              "id": "86eaad1d-71fa-405f-aa5e-629be1b490ca",
              "name": "message_type",
              "value": "={{ $json.body.messages[0].message_type }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        704,
        2080
      ],
      "id": "7dba53f6-1a19-4e47-a5d4-8f035730ca89",
      "name": "Data message extraction"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT *\nFROM leads_formularios_optimizada\nWHERE \n  nombre_normalizado = '{{ $('Data message extraction').item.json.nombre_normalizado }}'\n  OR telefono = '{{ $('Code').item.json.phone_number_normalized }}'\n  OR messenger = '{{ $('Data message extraction').item.json.sender_name }}'\n  OR instagram = '{{ $('Data message extraction').item.json.sender_name }}'\n  OR whatsapp = '{{ $('Code').item.json.phone_number_normalized }}'\n  OR nombre = '{{ $('Data message extraction').item.json.sender_name }}'\n  OR messenger_normalizado = '{{ $('Data message extraction').item.json.nombre_normalizado }}'\n  OR instagram_normalizado = '{{ $('Data message extraction').item.json.nombre_normalizado }}'\n  OR telegram = '{{ $('Data message extraction').item.json.username_telegram }}'\n  OR telegram_normalizado = '{{ $('Data message extraction').item.json.username_telegram.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase() }}'\nORDER BY created_at DESC\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3168,
        1952
      ],
      "id": "39d6bee8-8c61-4d1d-b5c5-7b29ecb28de7",
      "name": "Get many rows",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "leads_formularios_optimizada",
        "filters": {
          "conditions": [
            {
              "keyName": "telefono",
              "condition": "eq",
              "keyValue": "={{ $('Code').item.json.phone_number_normalized }}"
            },
            {
              "keyName": "messenger",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social }}"
            },
            {
              "keyName": "instagram",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social }}"
            },
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('Code').item.json.phone_number_normalized }}"
            },
            {
              "keyName": "nombre",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social }}"
            },
            {
              "keyName": "nombre_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase()  }}"
            },
            {
              "keyName": "messenger_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase()  }}"
            },
            {
              "keyName": "instagram_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase()  }}"
            },
            {
              "keyName": "telegram",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social }}"
            },
            {
              "keyName": "telegram_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase()  }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $('Data message extraction').item.json.channel === 'Channel::Whatsapp'      ? $('Code').item.json.phone_number_normalized      : '' }}"
            },
            {
              "fieldId": "identificado",
              "fieldValue": "TRUE"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        6128,
        1840
      ],
      "id": "6237fc3a-36d9-4f03-8743-cc35f48f0938",
      "name": "actualizar registro existente",
      "credentials": {
        "supabaseApi": {
          "id": "your_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "leads_formularios_optimizada",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "nombre",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social != null ? $('agente_identificador').item.json.output.perfil_red_social : $('Data message extraction').item.json.sender_name  }}"
            },
            {
              "keyName": "telefono",
              "condition": "eq",
              "keyValue": "={{ $('Code').item.json.phone_number_normalized != null ? $('Code').item.json.phone_number_normalized : $('agente_identificador').item.json.output.telefono }}"
            },
            {
              "keyName": "messenger",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social != null ? $('agente_identificador').item.json.output.perfil_red_social : $('Data message extraction').item.json.sender_name  }}"
            },
            {
              "keyName": "instagram",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social != null ? $('agente_identificador').item.json.output.perfil_red_social : $('Data message extraction').item.json.sender_name  }}"
            },
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.telefono != null ? $('agente_identificador').item.json.output.telefono : $('Code').item.json.phone_number_normalized }}"
            },
            {
              "keyName": "nombre_normalizado",
              "condition": "eq",
              "keyValue": "=\n{{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase() != null ? $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase() : $('Data message extraction').item.json.nombre_normalizado  }}"
            },
            {
              "keyName": "messenger_normalizado",
              "condition": "eq",
              "keyValue": "=\n{{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase() != null ? $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase() : $('Data message extraction').item.json.nombre_normalizado  }}"
            },
            {
              "keyName": "instagram_normalizado",
              "condition": "eq",
              "keyValue": "=\n{{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase() != null ? $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase() : $('Data message extraction').item.json.nombre_normalizado  }}"
            },
            {
              "keyName": "telegram",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.username_telegram }}"
            },
            {
              "keyName": "telegram_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.username_telegram.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        6352,
        2240
      ],
      "id": "acd38887-bfd7-4977-a9bd-41325153ec48",
      "name": "extraer registro actualizado",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "your_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "leads_formularios_optimizada",
        "filters": {
          "conditions": [
            {
              "keyName": "telefono",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.telefono }}"
            },
            {
              "keyName": "messenger",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.sender_name }}"
            },
            {
              "keyName": "instagram",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social }}"
            },
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.telefono }}"
            },
            {
              "keyName": "nombre",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.sender_name }}"
            },
            {
              "keyName": "nombre_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            },
            {
              "keyName": "messenger_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            },
            {
              "keyName": "instagram_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase()  }}"
            },
            {
              "keyName": "telegram",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social }}"
            },
            {
              "keyName": "telegram_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase()  }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "messenger",
              "fieldValue": "={{ $('Data message extraction').item.json.channel === 'Channel::FacebookPage'      ? $('Data message extraction').item.json.sender_name      : '' }}"
            },
            {
              "fieldId": "identificado",
              "fieldValue": "TRUE"
            },
            {
              "fieldId": "messenger_normalizado",
              "fieldValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        6128,
        2032
      ],
      "id": "b0cb57b4-35ad-4b57-a1e4-8c5e11e894e0",
      "name": "actualizar registro existente1",
      "credentials": {
        "supabaseApi": {
          "id": "your_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "leads_formularios_optimizada",
        "filters": {
          "conditions": [
            {
              "keyName": "telefono",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.telefono }}"
            },
            {
              "keyName": "messenger",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social }}"
            },
            {
              "keyName": "instagram",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.sender_name }}"
            },
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.telefono }}"
            },
            {
              "keyName": "nombre",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.sender_name }}"
            },
            {
              "keyName": "messenger_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase()  }}"
            },
            {
              "keyName": "instagram_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            },
            {
              "keyName": "nombre_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            },
            {
              "keyName": "telegram",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social }}"
            },
            {
              "keyName": "telegram_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase()  }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "instagram",
              "fieldValue": "={{ $('Data message extraction').item.json.channel === 'Channel::Instagram' \n    ? $('Data message extraction').item.json.sender_name \n    : '' }}\n"
            },
            {
              "fieldId": "identificado",
              "fieldValue": "TRUE"
            },
            {
              "fieldId": "instagram_normalizado",
              "fieldValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        6128,
        2224
      ],
      "id": "b34b5a60-b287-48b2-b32f-840e8c00bbb4",
      "name": "actualizar registro existente2",
      "credentials": {
        "supabaseApi": {
          "id": "your_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "leads_formularios_optimizada",
        "filters": {
          "conditions": [
            {
              "keyName": "telefono",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.telefono }}"
            },
            {
              "keyName": "messenger",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social }}"
            },
            {
              "keyName": "instagram",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social }}"
            },
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.telefono }}"
            },
            {
              "keyName": "nombre",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.sender_name }}"
            },
            {
              "keyName": "messenger_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase()  }}"
            },
            {
              "keyName": "instagram_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('agente_identificador').item.json.output.perfil_red_social.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase()  }}"
            },
            {
              "keyName": "nombre_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.nombre_normalizado }}"
            },
            {
              "keyName": "telegram",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.username_telegram }}"
            },
            {
              "keyName": "telegram_normalizado",
              "condition": "eq",
              "keyValue": "={{ $('Data message extraction').item.json.username_telegram.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase() }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "telegram",
              "fieldValue": "={{ $('Data message extraction').item.json.channel === 'Channel::Telegram' \n    ? $('Data message extraction').item.json.username_telegram\n    : '' }}\n"
            },
            {
              "fieldId": "identificado",
              "fieldValue": "TRUE"
            },
            {
              "fieldId": "telegram_normalizado",
              "fieldValue": "={{ $('Data message extraction').item.json.channel === 'Channel::Telegram'      ? $('Data message extraction').item.json.username_telegram.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/[^a-zA-Z√±√ë]/g, '').toLowerCase()     : '' }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        6128,
        2416
      ],
      "id": "a00bb9d3-5a3a-4235-be8e-f0ad3bc3b1c6",
      "name": "actualizar registro existente3",
      "credentials": {
        "supabaseApi": {
          "id": "your_credential_id",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT json_build_object(\n  'historial_conversaciones', \n  string_agg(\n    conversacion_formateada,\n    E'\\n\\n'\n  )\n) as resultado\nFROM (\n  SELECT \n    '#' || id || ' [' || (message->>'type') || '] ' || \n    COALESCE(\n      CASE \n        -- Si content es un objeto JSON con campo 'respuesta', extraerlo\n        WHEN jsonb_typeof(message->'content') = 'object' AND message->'content' ? 'respuesta' \n        THEN (message->'content')->>'respuesta'\n        \n        -- Si content es un string JSON, intentar parsearlo\n        WHEN jsonb_typeof(message->'content') = 'string' AND (message->>'content')::text LIKE '{%'\n        THEN (message->>'content')::jsonb->>'respuesta'\n        \n        -- Si no, devolver el contenido tal cual\n        ELSE message->>'content'\n      END,\n      'Sin contenido'\n    ) ||\n    CASE \n      WHEN clasificacion_cita IS NOT NULL AND clasificacion_cita != '' \n      THEN ' | Clasificaci√≥n: ' || clasificacion_cita\n      ELSE ''\n    END as conversacion_formateada\n  FROM conversaciones\n  WHERE session_id = COALESCE(\n    NULLIF(TRIM('{{ $('Get many rows').item.json.client_id }}'), ''),\n    '{{ $('Data message extraction').item.json.sessionId }}'\n  )\n  ORDER BY id DESC\n  LIMIT 10\n) subquery;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3616,
        1952
      ],
      "id": "1bd19f81-015c-4b68-b817-5230dcb08ff6",
      "name": "extraer_clasificacion_anterior",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "your_credential_id",
          "name": "Postgres account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Edit Fields2').item.json.concat_message }}",
        "options": {
          "systemMessage": "=# Prompt: Agente de Filtro de Conversaci√≥n (Versi√≥n 3.0 - Ultra Conservador)\n\nEres un agente de filtro inteligente para una Agencia de Marketing Digital e Inteligencia Artificial. Tu funci√≥n es analizar cada mensaje del cliente y determinar si debe ser procesado o ignorado.\n\n## CONTEXTO DE LA CONVERSACI√ìN\n\n**Historial de conversaci√≥n (√∫ltimos 10 mensajes):**\n{{ $('extraer_clasificacion_anterior').item.json.resultado.historial_conversaciones || 'Sin historial previo' }}\n\n**Tiempo desde √∫ltimo mensaje del cliente:**\n[INSERTA TIEMPO TRANSCURRIDO - en minutos]\n\n**Mensaje actual del cliente:**\n[INSERTA AQU√ç EL MENSAJE DEL CLIENTE]\n\n---\n\n## PRINCIPIO FUNDAMENTAL\n\nüéØ **FILOSOF√çA DEL FILTRO:** \"Mejor procesar 100 mensajes innecesarios que ignorar 1 mensaje importante\"\n\n‚ö†Ô∏è **REGLA ABSOLUTA:** Si tienes CUALQUIER duda, responde \"PROCESAR\"\n\n---\n\n## CRITERIOS PARA IGNORAR (EXTREMADAMENTE RESTRICTIVOS)\n\nSolo existen **DOS** escenarios donde puedes responder \"IGNORAR\":\n\n### ESCENARIO 1: Despedida Definitiva Confirmada\n\nDebes cumplir **TODAS** estas 6 condiciones simult√°neamente:\n\n1. ‚úÖ El √∫ltimo mensaje del CLIENTE fue una despedida clara:\n   - \"gracias adi√≥s\", \"hasta luego\", \"nos vemos\", \"bye\", \"chao\"\n   - Y el agente YA respondi√≥ confirmando la despedida\n\n2. ‚úÖ El mensaje actual es **√öNICAMENTE** una de estas palabras (sin nada m√°s):\n   - \"ok\" / \"okay\" / \"vale\" / \"entendido\" / \"üëç\" / \"gracias\" / \"perfecto\"\n\n3. ‚úÖ Han pasado **MENOS de 30 minutos** desde la despedida\n\n4. ‚úÖ El mensaje NO contiene ninguna de estas se√±ales de continuaci√≥n:\n   - Palabras: \"pero\", \"aunque\", \"sin embargo\", \"otra\", \"m√°s\", \"tambi√©n\", \"adem√°s\"\n   - Palabras interrogativas: \"cu√°ndo\", \"c√≥mo\", \"d√≥nde\", \"qui√©n\", \"qu√©\", \"por qu√©\"\n   - Signos de interrogaci√≥n: \"?\"\n   - N√∫meros de contacto o emails\n   - Referencias a servicios o precios\n\n5. ‚úÖ NO hay solicitudes pendientes del agente sin responder\n\n6. ‚úÖ El mensaje NO es un saludo de reactivaci√≥n:\n   - NO es \"hola\", \"buenos d√≠as\", \"buenas tardes\", \"hey\", \"qu√© tal\"\n   - NO es \"hola de nuevo\", \"retomo\", \"sigo aqu√≠\"\n\n**Ejemplo √öNICO v√°lido para IGNORAR:**\n```\n#100 [human] \"Gracias por todo, hasta luego\"\n#101 [ai] \"¬°Que tengas buen d√≠a! Hasta pronto\"\n[Pasan 10 minutos]\n#102 [human] \"ok\"\n‚Üí IGNORAR\n```\n\n### ESCENARIO 2: Spam Evidente e Irrelevante\n\nEl mensaje debe cumplir **AMBAS** condiciones:\n\n1. ‚úÖ NO tiene NINGUNA relaci√≥n con servicios digitales:\n   - Marketing, IA, desarrollo web, chatbots, tecnolog√≠a, consultor√≠a\n   - Automatizaci√≥n, apps, bases de datos, e-commerce\n   - SEO, publicidad digital, redes sociales, hosting\n\n2. ‚úÖ ES claramente spam comercial no relacionado:\n   - Venta de productos f√≠sicos: comida, ropa, construcci√≥n, servicios locales\n   - Cadenas, estafas, contenido ofensivo\n   - Publicidad masiva gen√©rica\n   - Texto aleatorio sin sentido\n\n**Ejemplos v√°lidos para IGNORAR:**\n- \"Vendo tacos al pastor üåÆ 3x2 en Polanco\"\n- \"Plomero 24hrs - Destapamos ca√±er√≠as\"\n- \"üí∞üí∞ GANA $10,000 USD DIARIOS DESDE CASA üí∞üí∞\"\n- \"asdfghjkl√±\" (texto sin sentido)\n\n---\n\n## CRITERIOS PARA PROCESAR (99% DE LOS CASOS)\n\n### üö® PROCESAMIENTO AUTOM√ÅTICO OBLIGATORIO\n\nResponde **PROCESAR** inmediatamente si el mensaje contiene:\n\n#### 1. Cualquier saludo o reactivaci√≥n\n- \"hola\", \"hey\", \"buenos d√≠as\", \"buenas tardes\", \"qu√© tal\", \"buenas\"\n- \"hola de nuevo\", \"retomo\", \"sigo\", \"vuelvo\"\n- **INCLUSO SI** el cliente se despidi√≥ antes\n\n#### 2. Signos de interrogaci√≥n (?)\n- Cualquier mensaje con \"?\" es una pregunta ‚Üí PROCESAR\n- No importa el contexto previo\n\n#### 3. Intenci√≥n comercial expl√≠cita\n- Palabras: \"cu√°nto\", \"precio\", \"costo\", \"cotizaci√≥n\", \"presupuesto\"\n- Verbos: \"quiero\", \"necesito\", \"busco\", \"me interesa\", \"requiero\"\n- Preguntas: \"¬øhacen...?\", \"¬øofrecen...?\", \"¬øpueden...?\"\n\n#### 4. Servicios o temas relevantes mencionados\n- Palabras: \"cita\", \"agendar\", \"reuni√≥n\", \"demo\", \"presentaci√≥n\"\n- Servicios: \"chatbot\", \"p√°gina web\", \"app\", \"IA\", \"marketing\", \"SEO\"\n- Tecnolog√≠a: \"sistema\", \"software\", \"automatizaci√≥n\", \"base de datos\"\n\n#### 5. Informaci√≥n de contacto o datos\n- N√∫meros de tel√©fono\n- Correos electr√≥nicos\n- Nombres de empresas\n- URLs o enlaces\n- Horarios o fechas\n\n#### 6. Emociones o urgencia\n- Negativas: \"molesto\", \"frustrado\", \"enojado\", \"decepcionado\"\n- Urgentes: \"urgente\", \"r√°pido\", \"ya\", \"inmediato\", \"ASAP\"\n- Problemas: \"no funciona\", \"error\", \"ayuda\", \"problema\"\n\n#### 7. Continuaci√≥n de conversaci√≥n\n- Respuestas a preguntas del agente\n- Follow-ups: \"y eso?\", \"entonces?\", \"ok, y?\"\n- Referencias: \"sobre lo que hablamos\", \"como dec√≠as\"\n\n#### 8. Mensajes ambiguos o poco claros\n- Si NO entiendes el mensaje ‚Üí PROCESAR\n- Si podr√≠a tener doble significado ‚Üí PROCESAR\n- Solo emojis sin contexto ‚Üí PROCESAR\n\n---\n\n## CASOS ESPECIALES QUE SIEMPRE SE PROCESAN\n\n### ‚úÖ Reactivaci√≥n despu√©s de despedida\n```\nCliente se despidi√≥ ‚Üí Pasan horas/d√≠as ‚Üí Cliente escribe de nuevo\n‚Üí SIEMPRE PROCESAR (no importa cu√°nto tiempo pas√≥)\n```\n\n### ‚úÖ Mensajes cortos en contexto activo\nSi hay conversaci√≥n en las √∫ltimas 24 horas:\n- \"s√≠\", \"no\", \"claro\", \"dale\" ‚Üí PROCESAR\n- N√∫meros: \"3pm\", \"ma√±ana\", \"100\" ‚Üí PROCESAR\n- Confirmaciones breves ‚Üí PROCESAR\n\n### ‚úÖ Primer mensaje del cliente\n- Sin importar el contenido ‚Üí PROCESAR\n- Establece el primer contacto\n\n### ‚úÖ Respuestas incorrectas o typos\n- \"Hola Quisier aagendar\" ‚Üí PROCESAR (tiene intenci√≥n clara)\n- Errores de ortograf√≠a no invalidan el mensaje\n\n---\n\n## AN√ÅLISIS DEL HISTORIAL\n\nAntes de decidir, revisa el historial buscando:\n\n1. **¬øHubo despedida mutua?**\n   - Cliente dijo adi√≥s + Agente confirm√≥ ‚Üí Marcar como \"despedida confirmada\"\n\n2. **¬øCu√°nto tiempo pas√≥ desde la despedida?**\n   - Menos de 30 min ‚Üí Podr√≠a ignorarse SI cumple todos los criterios\n   - M√°s de 30 min ‚Üí PROCESAR cualquier mensaje nuevo\n\n3. **¬øEl mensaje actual es reactivaci√≥n?**\n   - Si contiene saludo o nueva solicitud ‚Üí PROCESAR (ignora despedida previa)\n\n4. **¬øHay preguntas pendientes del agente?**\n   - Si el agente pregunt√≥ algo sin respuesta ‚Üí PROCESAR respuesta del cliente\n\n---\n\n## CHECKLIST DE VALIDACI√ìN\n\nAntes de decidir \"IGNORAR\", verifica que respondiste NO a TODAS estas preguntas:\n\n- [ ] ¬øEl mensaje contiene \"hola\" o alg√∫n saludo? ‚Üí NO\n- [ ] ¬øTiene signos de interrogaci√≥n (?)? ‚Üí NO\n- [ ] ¬øMenciona servicios, precios o citas? ‚Üí NO\n- [ ] ¬øContiene datos de contacto? ‚Üí NO\n- [ ] ¬øExpresa emoci√≥n o urgencia? ‚Üí NO\n- [ ] ¬øPasaron m√°s de 30 minutos desde la despedida? ‚Üí NO\n- [ ] ¬øEl mensaje tiene m√°s de 2 palabras? ‚Üí NO\n- [ ] ¬øTengo alguna duda sobre ignorarlo? ‚Üí NO\n- [ ] ¬øPodr√≠a ser importante para el negocio? ‚Üí NO\n- [ ] ¬øEl cliente podr√≠a estar respondiendo algo? ‚Üí NO\n\n**Si respondiste S√ç a cualquiera ‚Üí PROCESAR**\n\n**Solo si respondiste NO a todas ‚Üí Considera IGNORAR** (y vuelve a verificar)\n\n---\n\n## FORMATO DE RESPUESTA\n\nResponde con UNA sola palabra, sin explicaciones:\n\n**PROCESAR** o **IGNORAR**\n\n---\n\n## EJEMPLOS PR√ÅCTICOS\n\n### ‚úÖ PROCESAR - Reactivaci√≥n despu√©s de despedida\n```\n#2443 [human] \"Gracias adios\"\n#2444 [ai] \"¬°Hasta luego!\"\n[Pasan 3 horas]\n#2447 [human] \"Hola Quisier aagendar otra cita\"\n‚Üí PROCESAR (nuevo saludo + solicitud)\n```\n\n### ‚úÖ PROCESAR - Saludo simple\n```\nHistorial: Sin mensajes previos\nMensaje: \"Hola\"\n‚Üí PROCESAR (primer contacto)\n```\n\n### ‚úÖ PROCESAR - Pregunta adicional\n```\nHistorial: Conversaci√≥n sobre precios\nMensaje: \"¬øtambi√©n hacen apps m√≥viles?\"\n‚Üí PROCESAR (pregunta con ?)\n```\n\n### ‚úÖ PROCESAR - Mensaje corto con intenci√≥n\n```\nHistorial: Agente pregunt√≥ horario preferido\nMensaje: \"3 pm\"\n‚Üí PROCESAR (responde pregunta)\n```\n\n### ‚úÖ PROCESAR - Despedida con posible seguimiento\n```\nHistorial: Conversaci√≥n sobre IA\nMensaje: \"Gracias por la info, lo voy a pensar\"\n‚Üí PROCESAR (podr√≠a tener preguntas despu√©s)\n```\n\n### ‚úÖ PROCESAR - Reactivaci√≥n tard√≠a\n```\nHistorial: Cliente se despidi√≥ hace 2 d√≠as\nMensaje: \"Hola de nuevo\"\n‚Üí PROCESAR (reactivaci√≥n expl√≠cita)\n```\n\n### ‚õî IGNORAR - Despedida confirmada reciente\n```\n#100 [human] \"Perfecto, gracias por todo. Hasta luego\"\n#101 [ai] \"¬°Que tengas excelente d√≠a!\"\n[Pasan 5 minutos]\n#102 [human] \"ok\"\n‚Üí IGNORAR (cumple los 6 criterios)\n```\n\n### ‚õî IGNORAR - Spam evidente\n```\nHistorial: Sin mensajes previos\nMensaje: \"Vendo pizzas 2x1 üçïüçïüçï\"\n‚Üí IGNORAR (publicidad no relacionada)\n```\n\n### ‚úÖ PROCESAR - Despedida con \"pero\"\n```\nHistorial: \"Gracias, adi√≥s\" (hace 1 hora)\nMensaje: \"Pero una pregunta...\"\n‚Üí PROCESAR (\"pero\" indica continuaci√≥n)\n```\n\n### ‚úÖ PROCESAR - Confirmaci√≥n ambigua\n```\nHistorial: Conversaci√≥n activa sobre chatbots\nMensaje: \"ok\"\n‚Üí PROCESAR (contexto activo, no hay despedida previa)\n```\n\n### ‚úÖ PROCESAR - Mensaje con typos pero intenci√≥n clara\n```\nMensaje: \"ola nesesito unna pajina web\"\n‚Üí PROCESAR (errores ortogr√°ficos, pero intenci√≥n clara)\n```\n\n---\n\n## REGLAS FINALES INQUEBRANTABLES\n\n1. **Principio de precauci√≥n:** Ante la m√≠nima duda ‚Üí PROCESAR\n\n2. **Ventana de 30 minutos:** Despedidas mayores a 30 min son obsoletas ‚Üí PROCESAR todo\n\n3. **Saludos siempre se procesan:** \"Hola\" NUNCA se ignora, sin excepciones\n\n4. **Interrogaciones siempre se procesan:** \"?\" significa pregunta ‚Üí PROCESAR\n\n5. **Reactivaciones siempre se procesan:** Cliente que vuelve ‚Üí PROCESAR\n\n6. **Contexto comercial siempre se procesa:** Cualquier menci√≥n de servicios/precios ‚Üí PROCESAR\n\n7. **Primer mensaje siempre se procesa:** Sin historial previo ‚Üí PROCESAR\n\n8. **En caso de ambig√ºedad:** PROCESAR (es mejor sobreprocesar que perder un lead)\n\n---\n\n## RECORDATORIO CR√çTICO\n\nüö® **El costo de ignorar un mensaje importante es 1000 veces mayor que procesar uno innecesario**\n\n- Ignorar lead = p√©rdida de cliente potencial\n- Procesar spam = solo un mensaje extra\n\n**Por lo tanto: Si dudas, PROCESA. Siempre.**\n\n---\n\nAnaliza el mensaje del cliente y responde √∫nicamente: **PROCESAR** o **IGNORAR**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        3840,
        1952
      ],
      "id": "7e478ebb-496b-4041-b57a-59b4693d0ada",
      "name": "filtro de conversacion"
    },
    {
      "parameters": {
        "jsCode": "// Obtener la respuesta del agente de filtro\nconst respuestaAgente = $input.all()[0].json.respuesta || $input.all()[0].json.output || '';\n\n// Normalizar la respuesta (limpiar espacios, saltos de l√≠nea y convertir a may√∫sculas)\nconst respuestaNormalizada = respuestaAgente\n  .toString()\n  .trim()\n  .toUpperCase()\n  .replace(/\\n/g, '')\n  .replace(/\\r/g, '');\n\n// Determinar la decisi√≥n final\nlet decision;\nlet razonFallback = null;\n\n// Verificar si la respuesta es v√°lida\nif (respuestaNormalizada.includes('IGNORAR')) {\n  decision = 'IGNORAR';\n} else if (respuestaNormalizada.includes('PROCESAR')) {\n  decision = 'PROCESAR';\n} else {\n  // Si no es ninguna de las respuestas esperadas, usar fallback\n  decision = 'PROCESAR';\n  razonFallback = 'Respuesta del agente no v√°lida o vac√≠a. Aplicando fallback de seguridad.';\n  \n  // Registrar para debugging\n  console.log('‚ö†Ô∏è FALLBACK ACTIVADO');\n  console.log('Respuesta original:', respuestaAgente);\n  console.log('Respuesta normalizada:', respuestaNormalizada);\n}\n\n// Preparar el output\nconst resultado = {\n  decision: decision,\n  respuesta_agente_original: respuestaAgente,\n  fallback_aplicado: razonFallback !== null,\n  razon_fallback: razonFallback,\n  timestamp: new Date().toISOString()\n};\n\n// Log para monitoreo\nif (decision === 'IGNORAR') {\n  console.log('üö´ Mensaje filtrado como IGNORAR');\n} else {\n  console.log('‚úÖ Mensaje procesado como PROCESAR');\n  if (razonFallback) {\n    console.log('‚ö†Ô∏è Raz√≥n:', razonFallback);\n  }\n}\n\n// Retornar el resultado\nreturn resultado;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4112,
        1952
      ],
      "id": "db547da1-ad76-45b6-b763-15c6b56fca42",
      "name": "parsear salida del agente respuesta predeterminada"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3920,
        2176
      ],
      "id": "662d32d9-e308-4367-b5e4-4b748b8d8c6a",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "your_openai_credential_id",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "29e410a8-9c27-49ee-b15f-4e37290f2b81",
              "leftValue": "={{ $('parsear salida del agente respuesta predeterminada').item.json.decision }}",
              "rightValue": "IGNORAR",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        4272,
        1952
      ],
      "id": "70b628e9-6665-411c-9476-de354dc1060e",
      "name": "ignorar mensaje"
    }
  ],
  "pinData": {},
  "connections": {
    "If": {
      "main": [
        [
          {
            "node": "HTTP Request4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "final_message_text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "final_message_voice": {
      "main": [
        [
          {
            "node": "buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "final_message_text": {
      "main": [
        [
          {
            "node": "buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "buffer": {
      "main": [
        [
          {
            "node": "get_buffer_data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get_buffer_data": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete_buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "get_buffer_data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete_buffer": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "final_message_voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request4": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "Get many rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Data message extraction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model8": {
      "ai_languageModel": [
        [
          {
            "node": "Clasifica clientes",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "nueva_venta_clientes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "indefinido_cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "soporte_cliente\t",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "queja_cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "obtener id de agentes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clasifica clientes": {
      "main": [
        [
          {
            "node": "parsear respuesta agente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enviar_variables_cliente": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "identificador": {
      "main": [
        [
          {
            "node": "variables persistentes cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "agente_identificador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "crear nuevo registro": {
      "main": [
        [
          {
            "node": "extraer registro nuevo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "identificar": {
      "main": [
        [
          {
            "node": "validar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validar": {
      "main": [
        [
          {
            "node": "crear nuevo registro",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agente_identificador": {
      "main": [
        [
          {
            "node": "identificar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "agente_identificador",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "agente_identificador",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "actualizar session_id memoria de chat": {
      "main": [
        [
          {
            "node": "etiqueta nuevo lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "agente_identificador",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extraer registro nuevo": {
      "main": [
        [
          {
            "node": "actualizar session_id memoria de chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "actualizar registro existente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "actualizar registro existente1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "actualizar registro existente2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "actualizar registro existente3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validar comprador": {
      "main": [
        [
          {
            "node": "queja_cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "negar queja",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validar comprador1": {
      "main": [
        [
          {
            "node": "soporte_cliente\t",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "negar soporte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "parsear respuesta agente": {
      "main": [
        [
          {
            "node": "enviar_variables_cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "actualizar session_id memoria de chat2": {
      "main": [
        [
          {
            "node": "etiqueta cliente identificado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "obtener_citas": {
      "main": [
        [
          {
            "node": "extraer_clasificacion_anterior",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "variables persistentes cliente": {
      "main": [
        [
          {
            "node": "extraer_etiqueta_anterior",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "asignar conversacion a agente humano": {
      "main": [
        []
      ]
    },
    "obtener id de agentes": {
      "main": [
        [
          {
            "node": "asignar conversacion a agente humano",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extraer_etiqueta_anterior": {
      "main": [
        [
          {
            "node": "Clasifica clientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Data message extraction": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get many rows": {
      "main": [
        [
          {
            "node": "obtener_citas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "actualizar registro existente": {
      "main": [
        [
          {
            "node": "extraer registro actualizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "actualizar registro existente1": {
      "main": [
        [
          {
            "node": "extraer registro actualizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "actualizar registro existente2": {
      "main": [
        [
          {
            "node": "extraer registro actualizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "actualizar registro existente3": {
      "main": [
        [
          {
            "node": "extraer registro actualizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extraer registro actualizado": {
      "main": [
        [
          {
            "node": "actualizar session_id memoria de chat2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extraer_clasificacion_anterior": {
      "main": [
        [
          {
            "node": "filtro de conversacion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "filtro de conversacion": {
      "main": [
        [
          {
            "node": "parsear salida del agente respuesta predeterminada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "filtro de conversacion",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "parsear salida del agente respuesta predeterminada": {
      "main": [
        [
          {
            "node": "ignorar mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ignorar mensaje": {
      "main": [
        [
          {
            "node": "identificador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Mexico_City",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "6454ea2d-af87-47fa-a052-6d07d5292cd0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "your_instance_id"
  },
  "id": "your_credential_id",
  "tags": []
}