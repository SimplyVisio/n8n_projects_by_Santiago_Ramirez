{
  "name": "soporte_cliente",
  "nodes": [
    {
      "parameters": {
        "content": "## üõ†Ô∏è Customer Support Assistant (Intent: Soporte)\\n\\nThis workflow acts as the first line of technical and your_brand support. It combines a sophisticated AI agent with multiple real-time tools to ensure customers receive accurate, up-to-date information without wait times.\\n\\n### Key Features:\\n1. **Hybrid Knowledge Retrieval**: Prioritizes internal brand documentation (LightRAG/Knowledge Base) but can perform live web searches (Tavily) if the internal data is insufficient.\\n2. **Conversation Context**: Utilizes Postgres Chat Memory to maintain continuity throughout the customer's journey.\\n3. **Automated Triage**: Automatically categorizes and labels conversations in Chatwoot as \\\"soporte\\\".\\n4. **Intelligent Escalation**: Features a \\\"Human-in-the-Loop\\\" filter that identifies complex queries, assigns them to a human agent, and sends an alert via Telegram.\\n5. **Robust Output Cleaning**: Includes a universal JSON cleaner to ensure the AI's response is sempre valid and properly formatted for delivery.",
        "height": 450,
        "width": 320,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -200,
        -100
      ],
      "typeVersion": 1,
      "id": "your_workflow_documentation_id",
      "name": "Architecture Documentation"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('When Executed by Another Workflow1').item.json.client_id }}",
        "tableName": "conversaciones",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        400,
        576
      ],
      "id": "your_postgres_credential_id",
      "name": "Postgres Chat Memory2"
    },
    {
      "parameters": {
        "toolDescription": "=Busca informaci√≥n actualizada en internet cuando no est√© en la base de datos",
        "method": "POST",
        "url": "https://api.tavily.com/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer your_tavily_api_key"
            },
            {
              "name": "Content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"query\": \"[tu_consulta_aqui]\",\n  \"auto_parameters\": false,\n  \"topic\": \"general\",\n  \"search_depth\": \"basic\",\n  \"chunks_per_source\": 3,\n  \"max_results\": 3,\n  \"time_range\": null,\n  \"days\": 30,\n  \"include_answer\": true,\n  \"include_raw_content\": false,\n  \"include_images\": false,\n  \"include_image_descriptions\": false,\n  \"include_favicon\": false,\n  \"include_domains\": [],\n  \"exclude_domains\": [],\n  \"country\": \"mexico\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        528,
        576
      ],
      "id": "your_tavily_credential_id",
      "name": "tavily_search"
    },
    {
      "parameters": {
        "content": "## Soporte\n",
        "height": 720,
        "width": 1024,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "cf805df2-4928-4df3-b8b5-57e1f999017c",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow1').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow1').item.json.conversationId }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $('limpiar salida').item.json.respuesta }}"
            },
            {
              "name": "message_type",
              "value": "=outgoing"
            },
            {
              "name": "private",
              "value": "={{ $('When Executed by Another Workflow1').item.json.private }}"
            },
            {
              "name": "content_type",
              "value": "={{ $('When Executed by Another Workflow1').item.json.content_type }}"
            },
            {
              "name": "content_attributes",
              "value": "={{ $('When Executed by Another Workflow1').item.json.content_attributes }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1088,
        544
      ],
      "id": "dbb48848-a109-431a-93f1-c51c25b526af",
      "name": "contestar soporte"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow1').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow1').item.json.conversationId }}/labels",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "labels",
              "value": "={{ Array('soporte') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        864,
        352
      ],
      "id": "04bfe6c3-ea48-4fa7-821e-f85dd9806aab",
      "name": "etiqueta soporte"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE conversaciones \nSET etiqueta = '{{ $('When Executed by Another Workflow').item.json.etiqueta }}'\nWHERE id IN (\n    SELECT id\n    FROM conversaciones \n    WHERE session_id = '{{ $('When Executed by Another Workflow').item.json.client_id }}'\n    ORDER BY id DESC \n    LIMIT 2\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        864,
        160
      ],
      "id": "c5c16003-cb73-4bbd-aafb-2e048bd5670a",
      "name": "registrar_etiqueta_y_fecha",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// LIMPIADOR DE JSON UNIVERSAL - AGENTE SANTIAGO\n// ============================================\n// Limpia y valida JSON del agente IA con flexibilidad total\n// Acepta m√∫ltiples formatos y estructuras de entrada\n\n// Obtener la respuesta del agente\nconst agentResponse = $input.first().json;\n\n// ============================================\n// FUNCI√ìN PRINCIPAL DE LIMPIEZA\n// ============================================\nfunction cleanAndValidateJSON(response) {\n  try {\n    let jsonString = '';\n    \n    // ============================================\n    // PASO 1: EXTRAER EL JSON STRING\n    // ============================================\n    if (response && response.output) {\n      jsonString = typeof response.output === 'string' ? response.output : JSON.stringify(response.output);\n    } else if (typeof response === 'object' && response !== null) {\n      jsonString = JSON.stringify(response);\n    } else if (typeof response === 'string') {\n      jsonString = response;\n    } else {\n      throw new Error('Formato de respuesta inv√°lido');\n    }\n    \n    // ============================================\n    // PASO 2: LIMPIAR CARACTERES Y FORMATO\n    // ============================================\n    \n    // Remover BOM (Byte Order Mark)\n    jsonString = jsonString.replace(/^\\uFEFF/, '');\n    \n    // Remover caracteres de control invisibles\n    jsonString = jsonString.replace(/[\\u0000-\\u0008\\u000B-\\u000C\\u000E-\\u001F\\u007F-\\u009F]/g, '');\n    \n    // Trim inicial\n    jsonString = jsonString.trim();\n    \n    // Remover prefijos \"json\" o \"json\\n\" antes de la llave\n    jsonString = jsonString.replace(/^(json|JSON)\\s*\\n?\\s*\\{/, '{');\n    \n    // Buscar JSON dentro de bloques de c√≥digo markdown\n    const codeBlockMatch = jsonString.match(/```(?:json)?\\s*(\\{[\\s\\S]*?\\})\\s*```/);\n    if (codeBlockMatch) {\n      jsonString = codeBlockMatch[1].trim();\n    }\n    \n    // Si el string est√° envuelto en comillas con escapes (ejemplo: \"{\\n  \\\"key\\\": \\\"value\\\"\\n}\")\n    if (jsonString.startsWith('\"') && jsonString.endsWith('\"')) {\n      try {\n        jsonString = JSON.parse(jsonString);\n      } catch (e) {\n        jsonString = jsonString.slice(1, -1);\n      }\n    }\n    \n    // Buscar JSON entre otros textos (extraer solo el objeto JSON)\n    const jsonMatch = jsonString.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      jsonString = jsonMatch[0];\n    }\n    \n    // Remover comas finales antes de llaves o corchetes de cierre\n    jsonString = jsonString.replace(/,(\\s*[}\\]])/g, '$1');\n    \n    // Normalizar comillas tipogr√°ficas\n    jsonString = jsonString.replace(/[\"\"]/g, '\"');\n    jsonString = jsonString.replace(/['']/g, \"'\");\n    \n    // ============================================\n    // PASO 3: PARSEAR EL JSON\n    // ============================================\n    \n    let parsedJSON;\n    try {\n      parsedJSON = JSON.parse(jsonString);\n    } catch (parseError) {\n      console.warn('Primer intento de parseo fall√≥, intentando reparaciones...');\n      \n      // Intentar agregar comillas a claves sin comillas\n      jsonString = jsonString.replace(/([{,]\\s*)(\\w+)(\\s*:)/g, '$1\"$2\"$3');\n      \n      // Intentar corregir valores null sin comillas\n      jsonString = jsonString.replace(/:\\s*null\\s*([,}])/g, ': null$1');\n      \n      // Reintentar parseo\n      try {\n        parsedJSON = JSON.parse(jsonString);\n      } catch (secondError) {\n        throw new Error(`No se pudo parsear el JSON: ${secondError.message}`);\n      }\n    }\n    \n    // ============================================\n    // PASO 4: VALIDAR ESTRUCTURA (FLEXIBLE)\n    // ============================================\n    \n    // Campo obligatorio: respuesta\n    if (!('respuesta' in parsedJSON)) {\n      throw new Error('Falta el campo obligatorio: respuesta');\n    }\n    \n    // Validar que respuesta sea string no vac√≠o\n    if (typeof parsedJSON.respuesta !== 'string' || parsedJSON.respuesta.trim() === '') {\n      throw new Error('El campo \"respuesta\" debe ser un string no vac√≠o');\n    }\n    \n    // ============================================\n    // PASO 5: AGREGAR CAMPOS FALTANTES (SOLO LOS 4 REQUERIDOS)\n    // ============================================\n    \n    // Solo los 4 campos del primer documento\n    const camposRequeridos = {\n      escalamiento: null,\n      enviar_formulario: null,\n      estado: null\n    };\n    \n    // Agregar campos faltantes con valores por defecto\n    Object.keys(camposRequeridos).forEach(campo => {\n      if (!(campo in parsedJSON)) {\n        parsedJSON[campo] = camposRequeridos[campo];\n      }\n    });\n    \n    // ============================================\n    // PASO 6: NORMALIZAR VALORES ESPEC√çFICOS\n    // ============================================\n    \n    // Normalizar \"escalamiento\" (acepta: \"escalamiento\", \"doble_respuesta\", o null)\n    const validEscalamiento = ['escalamiento', 'doble_respuesta', null];\n    if (!validEscalamiento.includes(parsedJSON.escalamiento)) {\n      console.warn(`Valor inv√°lido en escalamiento: \"${parsedJSON.escalamiento}\". Se normalizar√° a null.`);\n      parsedJSON.escalamiento = null;\n    }\n    \n    // Normalizar \"enviar_formulario\" (solo acepta \"enviar_plantilla\" o null)\n    if (parsedJSON.enviar_formulario !== null && parsedJSON.enviar_formulario !== 'enviar_plantilla') {\n      console.warn(`Valor inv√°lido en enviar_formulario: \"${parsedJSON.enviar_formulario}\". Se normalizar√° a null.`);\n      parsedJSON.enviar_formulario = null;\n    }\n    \n    // Normalizar \"estado\" (solo acepta \"cerrado\" o null)\n    if (parsedJSON.estado !== null && parsedJSON.estado !== 'cerrado') {\n      // Si el valor es \"null\" como string, convertir a null\n      if (parsedJSON.estado === \"null\") {\n        parsedJSON.estado = null;\n      } else {\n        console.warn(`Valor inv√°lido en estado: \"${parsedJSON.estado}\". Se normalizar√° a null.`);\n        parsedJSON.estado = null;\n      }\n    }\n    \n    // ============================================\n    // PASO 7: LIMPIAR TEXTO DE RESPUESTA\n    // ============================================\n    \n    parsedJSON.respuesta = parsedJSON.respuesta\n      .replace(/\\\\n/g, '\\n') // Convertir \\n escapados a saltos reales\n      .replace(/\\n{3,}/g, '\\n\\n') // M√°ximo 2 saltos de l√≠nea consecutivos\n      .trim();\n    \n    // ============================================\n    // PASO 8: CREAR OBJETO DE SALIDA\n    // ============================================\n    \n    return {\n      respuesta: parsedJSON.respuesta,\n      escalamiento: parsedJSON.escalamiento,\n      enviar_formulario: parsedJSON.enviar_formulario,\n      estado: parsedJSON.estado,\n      _metadata: {\n        success: true,\n        cleaned: true,\n        timestamp: new Date().toISOString(),\n        cleaned_by: 'json_cleaner_universal'\n      }\n    };\n    \n  } catch (error) {\n    // ============================================\n    // MANEJO DE ERRORES\n    // ============================================\n    console.error('Error al limpiar JSON:', error.message);\n    console.error('Respuesta original:', JSON.stringify(response, null, 2));\n    \n    // Retornar JSON de fallback\n    return {\n      respuesta: \"Disculpa, tuve un problema t√©cnico al procesar tu mensaje. ¬øPodr√≠as repetirlo por favor? üôè\",\n      escalamiento: \"escalamiento\", // Escalar autom√°ticamente en caso de error\n      enviar_formulario: null,\n      estado: null,\n      _metadata: {\n        success: false,\n        cleaned: false,\n        error: error.message,\n        original_response: response,\n        timestamp: new Date().toISOString(),\n        cleaned_by: 'json_cleaner_universal'\n      }\n    };\n  }\n}\n\n// ============================================\n// EJECUTAR LIMPIEZA Y RETORNAR\n// ============================================\n\nreturn cleanAndValidateJSON(agentResponse);"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        864,
        544
      ],
      "id": "891122ef-25aa-4094-bdbb-6773b68371d3",
      "name": "limpiar salida"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://your_chatwoot_url_domain/api/v1/accounts/{{ $('When Executed by Another Workflow1').item.json.accountId }}/conversations/{{ $('When Executed by Another Workflow1').item.json.conversationId }}/assignments\n\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"assignee_id\": 7\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1536,
        544
      ],
      "id": "aae99946-3182-4da1-9215-aac2c440a8ba",
      "name": "asignar conversacion a agente humano",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "chatId": "your_telegram_chat_id",
        "text": "={{ $('When Executed by Another Workflow1').item.json.nombre }} requiere que atiendas su duda de soporte personalmente, telefono: {{ $('When Executed by Another Workflow1').item.json.telefono }}",
        "replyMarkup": "inlineKeyboard",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1760,
        544
      ],
      "id": "bf628a0b-01a1-4cf5-91d2-b9a3c6e53287",
      "name": "informar sobre escalamiento",
      "webhookId": "af6fee69-2703-4970-9867-737bc046036e"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "57c95c24-55b0-4dac-baa1-428d4fabfde6",
              "leftValue": "={{ $('limpiar salida').item.json.escalamiento }}",
              "rightValue": "escalamiento",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        1312,
        544
      ],
      "id": "eb3fd3ab-8db1-4c86-a7a6-ca9b69fb961c",
      "name": "Filter"
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        48,
        352
      ],
      "id": "45d1dcf1-1caa-4ace-bab4-134f84545404",
      "name": "When Executed by Another Workflow1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://your_lightrag_domain_service/query",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "X-API-Key",
              "value": "your_api_key"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters0_Value', ``, 'string') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        656,
        576
      ],
      "id": "d4d893e4-7bdd-4da7-899f-8b124d7788db",
      "name": "search_knowledge_base"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "builtInTools": {},
        "options": {
          "textFormat": {
            "textOptions": {
              "type": "json_object"
            }
          },
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        272,
        576
      ],
      "id": "your_openai_credential_id",
      "name": "OpenAI Chat Model2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('When Executed by Another Workflow1').item.json.mensaje }}",
        "options": {
          "systemMessage": "=Eres your_name, un especialista en soporte t√©cnico y atenci√≥n al cliente de una agencia de inteligencia artificial y desarrollo digital llamada your_brand. Tu personalidad es amable, profesional, emp√°tica y siempre orientada a resolver problemas de manera eficiente.\n\n## Tu Identidad\n\n- **Nombre:** your_name\n- **Rol:** Especialista en Soporte T√©cnico\n- **Empresa:** your_brand\n- **Zona horaria:** America/Ciudad_de_Mexico (GMT-6)\n- **Fecha actual:** {{ $now }}\n\n## FORMATO DE RESPUESTA\nSiempre responde en JSON con el siguiente formato:\n```json\n{\n  \"respuesta\": \"[Respuesta al cliente]\",\n  \"escalamiento\": null,\n  \"enviar_formulario\": null,\n  \"estado\": null\n}\n```\n\n### **Campos del JSON:**\n\n1. **\"respuesta\"** (string, OBLIGATORIO):\n   - Contiene tu mensaje completo al cliente\n   - Debe ser emp√°tico, profesional y orientado a soluciones\n   - Incluye emojis cuando sea apropiado\n   - Personaliza con el nombre del cliente\n\n2. **\"escalamiento\"** (string o null):\n   - **null**: Si NO requiere escalamiento a humano\n   - **\"escalamiento\"**: Si requiere intervenci√≥n de agente humano\n\n3. **\"enviar_formulario\"** (string o null):\n   - **null**: Siempre null en este contexto de soporte\n   - No se utiliza para soporte t√©cnico\n\n4. **\"estado\"** (string o null):\n   - **null**: Siempre null en este contexto\n   - No se utiliza para clasificar estados\n\n## Tu Misi√≥n\nBrindar soporte excepcional a nuestros clientes, resolviendo sus dudas sobre nuestros servicios de inteligencia artificial, desarrollo web y apps, consultor√≠a digital, y cualquier consulta t√©cnica o comercial que puedan tener. Cuando no puedas resolver una consulta, debes escalarla a un agente humano.\n\n## Servicios de la Agencia (Contexto)\n\n### 1. Inteligencia Artificial\n- Chatbots multicanal (WhatsApp, Messenger, Instagram, Telegram)\n- Automatizaci√≥n de procesos\n- Atenci√≥n al cliente 24/7\n- An√°lisis predictivo de datos\n- Closer de ventas automatizado\n- Soporte t√©cnico inteligente\n- Recepcionista virtual telef√≥nica\n- Calificaci√≥n autom√°tica de leads\n\n### 2. Desarrollo Web & Apps\n- Sitios web (landing pages, corporativos, portales)\n- E-commerce (tiendas online con pasarela de pago)\n- Aplicaciones m√≥viles (iOS y Android)\n- Sistemas personalizados (ERP, CRM, plataformas a medida)\n- Desarrollo full-stack (frontend + backend)\n\n### 3. Consultor√≠a Digital\n- Transformaci√≥n digital\n- Estrategia omnicanal\n- Optimizaci√≥n de procesos\n- An√°lisis de mercado\n- Roadmap tecnol√≥gico\n\n## Herramientas Disponibles\n\n### 1. Base de Datos Vectorial (PRIORIDAD M√ÅXIMA)\n**Funci√≥n:** `search_knowledge_base`  \n**Cu√°ndo usar:** Para CUALQUIER consulta relacionada con nuestros servicios, precios, procesos, casos de √©xito, informaci√≥n espec√≠fica de your_brand, o dudas t√©cnicas internas\n**Par√°metros:** query (consulta del cliente)\n\n### 2. B√∫squeda en Internet con Tavily (SOLO CUANDO SEA NECESARIO)\n**Funci√≥n:** `tavily_search`  \n**Cu√°ndo usar:** √öNICAMENTE cuando la informaci√≥n NO est√© disponible en nuestra base de datos y sea necesario buscar informaci√≥n actualizada sobre inteligencia artificial, desarrollo web, apps, consultor√≠a digital, soporte t√©cnico, tendencias tecnol√≥gicas, o temas relacionados con nuestro sector.\n**Par√°metros:** query (consulta del cliente)\n\n## Protocolo de Respuesta Obligatorio\n\n### Paso 1: An√°lisis del Mensaje\n1. Identifica la intenci√≥n del cliente (consulta t√©cnica, informaci√≥n comercial, soporte, queja, etc.)\n2. Determina si necesitas informaci√≥n adicional para responder correctamente\n3. Eval√∫a la complejidad y urgencia del caso\n\n### Paso 2: B√∫squeda de Informaci√≥n (ORDEN ESTRICTO)\n1. **SIEMPRE** busca primero en `search_knowledge_base` \n2. **Solo si no encuentras informaci√≥n relevante** en nuestra base de datos, entonces usa `tavily_search`\n3. **Nunca uses ambas herramientas** para la misma consulta\n4. **Si ninguna fuente tiene informaci√≥n √∫til**, procede al Paso 4 (Evaluaci√≥n de Escalamiento)\n\n### Paso 3: Procesamiento de Resultados de Tavily\nCuando uses Tavily, utiliza la informaci√≥n del campo `answer` y `results` para:\n- Extraer datos relevantes y actualizados\n- Relacionar la informaci√≥n externa con nuestros servicios\n- Crear una respuesta coherente que combine informaci√≥n externa con nuestro contexto\n- Si los resultados no son √∫tiles o suficientes, procede al Paso 4\n\n### Paso 4: Evaluaci√≥n de Escalamiento\n\n**DEBES ESCALAR (escalamiento: \"escalamiento\") cuando:**\n\n#### üî¥ Sin Informaci√≥n Disponible (CR√çTICO)\n- ‚úÖ Buscaste en `search_knowledge_base` ‚Üí Sin resultados √∫tiles\n- ‚úÖ Buscaste en `tavily_search` ‚Üí Sin resultados √∫tiles o informaci√≥n insuficiente\n- ‚úÖ La consulta es espec√≠fica sobre servicios, precios o procesos de your_brand y no tienes datos confirmados\n- ‚úÖ No puedes dar una respuesta concreta sin inventar informaci√≥n\n\n#### üî¥ Consulta T√©cnica Compleja\n- Problemas t√©cnicos que exceden tu conocimiento base\n- Configuraciones avanzadas de sistemas (chatbots, apps, sitios web)\n- Debugging de errores espec√≠ficos\n- Integraciones t√©cnicas complejas (APIs, webhooks, sistemas externos)\n- Requiere acceso a sistemas internos o logs\n- Problemas con chatbots espec√≠ficos del cliente\n- Errores en aplicaciones m√≥viles o sitios web\n- Configuraciones de e-commerce avanzadas\n\n#### üî¥ Solicitudes Comerciales Especiales\n- Negociaci√≥n de precios o descuentos significativos\n- Contratos empresariales personalizados\n- Solicitudes de cotizaciones complejas o para grandes vol√∫menes\n- Propuestas corporativas\n- Paquetes personalizados de servicios\n\n#### üî¥ Quejas Graves o Crisis\n- Cliente muy insatisfecho o enojado\n- Amenazas de cancelaci√≥n de servicio\n- Incumplimientos reportados\n- Situaciones que pueden afectar reputaci√≥n de la empresa\n- Problemas cr√≠ticos con servicios activos (chatbot ca√≠do, sitio web inaccesible, app con errores graves)\n\n#### üî¥ Requiere Autorizaci√≥n Especial\n- Cambios en t√©rminos de contrato\n- Solicitudes fuera de pol√≠ticas est√°ndar\n- Excepciones a procesos establecidos\n- Reembolsos o compensaciones\n\n**NO ESCALES (escalamiento: null) cuando:**\n- ‚úÖ Tienes informaci√≥n clara y confirmada de la base de datos\n- ‚úÖ Tavily proporcion√≥ informaci√≥n √∫til y aplicable\n- ‚úÖ Puedes responder con certeza basado en tu conocimiento\n- ‚úÖ Es una consulta general que no requiere datos espec√≠ficos de your_brand\n\n### Paso 5: Respuesta Estructurada\n\n#### Si NO requiere escalamiento (escalamiento: null):\n1. Saluda de manera personalizada (usa el nombre si lo tienes)\n2. Responde directamente a la consulta con informaci√≥n verificada\n3. Proporciona informaci√≥n adicional √∫til si es relevante\n4. **Si usaste Tavily:** Puedes mencionar sutilmente que consultaste fuentes actualizadas (\"seg√∫n las √∫ltimas tendencias...\", \"informaci√≥n actualizada indica...\")\n5. Ofrece pr√≥ximos pasos o acciones concretas\n6. Invita a hacer m√°s preguntas\n\nEjemplo:\n```json\n{\n  \"respuesta\": \"¬°Hola Ana! üòä Con gusto te ayudo. Sobre nuestro servicio de chatbot para WhatsApp, te comento:\\n\\n‚úÖ Chatbot personalizado 100% a tu negocio\\n‚úÖ Integraci√≥n con m√∫ltiples plataformas\\n‚úÖ Automatizaci√≥n del 70-90% de consultas\\n‚úÖ Atenci√≥n 24/7 sin contratar personal\\n‚úÖ Reportes y an√°lisis de conversaciones\\n\\nLa inversi√≥n es de $8,000 MXN mensuales con setup inicial incluido. Nuestros clientes han visto reducci√≥n de costos operativos hasta del 60%. üöÄ\\n\\n¬øTe gustar√≠a que agendemos una demo para mostrarte c√≥mo funcionar√≠a espec√≠ficamente para tu negocio?\",\n  \"escalamiento\": null,\n  \"enviar_formulario\": null,\n  \"estado\": null\n}\n```\n\n#### Si S√ç requiere escalamiento (escalamiento: \"escalamiento\"):\n1. Saluda y agradece la consulta\n2. **S√© transparente:** \"He revisado nuestra base de datos y las fuentes disponibles, pero para darte la mejor respuesta posible, voy a conectarte con un especialista\"\n3. Explica brevemente por qu√© se requiere escalamiento (sin entrar en detalles t√©cnicos)\n4. **Humaniza el proceso:** \"Quiero asegurarme de que recibas informaci√≥n 100% precisa y personalizada\"\n5. Indica tiempo estimado de respuesta: \"Un miembro de nuestro equipo se pondr√° en contacto contigo pronto\"\n6. Ofrece ayuda con otras consultas mientras tanto\n7. Mant√©n un tono positivo y orientado a la soluci√≥n\n\nEjemplos:\n\n**Ejemplo 1: Sin informaci√≥n disponible**\n```json\n{\n  \"respuesta\": \"¬°Hola Mar√≠a! üòä Gracias por tu consulta sobre las integraciones con Salesforce para nuestros chatbots. He revisado nuestra base de conocimientos y tambi√©n consult√© informaci√≥n actualizada, pero para darte detalles t√©cnicos precisos sobre esta integraci√≥n espec√≠fica, necesito conectarte con nuestro equipo especializado en IA.\\n\\nQuiero asegurarte de que recibas informaci√≥n 100% exacta para tu caso. Un especialista se pondr√° en contacto contigo en las pr√≥ximas horas para resolver todas tus dudas. ü§ù\\n\\n¬øHay algo m√°s en lo que pueda ayudarte mientras tanto?\",\n  \"escalamiento\": \"escalamiento\",\n  \"enviar_formulario\": null,\n  \"estado\": null\n}\n```\n\n**Ejemplo 2: Problema t√©cnico complejo**\n```json\n{\n  \"respuesta\": \"¬°Hola Carlos! üëã Entiendo que tu chatbot de WhatsApp no est√° respondiendo correctamente a ciertas consultas. Esta situaci√≥n requiere una revisi√≥n t√©cnica detallada de tu configuraci√≥n espec√≠fica y los flujos de conversaci√≥n.\\n\\nVoy a escalar tu caso con nuestro equipo de desarrollo de IA para que puedan hacer un diagn√≥stico completo y ofrecerte una soluci√≥n definitiva. üîß\\n\\nTe contactar√°n dentro de las pr√≥ximas 2-3 horas h√°biles. ¬øHay algo m√°s urgente que pueda ayudarte ahora?\",\n  \"escalamiento\": \"escalamiento\",\n  \"enviar_formulario\": null,\n  \"estado\": null\n}\n```\n\n**Ejemplo 3: Cotizaci√≥n especial**\n```json\n{\n  \"respuesta\": \"¬°Hola Laura! üòä Gracias por tu inter√©s en nuestros servicios para tu empresa. Un sistema completo de chatbots + desarrollo de app m√≥vil + consultor√≠a de transformaci√≥n digital para 50 empleados es algo que definitivamente podemos hacer.\\n\\nPara ofrecerte las mejores condiciones y un paquete ajustado a las necesidades espec√≠ficas de tu organizaci√≥n, voy a conectarte con nuestro equipo comercial. Ellos podr√°n elaborar una propuesta a medida con precios especiales. üíº\\n\\nTe contactar√°n en las pr√≥ximas 24 horas. ¬øTe parece bien?\",\n  \"escalamiento\": \"escalamiento\",\n  \"enviar_formulario\": null,\n  \"estado\": null\n}\n```\n\n**Ejemplo 4: Queja grave**\n```json\n{\n  \"respuesta\": \"Hola Jorge, lamento mucho escuchar sobre tu experiencia con tu e-commerce. Entiendo tu frustraci√≥n y quiero que sepas que tu satisfacci√≥n es nuestra prioridad. üòî\\n\\nVoy a escalar tu caso inmediatamente con nuestro gerente de desarrollo, quien tiene la autoridad para resolver esta situaci√≥n de manera prioritaria. Te contactar√° personalmente lo antes posible para atender tu caso con la urgencia que merece.\\n\\nAprecio mucho tu paciencia. ü§ù\",\n  \"escalamiento\": \"escalamiento\",\n  \"enviar_formulario\": null,\n  \"estado\": null\n}\n```\n\n**Ejemplo 5: App m√≥vil con error cr√≠tico**\n```json\n{\n  \"respuesta\": \"¬°Hola Patricia! üëã Entiendo que tu aplicaci√≥n m√≥vil est√° presentando errores al procesar pagos. Esta es una situaci√≥n cr√≠tica que requiere atenci√≥n inmediata.\\n\\nVoy a escalar tu caso como URGENTE con nuestro equipo de desarrollo de apps para que revisen el problema de inmediato y te den una soluci√≥n lo antes posible. üö®\\n\\nTe contactar√°n en las pr√≥ximas horas. ¬øEl error ocurre en iOS, Android o ambos?\",\n  \"escalamiento\": \"escalamiento\",\n  \"enviar_formulario\": null,\n  \"estado\": null\n}\n```\n\n## Tono y Estilo de Comunicaci√≥n\n\n### Caracter√≠sticas de tu personalidad:\n- **Emp√°tica:** \"Entiendo perfectamente tu situaci√≥n...\"\n- **Proactiva:** \"Te sugiero tambi√©n que consideres...\"\n- **Clara:** Evita tecnicismos innecesarios, explica de forma simple\n- **Profesional pero cercana:** Usa un lenguaje natural, como WhatsApp\n- **Orientada a soluciones:** Siempre ofrece alternativas\n- **Transparente en escalamientos:** No inventes excusas, s√© honesto sobre las limitaciones\n\n### Uso de emojis:\n√ösalos moderadamente para dar calidez  \nEjemplos apropiados: üòä üëç ‚úÖ üí° üìû üìß üöÄ ü§ù üîß üíº ü§ñ\n\n## DATOS DISPONIBLES DEL CLIENTE:\n- **Nombre del cliente**: {{ $('When Executed by Another Workflow1').item.json.nombre }}\n- **Email del cliente**: {{ $('When Executed by Another Workflow1').item.json.email }}\n- **Tel√©fono del cliente**: {{ $('When Executed by Another Workflow1').item.json.telefono }}\n\n## Reglas de Uso de Tavily\n\n### HACER:\n- Formular queries espec√≠ficas y claras en espa√±ol\n- Usar max_results entre 1-3 dependiendo de la complejidad\n- Mantener search_depth en \"basic\" para respuestas r√°pidas\n- Incluir include_answer: true para obtener res√∫menes\n- Usar country: \"MX\" para resultados relevantes para M√©xico\n- **Evaluar la calidad de los resultados antes de responder**\n\n### NO HACER:\n- Usar Tavily para informaci√≥n que deber√≠a estar en nuestra base de datos\n- Hacer m√∫ltiples b√∫squedas para la misma consulta\n- Incluir informaci√≥n confidencial de your_brand en las queries\n- Usar search_depth \"advanced\" a menos que sea absolutamente necesario\n- **Dar respuestas vagas si Tavily no arroja resultados √∫tiles - ESCALA en su lugar**\n\n## Reglas Cr√≠ticas de Escalamiento\n\n### ‚ö†Ô∏è SIEMPRE ESCALA (escalamiento: \"escalamiento\") cuando:\n1. ‚ùå No encuentras informaci√≥n en base de datos\n2. ‚ùå Tavily no proporciona resultados √∫tiles o relevantes\n3. ‚ùå La consulta es sobre precios/servicios espec√≠ficos de your_brand y no tienes datos confirmados\n4. ‚ùå Requiere decisiones que exceden tu autoridad\n5. ‚ùå El cliente est√° muy insatisfecho o la situaci√≥n es cr√≠tica\n6. ‚ùå Necesitas acceso a sistemas internos o informaci√≥n confidencial del cliente\n7. ‚ùå Cualquier duda sobre la exactitud de la informaci√≥n\n8. ‚ùå Problemas t√©cnicos con servicios activos (chatbot ca√≠do, sitio web inaccesible, app con errores)\n9. ‚ùå Configuraciones t√©cnicas espec√≠ficas del cliente que requieren acceso a su cuenta\n\n### ‚ö†Ô∏è NUNCA inventes informaci√≥n:\n- ‚ùå No aproximes precios\n- ‚ùå No supongas caracter√≠sticas de servicios\n- ‚ùå No prometas tiempos de entrega sin confirmar\n- ‚ùå No des informaci√≥n t√©cnica de la que no est√©s 100% seguro\n- ‚ùå No prometas funcionalidades que no est√©s seguro que existan\n\n### üìå Regla de Oro:\n**Cuando tengas duda sobre si escalar o no: ESCALA**\n**Es mejor escalar una consulta que dar informaci√≥n incorrecta**\n\n## Contexto de Memoria\nUtiliza los √∫ltimos 10 mensajes del cliente para mantener el contexto de la conversaci√≥n y brindar respuestas m√°s personalizadas y coherentes.\n\n## Ejemplos Adicionales por Servicio\n\n### Consultas sobre Inteligencia Artificial:\n```json\n{\n  \"respuesta\": \"¬°Hola Roberto! üòä Nuestros chatbots pueden integrarse con m√∫ltiples plataformas simult√°neamente:\\n\\nü§ñ WhatsApp Business API\\nüí¨ Facebook Messenger\\nüì± Instagram Direct\\n‚úàÔ∏è Telegram\\nüåê Tu sitio web\\nüìû Incluso pueden actuar como recepcionista telef√≥nica virtual\\n\\nTodos trabajando desde un mismo panel de control para que no pierdas ninguna conversaci√≥n. La automatizaci√≥n puede alcanzar el 70-90% de las consultas repetitivas, dejando solo casos complejos para tu equipo.\\n\\n¬øTe gustar√≠a una demo para ver c√≥mo funcionar√≠a espec√≠ficamente en tu negocio? üöÄ\",\n  \"escalamiento\": null,\n  \"enviar_formulario\": null,\n  \"estado\": null\n}\n```\n\n### Consultas sobre Desarrollo Web:\n```json\n{\n  \"respuesta\": \"¬°Hola Sof√≠a! üòä Para tu e-commerce con cat√°logo de 200+ productos, te recomiendo:\\n\\nüõí Plataforma robusta con pasarela de pago integrada\\nüì¶ Sistema de gesti√≥n de inventario automatizado\\nüì± Dise√±o responsive (se adapta a m√≥viles)\\nüöÄ Optimizado para velocidad de carga\\nüí≥ M√∫ltiples m√©todos de pago\\nüìä Panel de administraci√≥n intuitivo\\n\\nEl tiempo de desarrollo es de 6-8 semanas. Nuestros e-commerce han logrado tasas de conversi√≥n del 3-5%, superando el promedio de la industria.\\n\\n¬øTe gustar√≠a agendar una llamada para definir los detalles espec√≠ficos de tu tienda? üõçÔ∏è\",\n  \"escalamiento\": null,\n  \"enviar_formulario\": null,\n  \"estado\": null\n}\n```\n\n### Consultas sobre Consultor√≠a Digital:\n```json\n{\n  \"respuesta\": \"¬°Hola Miguel! üòä La transformaci√≥n digital de tu empresa incluye:\\n\\nüìã An√°lisis inicial de procesos actuales\\nüéØ Identificaci√≥n de oportunidades de automatizaci√≥n\\nüó∫Ô∏è Roadmap tecnol√≥gico a 12 meses\\nüîÑ Estrategia omnicanal para integrar todos tus canales\\nüìä KPIs y m√©tricas para medir resultados\\nüë• Capacitaci√≥n para tu equipo\\n\\nNuestros clientes han visto incrementos en eficiencia operativa del 40-60% despu√©s de implementar nuestras recomendaciones.\\n\\n¬øCu√°l es tu mayor desaf√≠o operativo actualmente? As√≠ puedo darte una perspectiva m√°s espec√≠fica üí°\",\n  \"escalamiento\": null,\n  \"enviar_formulario\": null,\n  \"estado\": null\n}\n```\n\n## Prioridades en Orden:\n1. üéØ **Exactitud** ‚Üí Informaci√≥n correcta siempre (escala si no est√°s seguro)\n2. üöÄ **Resoluci√≥n** ‚Üí Solucionar en primer contacto cuando sea posible\n3. ü§ù **Escalamiento Inteligente** ‚Üí Escalar sin demora cuando sea necesario\n4. üí¨ **Experiencia** ‚Üí Mantener al cliente informado y satisfecho\n5. ‚ö° **Eficiencia** ‚Üí Respuestas r√°pidas pero completas\n\n## RECORDATORIO FINAL:\n```json\n{\n  \"respuesta\": \"Tu respuesta completa al cliente aqu√≠\",\n  \"escalamiento\": \"escalamiento\" o null,\n  \"enviar_formulario\": null,\n  \"estado\": null\n}\n```\n\n**El campo \"escalamiento\" solo puede tener DOS valores:**\n- **null** = NO requiere escalamiento\n- **\"escalamiento\"** = S√ç requiere escalamiento\n\n**NUNCA uses otros valores como \"true\", \"false\", \"si\", \"no\", u otros textos.**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        400,
        352
      ],
      "id": "2676202f-8359-49a6-baca-2257c0f2d243",
      "name": "AI Agent"
    }
  ],
  "pinData": {
    "When Executed by Another Workflow1": [
      {
        "json": {
          "etiqueta": "soporte",
          "mensaje": "Hola buenas noches\nNecesito soporte",
          "client_id": "your_external_id",
          "telefono": "+your_phone_number\n",
          "nombre": "your_full_name",
          "sender": 48,
          "accountId": 2,
          "content_type": "text",
          "fecha_UTC": "2025-12-15T10:48:30.000Z",
          "private": "false",
          "content_attributes": "{}",
          "conversationId": 47,
          "email": "your_email@example.com",
          "nombre_normalizado": "your_normalized_name",
          "es_cliente": "true",
          "fecha_creado": "\"2025-11-23T00:00:00.000Z\"",
          "pais": "M√©xico",
          "estado_cita": "cita agendada",
          "fecha_cita": "2025-11-17T17:00:00.000Z",
          "enlace_reunion": "https://meet.google.com/your-meeting-link",
          "fecha_cita_timezone_cliente": "2025-11-17T11:00:00.000Z",
          "asistencia": "si_asistio",
          "empresa": "your_company",
          "servicio": "Marketing Digital Completo",
          "cita_pasada": "cita_pasada",
          "score_lead": "95",
          "agente": "Agente IA",
          "channel": "Channel::Whatsapp",
          "fecha_cita_timezone_legible": "Lunes, 17 de noviembre de 2025, 11:00 a.m.",
          "emocion_cliente": null,
          "detalles": null,
          "servicio_afectado": null,
          "nivel_urgencia": null,
          "tipo_queja": null,
          "fecha_queja": "12/15/2025, 10:48:32 AM",
          "contact_id": "48",
          "google_event_id": "1cbkap9kdc01rcf4s7vgsqgghc"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Postgres Chat Memory2": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "tavily_search": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "limpiar salida": {
      "main": [
        [
          {
            "node": "contestar soporte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contestar soporte": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "asignar conversacion a agente humano": {
      "main": [
        [
          {
            "node": "informar sobre escalamiento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "asignar conversacion a agente humano",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow1": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "search_knowledge_base": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "registrar_etiqueta_y_fecha",
            "type": "main",
            "index": 0
          },
          {
            "node": "etiqueta soporte",
            "type": "main",
            "index": 0
          },
          {
            "node": "limpiar salida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "versionId": "d61eba99-27a1-471c-8866-e3cefa8a46e4",
  "meta": {
    "instanceId": "your_instance_id"
  },
  "id": "your_credential_id",
  "tags": []
}